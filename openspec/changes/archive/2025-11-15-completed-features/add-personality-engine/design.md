## Context

Apex Bridge v2.0需要实现人格化AI交互，这是MVP核心功能之一。当前系统已有Agent文件支持，但需要更结构化的人格配置系统和动态System Prompt构建能力。

## Goals / Non-Goals

### Goals
- 实现结构化人格配置系统（JSON格式）
- 向后兼容现有Agent/目录的.txt文件
- 支持多AI人格切换（通过agent_id）
- 动态构建System Prompt并注入到LLM对话
- 性能优化（缓存机制）

### Non-Goals
- MVP阶段不支持人格继承机制（后续根据需求添加）
- MVP阶段不支持自定义模板（使用固定模板，v2.1添加customPrompt）
- MVP阶段不支持YAML格式（后续添加）

## Decisions

### 决策1: 配置文件格式
**选择**: JSON + TXT兼容（分阶段）
**理由**: 向后兼容必需，JSON足够满足MVP需求
**备选方案**: 同时支持YAML（复杂度高，后续添加）

### 决策2: System Prompt构建策略
**选择**: 固定模板（MVP阶段）
**理由**: 快速实现，统一格式，易于维护
**后续演进**: v2.1添加customPrompt字段支持自定义补充

### 决策3: 人格缓存策略
**选择**: 内存缓存（Map）+ 启动清除 + 手动刷新API
**理由**: System Prompt构建很快（<5ms），缓存实现简单，可控性高
**备选方案**: 文件hash缓存（复杂度高，当前不需要）

### 决策4: TXT兼容性
**选择**: 直接使用txt内容作为System Prompt
**理由**: 完全向后兼容，实现简单
**后续**: 提供迁移工具帮助用户升级到JSON格式

### 决策5: 加载时机
**选择**: 启动预加载默认人格 + 按需加载其他人格
**理由**: 平衡性能和灵活性

### 决策6: Agent ID规则
**选择**: 文件名即ID，支持中英文
**理由**: 简单直观，现代系统支持中文文件名

### 决策7: System Prompt位置
**选择**: 人格system最前，用户system保留在后面
**理由**: 人格system优先级最高，用户system作为补充

### 决策8: 性能优化
**选择**: 同步构建（足够快，<5ms）
**理由**: 不需要异步，简单直接

## Risks / Trade-offs

### 风险1: TXT兼容可能不够结构化
**缓解**: 提供清晰的迁移路径和工具

### 风险2: 多个system message可能混淆LLM
**缓解**: LLM通常能处理多个system消息，通过顺序保证优先级

### 风险3: 性能影响
**缓解**: System Prompt构建很快（<5ms），缓存机制进一步优化

## Migration Plan

### 向后兼容策略
- 现有Agent/目录的.txt文件直接可用
- 不需要迁移即可使用（但推荐使用新JSON格式）

### 升级路径
1. 用户继续使用txt文件（完全兼容）
2. 用户手动迁移到JSON格式（获得结构化优势）
3. 后续提供自动迁移工具

## Open Questions

无（所有设计决策已确定）

