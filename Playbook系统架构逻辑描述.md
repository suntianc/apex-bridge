### 系统定位
Playbook系统是ApexBridge中基于ACE架构的L2全球战略层实现。其核心目标是将隐性知识转化为显性资产，并实现跨会话的经验传承和智能决策支持。系统通过智能匹配历史最佳实践（Playbook），并将其**动态注入LLM的思考过程**，从而系统化地提升任务执行的效率与成功率。

### 核心组件架构

#### 类型层
定义了完整的数据模型体系：
- **StrategicPlaybook** 作为核心模型，包含：
    - 基本信息（ID、名称、类型、描述）
    - 上下文（适用场景、前置条件）
    - 触发条件（关键词、意图模式）
    - 操作步骤（结构化动作序列）
    - 性能指标（成功率、使用频率、相关性评分）
- **动态归纳的类型体系**：系统不预设固定类型，而是从历史成功任务中自动聚类、分析共性，并归纳出通用的Playbook类型标签（如增长、危机处理等）。该体系**持续演进**，支持新类型的发现与旧类型的优化。
- 完整的版本控制机制，支持从 `active` 到 `archived`/`deprecated` 的生命周期状态转换。

#### 服务层
由5个核心服务组成：

1.  **PlaybookManager**
    - **职责**：系统的核心管理者，负责Playbook的完整生命周期管理（CRUD）。
    - **存储**：采用 **LanceDB作为向量存储** 和 **SQLite作为关系存储** 的双存储架构。
    - **核心能力**：
        - 批量聚类提取：从多个相似任务轨迹中自动提炼通用模式。
        - 动态指标更新：采用指数移动平均算法更新成功率。
        - 版本控制与追溯：支持父版本链接。
        - 缓存管理：内置TTL缓存（24小时有效期，最多1000个Playbook）。

2.  **PlaybookMatcher**
    - **职责**：智能匹配引擎，从用户查询中推荐最合适的Playbook。
    - **匹配算法**：
        - 采用多维度评分体系：
            - 文本相似度 (30%)
            - 成功率 (25%)
            - 使用频率 (15%)
            - 时效性 (15%)
            - 上下文匹配度 (15%)
        - 支持RRF融合排序，结合BM25全文检索和向量语义检索。
        - 对风险规避型Playbook给予更高的上下文匹配权重。
        - 支持智能序列推荐。

3.  **PlaybookExecutor**
    - **职责**：执行引擎，负责将选定的Playbook内容**动态注入到系统提示词**，指导LLM生成响应或直接转换为可执行计划。
    - **核心机制**：
        - **提示词动态注入**：匹配到Playbook后，系统会将其关键信息（目标、步骤、注意事项）作为结构化上下文，插入到发送给LLM的系统提示词或用户消息中。例如：
            > “根据以下最佳实践（Playbook）来指导本次对话：[[Playbook名称]]。目标：{playbook.goal}。关键步骤：1. {step1} 2. {step2}... 注意事项：{notes}”
        - **指导模式**：Playbook作为高级指导框架，**由LLM自主解读并灵活应用**来决定具体响应内容或工具调用，而非被系统机械执行。
		- **保障机制**：对话响应后可进行基础验证与反模式检测，记录结果用于Playbook指标更新。

4.  **PlaybookReflector**
    - **职责**：知识维护引擎，基于规则分析失败模式，实现经验反哺。
    - **能力**：分析失败模式（超时、限流等），提炼风险规避策略，生成预防型Playbook。
    - 
5.  **PlaybookTaskQueue** 与 **PlaybookReflectionScheduler**
    - **职责**：构成任务调度系统。
    - **调度架构**：四层调度——定时调度、任务队列、空闲调度（CPU负载<30%时）、API触发。
    - **任务类型**：Playbook的生成、反思、维护任务。

### 数据流逻辑

1.  **经验提炼流程**
    - 任务完成后，AceStrategyManager经过L1伦理审查。
    - 提取战略学习并存储到LanceDB作为长期记忆。
    - 成功案例自动触发Playbook提炼；失败案例提炼为风险规避型Playbook。

2.  **批量生成与类型归纳流程**
    - 从历史轨迹中聚类相似任务。
    - **使用LLM分析其共性特征与模式，归纳出新的Playbook类型或完善现有类型定义**。
    - 采用关键词重叠和Jaccard相似度算法进行聚类。

3.  **匹配与注入流程**（**关键流程**）
    - 接收用户查询。
    - **PlaybookMatcher** 通过混合检索（BM25+向量）获取候选Playbook。
    - 应用多维评分算法排序，对风险规避型Playbook应用特殊权重。
    - **PlaybookExecutor** 将选定的Playbook内容**动态注入到本次对话的系统提示词中**。
    - **LLM在注入的Playbook框架下进行思考、决策并生成响应**（或决定调用工具）。
	- 记录本次交互结果，用于更新Playbook的成功率、使用频率等指标。
### 关键特性

-   **长期记忆**：使用LanceDB存储战略学习和Playbook，支持跨会话上下文连续性。TTL缓存管理战略上下文（30天过期）。
-   **风险规避**：独特的失败衍生Playbook机制，标记为 `failure-derived` 和 `risk-avoidance`，在匹配和执行中享有特殊处理逻辑。
-   **动态提示词指导**：核心创新点。匹配到的Playbook不是静态参考，而是作为动态上下文注入LLM提示词，直接塑造LLM的推理路径和输出。
-   **动态类型体系**：Playbook类型并非固定不变，而是系统从历史成功实践中自动总结、归纳并持续演进的，确保了系统的适应性和扩展性。
-   **个人知识库管理**：温和淘汰策略（180天未用且使用<5次标记为archived），仅明确低效者（成功率<30%且使用>10次）标记为deprecated。
-   **智能优化**：基于多维度分析自动生成优化建议，支持重新激活机制。
-   **多维评分与融合排序**：支持RRF融合排序和风险感知处理。

### 存储架构（双存储）
采用明确的双存储模式，职责分离：
-   **LanceDB（向量存储）**：
    - 用于存储Playbook的向量化嵌入，支持高效的语义检索。
    - 存储战略学习等长期记忆。
-   **SQLite（关系存储）**：
    - 用于存储任务队列、系统配置、版本关系等结构化元数据。
    - 管理Playbook的生命周期状态。
-   **内存缓存**：
    - Playbook缓存：24小时。
    - 执行记录缓存：24小时。
    - 战略上下文缓存：30天。

### 集成关系
-  **与Skills系统**：通过资源映射集成，Playbook的 `resources` 字段对应Skills。
-  **与策略模式**：ChatService协调两种核心策略：ReAct和SingleRound。**Playbook系统深度集成到ReAct策略中**，在ReAct的“思考（Think）”阶段，系统会将匹配到的最相关Playbook内容动态注入提示词，为智能体（Agent）提供结构化的历史经验指导，从而优化其后续的“行动（Act）”决策。
-  **与会话管理**：维护上下文持续性，确保Playbook的指导作用跨越多个对话轮次。