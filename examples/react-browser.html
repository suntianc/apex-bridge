<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReAct Engine å‰ç«¯ç¤ºä¾‹</title>
  <style>
    body {
      font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      color: #1d1d1f;
      margin-bottom: 30px;
      font-weight: 600;
    }

    .control-panel {
      background: white;
      border-radius: 18px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #1d1d1f;
      font-weight: 500;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      box-sizing: border-box;
      background: #fafafa;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #007aff;
      background: white;
    }

    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    button:hover {
      background: #0051d5;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      background: #c3c3c3;
      cursor: not-allowed;
      transform: none;
    }

    .event-log {
      background: white;
      border-radius: 18px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      max-height: 600px;
      overflow-y: auto;
    }

    .event-item {
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .event-reasoning {
      background: #f0f0f0;
      border-left: 4px solid #8e8e93;
      color: #3c3c43;
    }

    .event-content {
      background: #e1f5fe;
      border-left: 4px solid #007aff;
      color: #1d1d1f;
      font-weight: 500;
    }

    .event-tool-start {
      background: #fff3e0;
      border-left: 4px solid #ff9500;
      color: #1d1d1f;
    }

    .event-tool-end {
      background: #f3e5f5;
      border-left: 4px solid #af52de;
      color: #1d1d1f;
    }

    .event-error {
      background: #ffebee;
      border-left: 4px solid #ff3b30;
      color: #c00;
    }

    .event-done {
      background: #e8f5e9;
      border-left: 4px solid #34c759;
      color: #1d1d1f;
      font-weight: 500;
    }

    .event-time {
      font-size: 11px;
      color: #8e8e93;
      margin-top: 6px;
      font-weight: 500;
    }

    .status-bar {
      margin-top: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 10px;
      font-size: 13px;
      color: #3c3c43;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– ReAct Engine å®æ—¶æ¼”ç¤º</h1>

    <div class="control-panel">
      <div class="input-group">
        <label>API Key</label>
        <input type="password" id="apiKey" placeholder="è¾“å…¥ GLM API Key">
      </div>

      <div class="input-group">
        <label>ç¤ºä¾‹åœºæ™¯</label>
        <select id="scenario">
          <option value="weather">å¤©æ°”æŸ¥è¯¢ï¼ˆéœ€è¦ web_search å·¥å…·ï¼‰</option>
          <option value="date">æ—¥æœŸæŸ¥è¯¢ï¼ˆéœ€è¦ date å·¥å…·ï¼‰</option>
          <option value="multi">å¤šè½®å¯¹è¯ï¼ˆåŒæ—¶ä½¿ç”¨å¤šä¸ªå·¥å…·ï¼‰</option>
          <option value="custom">è‡ªå®šä¹‰é—®é¢˜</option>
        </select>
      </div>

      <div class="input-group" id="customQuestionGroup" style="display: none;">
        <label>è‡ªå®šä¹‰é—®é¢˜</label>
        <input type="text" id="customQuestion" placeholder="è¾“å…¥ä½ çš„é—®é¢˜...">
      </div>

      <button id="startBtn" onclick="startConversation()">å¼€å§‹å¯¹è¯</button>
    </div>

    <div class="event-log" id="eventLog">
      <div style="color: #8e8e93; text-align: center; padding: 40px;">
        ç‚¹å‡»"å¼€å§‹å¯¹è¯"æŒ‰é’®å¼€å§‹æ¼”ç¤º
      </div>
    </div>

    <div class="status-bar" id="statusBar">
      å‡†å¤‡å°±ç»ª
    </div>
  </div>

  <script type="module">
    // æ³¨æ„ï¼šæµè§ˆå™¨ç¯å¢ƒéœ€è¦ WebSocket æˆ– SSE åç«¯æ¥å£
    // è¿™é‡Œä½¿ç”¨ mock æ•°æ®æ¼”ç¤ºå‰ç«¯äº‹ä»¶æ¸²æŸ“é€»è¾‘

    import { ReActEngine } from '../src/core/react/ReActEngine.js';
    import { tools } from '../src/core/react/tools/index.js';

    // åœºæ™¯é…ç½®
    const scenarios = {
      weather: {
        question: 'ä»Šå¤©åŒ—äº¬å¤©æ°”å¦‚ä½•ï¼Ÿ',
        description: 'å¤©æ°”æŸ¥è¯¢ï¼ˆä½¿ç”¨ web_search å·¥å…·ï¼‰'
      },
      date: {
        question: 'ç°åœ¨å‡ ç‚¹äº†ï¼Ÿä»Šå¤©æ—¥æœŸæ˜¯ï¼Ÿ',
        description: 'æ—¥æœŸæŸ¥è¯¢ï¼ˆä½¿ç”¨ date å·¥å…·ï¼‰'
      },
      multi: {
        question: 'ä»Šå¤©åŒ—äº¬å¤©æ°”å¦‚ä½•ï¼Ÿé¡ºä¾¿å‘Šè¯‰æˆ‘ç°åœ¨å‡ ç‚¹äº†ã€‚',
        description: 'å¤šè½®å¯¹è¯ï¼ˆåŒæ—¶ä½¿ç”¨å¤šä¸ªå·¥å…·ï¼‰'
      },
      custom: {
        question: '',
        description: 'è‡ªå®šä¹‰é—®é¢˜'
      }
    };

    // DOM å…ƒç´ 
    const apiKeyInput = document.getElementById('apiKey');
    const scenarioSelect = document.getElementById('scenario');
    const customQuestionGroup = document.getElementById('customQuestionGroup');
    const customQuestionInput = document.getElementById('customQuestion');
    const eventLog = document.getElementById('eventLog');
    const statusBar = document.getElementById('statusBar');
    const startBtn = document.getElementById('startBtn');

    // ç›‘å¬åœºæ™¯é€‰æ‹©å˜åŒ–
    scenarioSelect.addEventListener('change', () => {
      if (scenarioSelect.value === 'custom') {
        customQuestionGroup.style.display = 'block';
      } else {
        customQuestionGroup.style.display = 'none';
      }
    });

    // å¼€å§‹å¯¹è¯
    window.startConversation = async function() {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        alert('è¯·è¾“å…¥ API Key');
        return;
      }

      const scenario = scenarioSelect.value;
      const question = scenario === 'custom'
        ? customQuestionInput.value.trim()
        : scenarios[scenario].question;

      if (!question) {
        alert('è¯·è¾“å…¥é—®é¢˜');
        return;
      }

      // ç¦ç”¨æŒ‰é’®
      startBtn.disabled = true;
      startBtn.textContent = 'å¤„ç†ä¸­...';

      // æ¸…ç©ºæ—¥å¿—
      eventLog.innerHTML = '';

      // æ›´æ–°çŠ¶æ€æ 
      statusBar.textContent = `æ‰§è¡Œåœºæ™¯: ${scenarios[scenario].description}`;

      try {
        // åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯ API
        // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨ mock æ•°æ®æ¼”ç¤º
        await simulateConversation(question);

        statusBar.textContent = 'å®Œæˆ';
      } catch (error) {
        console.error('Error:', error);
        addEvent('error', { message: error.message });
        statusBar.textContent = 'æ‰§è¡Œå¤±è´¥';
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'å¼€å§‹å¯¹è¯';
      }
    };

    // æ¨¡æ‹Ÿå¯¹è¯ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯ APIï¼‰
    async function simulateConversation(question) {
      // æ¨¡æ‹Ÿæ€è€ƒè¿‡ç¨‹
      const mockReasoning = [
        'Hmm, the user is asking about the weather in Beijing today...',
        'I need to search for current weather information.',
        'Let\'s use the web_search tool to find this information.'
      ];

      // æ¨¡æ‹Ÿ tool_calls
      const mockToolCalls = [{
        id: 'call_123',
        function: {
          name: 'web_search',
          arguments: '{"query": "åŒ—äº¬å¤©æ°” today"}'
        }
      }];

      // æ¨¡æ‹Ÿæœç´¢ç»“æœ
      const mockSearchResult = {
        query: 'åŒ—äº¬å¤©æ°” today',
        results: [
          { title: 'åŒ—äº¬ä»Šå¤©å¤©æ°”', content: 'ä»Šå¤©åŒ—äº¬æ™´ï¼Œæ°”æ¸© 15-25Â°Cï¼Œé€‚åˆå¤–å‡º' }
        ]
      };

      // æ¨¡æ‹Ÿå›ç­”
      const mockAnswer = [
        'æ ¹æ®æœç´¢ç»“æœæ˜¾ç¤ºï¼Œ',
        'ä»Šå¤©åŒ—äº¬å¤©æ°”æ™´æœ—ï¼Œ',
        'æ°”æ¸©åœ¨ 15-25Â°C ä¹‹é—´ï¼Œ',
        'éå¸¸é€‚åˆå¤–å‡ºæ´»åŠ¨ï¼'
      ];

      // æ¨¡æ‹Ÿäº‹ä»¶æµ
      // 1. æ€è€ƒè¿‡ç¨‹
      for (const thought of mockReasoning) {
        addEvent('reasoning', { content: thought });
        await sleep(500);
      }

      // 2. å·¥å…·è°ƒç”¨
      addEvent('tool_start', {
        toolName: mockToolCalls[0].function.name,
        args: mockToolCalls[0].function.arguments
      });
      await sleep(1000);

      addEvent('tool_end', {
        toolName: mockToolCalls[0].function.name,
        result: mockSearchResult
      });
      await sleep(500);

      // 3. å›ç­”å†…å®¹
      for (const part of mockAnswer) {
        addEvent('content', { content: part });
        await sleep(300);
      }

      // 4. å®Œæˆ
      addEvent('done', null);
    }

    // æ·»åŠ äº‹ä»¶åˆ°æ—¥å¿—
    function addEvent(type, data) {
      const eventItem = document.createElement('div');
      eventItem.className = `event-item event-${type}`;

      const timestamp = new Date().toLocaleTimeString();

      switch (type) {
        case 'reasoning':
          eventItem.innerHTML = `<strong>ğŸ¤” æ€è€ƒ:</strong> ${escapeHtml(data.content)}<div class="event-time">${timestamp}</div>`;
          break;

        case 'content':
          eventItem.innerHTML = `<strong>ğŸ“ å›ç­”:</strong> ${escapeHtml(data.content)}<div class="event-time">${timestamp}</div>`;
          break;

        case 'tool_start':
          eventItem.innerHTML = `<strong>ğŸ”§ å·¥å…·è°ƒç”¨:</strong> ${escapeHtml(data.toolName)}<br><small>å‚æ•°: ${escapeHtml(data.args)}</small><div class="event-time">${timestamp}</div>`;
          break;

        case 'tool_end':
          eventItem.innerHTML = `<strong>âœ… å·¥å…·ç»“æœ:</strong> ${escapeHtml(JSON.stringify(data.result))}<div class="event-time">${timestamp}</div>`;
          break;

        case 'error':
          eventItem.innerHTML = `<strong>âŒ é”™è¯¯:</strong> ${escapeHtml(data.message)}<div class="event-time">${timestamp}</div>`;
          break;

        case 'done':
          eventItem.innerHTML = `<strong>ğŸ å®Œæˆ:</strong> å¯¹è¯ç»“æŸ<div class="event-time">${timestamp}</div>`;
          break;
      }

      eventLog.appendChild(eventItem);
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å»¶è¿Ÿå‡½æ•°
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
