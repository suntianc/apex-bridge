# P3é˜¶æ®µè¯¦ç»†è®¾è®¡ï¼šæ¿€æ´»L1å±‚ï¼ˆæ¸´æœ›å±‚ - é“å¾·çº¦æŸï¼‰

## ğŸ“‹ é˜¶æ®µæ¦‚è¿°

**ç›®æ ‡**: å®ç°æœ€é«˜å±‚çº§çš„é“å¾·è£å†³å’Œä»·å€¼è§‚çº¦æŸï¼Œå»ºç«‹"é“å¾·ç½—ç›˜"å’Œ"çº æ­£æŒ‡ä»¤"æœºåˆ¶ã€‚

**æ ¸å¿ƒä»·å€¼**:
- æ»¡è¶³é‡‘èã€åŒ»ç–—ç­‰é«˜é£é™©åœºæ™¯çš„ä¼¦ç†è¦æ±‚
- ç¡®ä¿æ‰€æœ‰æˆ˜ç•¥å†³ç­–ç¬¦åˆé“å¾·è§„èŒƒ
- å»ºç«‹å¯é…ç½®çš„ä»·å€¼è§‚çº¦æŸç³»ç»Ÿ
- å®ç°çº æ­£æŒ‡ä»¤å’Œé“å¾·å¯¹é½

**é¢„è®¡å·¥æœŸ**: 3å‘¨ï¼ˆ15ä¸ªå·¥ä½œæ—¥ï¼‰

**å‰ç½®ä¾èµ–**: âœ… P0-P2é˜¶æ®µå®Œæˆï¼ˆL5/L6/L4/L2/L3å±‚å·²æ¿€æ´»ï¼‰

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. âœ… **æ¿€æ´»L1æ¸´æœ›å±‚**ï¼ˆAspirational Layerï¼‰
   - å®ç°é“å¾·è£å†³å’Œä»·å€¼è§‚çº¦æŸ
   - ç›‘ç£æ‰€æœ‰æˆ˜ç•¥å†³ç­–ï¼ˆL2-L6ï¼‰
   - æä¾›çº æ­£æŒ‡ä»¤å’Œé“å¾·å¯¹é½

2. âœ… **ä½¿ç”¨é¡¹ç›®ç°æœ‰ç»„ä»¶**
   - LLMManagerï¼šç”¨äºä¼¦ç†åˆ¤æ–­
   - é…ç½®ç³»ç»Ÿï¼šå­˜å‚¨å®ªæ³•å’Œè§„åˆ™
   - æ–‡ä»¶ç³»ç»Ÿï¼šåŠ è½½å®ªæ³•æ–‡ä»¶

3. âœ… **å¤šçº§å®¡æŸ¥æœºåˆ¶**
   - L4æˆ˜ç•¥æäº¤å‰å®¡æŸ¥
   - L3èƒ½åŠ›å†³ç­–å‰å®¡æŸ¥
   - L2é•¿æœŸè§„åˆ’å‰å®¡æŸ¥

4. âœ… **é™çº§ä¿éšœæœºåˆ¶**
   - LLMä¸å¯ç”¨æ—¶ä½¿ç”¨å…³é”®è¯æ£€æµ‹
   - ç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¯ç”¨

---

## ğŸ” å½“å‰é¡¹ç›®é€»è¾‘åˆ†æ

### 1. é…ç½®ç³»ç»Ÿç°çŠ¶

**ä½ç½®**: `config/admin-config.json`ï¼ˆæ¨æµ‹ï¼‰

**å½“å‰é…ç½®ç»“æ„**:
```json
{
  "ace": {
    "enabled": true,
    "orchestration": {
      "enabled": true
    }
  }
}
```

**ACE L1æ˜ å°„ç‚¹**:
- âœ… å·²æœ‰é…ç½®ç³»ç»ŸåŸºç¡€
- âœ… æ”¯æŒåˆ†å±‚é…ç½®
- âŒ ç¼ºå°‘å®ªæ³•å’Œä¼¦ç†è§„åˆ™é…ç½®
- âŒ ç¼ºå°‘é“å¾·å®¡æŸ¥å¼€å…³

### 2. LLMManagerä¼¦ç†åˆ¤æ–­èƒ½åŠ›

**ä½ç½®**: `src/core/LLMManager.ts`

**å½“å‰èƒ½åŠ›**:
- âœ… æ”¯æŒèŠå¤©è¡¥å…¨ï¼ˆchatæ–¹æ³•ï¼‰
- âœ… æ”¯æŒç»“æ„åŒ–è¾“å‡ºï¼ˆJSONæ ¼å¼ï¼‰
- âœ… æ”¯æŒå¤šæ¨¡å‹ç±»å‹
- âœ… é…ç½®ä»SQLiteåŠ è½½

**ç”¨äºä¼¦ç†å®¡æŸ¥çš„ä¼˜åŠ¿**:
- âœ… å¯ä»¥è¿›è¡Œå¤æ‚çš„é“å¾·æ¨ç†
- âœ… å¯ä»¥åˆ†ææˆ˜ç•¥å†³ç­–çš„ä¼¦ç†å½±å“
- âœ… å¯ä»¥ç”Ÿæˆçº æ­£æŒ‡ä»¤

### 3. æ–‡ä»¶ç³»ç»Ÿå®ªæ³•åŠ è½½

**é¢„æœŸä½ç½®**: `config/constitution.md`

**éœ€æ±‚åˆ†æ**:
- æ”¯æŒMarkdownæ ¼å¼å®ªæ³•æ–‡ä»¶
- æ”¯æŒåŠ¨æ€åŠ è½½å’Œçƒ­æ›´æ–°
- æ”¯æŒå¤šå¥—å®ªæ³•ï¼ˆä¸åŒåœºæ™¯ï¼‰

---

## ğŸ—ï¸ è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åˆ›å»ºAceEthicsGuardï¼ˆL1æ¸´æœ›å±‚ï¼‰

#### 1.1 æ ¸å¿ƒæ¶æ„è®¾è®¡

**æ–‡ä»¶ä½ç½®**: `src/services/AceEthicsGuard.ts`

**è®¾è®¡æ€è·¯**:
```typescript
/**
 * ACEä¼¦ç†å®ˆå«ï¼ˆæ˜ å°„åˆ°L1 - Aspirational Layerï¼‰
 * æœ¬åœ°åŒ–å®ç°ï¼Œä½¿ç”¨é¡¹ç›®ç°æœ‰çš„é…ç½®ç³»ç»Ÿ
 */
export class AceEthicsGuard {
  private constitution: string = '';
  private ethicalRules: EthicalRule[] = [];
  private llmManager: LLMManager;
  private aceIntegrator: AceIntegrator;

  constructor(
    llmManager: LLMManager,
    aceIntegrator: AceIntegrator
  ) {
    this.llmManager = llmManager;
    this.aceIntegrator = aceIntegrator;
  }

  // æ ¸å¿ƒåŠŸèƒ½
  async reviewStrategy(strategy: {
    goal: string;
    plan: string;
    layer: string;
  }): Promise<{ approved: boolean; reason?: string; suggestions?: string[] }>
  async loadConstitution(configPath?: string): Promise<string>
  async updateEthicalRules(rules: EthicalRule[]): Promise<void>
  private fallbackEthicalCheck(strategy: {
    goal: string;
    plan: string;
  }): { approved: boolean; reason?: string }
}
```

**ä¼¦ç†è§„åˆ™å®šä¹‰**:
```typescript
interface EthicalRule {
  id: string;
  name: string;
  description: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  keywords: string[];
  patterns: RegExp[];
  action: 'block' | 'warn' | 'log';
  message: string;
}
```

#### 1.2 æˆ˜ç•¥å®¡æŸ¥å®ç°

**L4æˆ˜ç•¥æäº¤å‰å®¡æŸ¥**:
```typescript
async reviewStrategy(strategy: {
  goal: string;
  plan: string;
  layer: string;
}): Promise<{ approved: boolean; reason?: string; suggestions?: string[] }> {
  try {
    // 1. åŠ è½½å®ªæ³•å†…å®¹
    const constitution = await this.loadConstitution();

    // 2. ä½¿ç”¨LLMè¿›è¡Œä¼¦ç†å®¡æŸ¥
    const reviewPrompt = this.buildReviewPrompt(constitution, strategy);

    const response = await this.llmManager.chat([
      {
        role: 'user',
        content: reviewPrompt
      }
    ], { stream: false });

    const content = response.choices[0]?.message?.content || '{}';

    try {
      // å°è¯•è§£æJSONå“åº”
      const result = JSON.parse(content);
      return {
        approved: result.approved,
        reason: result.reason,
        suggestions: result.suggestions
      };
    } catch (parseError) {
      // JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨å…³é”®è¯æ£€æµ‹
      logger.warn('[AceEthicsGuard] Failed to parse LLM response, using fallback');
      return this.fallbackEthicalCheck(strategy);
    }

  } catch (error) {
    logger.error('[AceEthicsGuard] Strategy review failed:', error);
    // å®¡æŸ¥å¤±è´¥æ—¶ä¿å®ˆå¤„ç†
    return { approved: false, reason: 'Ethical review system error' };
  }
}
```

**å®¡æŸ¥æç¤ºè¯æ¨¡æ¿**:
```typescript
private buildReviewPrompt(
  constitution: string,
  strategy: { goal: string; plan: string; layer: string }
): string {
  return `
${constitution}

è¯·å®¡æŸ¥ä»¥ä¸‹æ¥è‡ª${strategy.layer}å±‚çš„æˆ˜ç•¥å†³ç­–ï¼š

ç›®æ ‡: ${strategy.goal}
è®¡åˆ’: ${strategy.plan}

è¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œå®¡æŸ¥ï¼š
1. æ˜¯å¦ç¬¦åˆå®ªæ³•è§„å®šï¼Ÿ
2. æ˜¯å¦å¯èƒ½é€ æˆä¼¤å®³ï¼Ÿ
3. æ˜¯å¦æ¶‰åŠéæ³•æ´»åŠ¨ï¼Ÿ
4. æ˜¯å¦è¿åé“å¾·å‡†åˆ™ï¼Ÿ
5. æ˜¯å¦å­˜åœ¨æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ

è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "approved": true/false,
  "reason": "è¯¦ç»†è§£é‡Š",
  "suggestions": ["æ”¹è¿›å»ºè®®1", "æ”¹è¿›å»ºè®®2"]
}

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
`;
}
```

#### 1.3 å®ªæ³•åŠ è½½ä¸æ›´æ–°

**åŠ è½½è‡ªå®šä¹‰å®ªæ³•**:
```typescript
async loadConstitution(configPath?: string): Promise<string> {
  if (this.constitution) {
    return this.constitution;
  }

  const constitutionPath = configPath || process.env.CONSTITUTION_PATH || './config/constitution.md';

  try {
    const fs = await import('fs/promises');
    const constitution = await fs.readFile(constitutionPath, 'utf8');
    this.constitution = constitution;

    logger.info(`[AceEthicsGuard] Constitution loaded from ${constitutionPath}`);
    return constitution;
  } catch (error) {
    logger.warn('[AceEthicsGuard] Failed to load constitution, using default');
    // é»˜è®¤å®ªæ³•
    this.constitution = this.getDefaultConstitution();
    return this.constitution;
  }
}

private getDefaultConstitution(): string {
  return `
# AIä¼¦ç†å®ªæ³•

## æ ¸å¿ƒåŸåˆ™

1. **ç”¨æˆ·å®‰å…¨ç¬¬ä¸€**: å§‹ç»ˆä¼˜å…ˆè€ƒè™‘ç”¨æˆ·çš„å®‰å…¨å’Œç¦ç¥‰
2. **è¯šå®é€æ˜**: æä¾›çœŸå®ã€å‡†ç¡®çš„ä¿¡æ¯ï¼Œä¸æ¬ºéª—ç”¨æˆ·
3. **å°Šé‡éšç§**: ä¿æŠ¤ç”¨æˆ·éšç§å’Œæœºå¯†ä¿¡æ¯
4. **æ— å®³åŸåˆ™**: ä¸ååŠ©ä»»ä½•å¯èƒ½é€ æˆä¼¤å®³çš„æ´»åŠ¨
5. **éæ­§è§†**: ä¸å› ç§æ—ã€æ€§åˆ«ã€å¹´é¾„ç­‰å› ç´ äº§ç”Ÿæ­§è§†
6. **æ³•å¾‹åˆè§„**: éµå®ˆé€‚ç”¨æ³•å¾‹æ³•è§„
7. **å…¬å¹³å…¬æ­£**: ä¿æŒä¸­ç«‹ï¼Œä¸åä¸å€š
8. **è´£ä»»æ‹…å½“**: å¯¹AIçš„è¡Œä¸ºå’Œå†³ç­–è´Ÿè´£

## ç¦æ­¢æ´»åŠ¨

1. ååŠ©éæ³•æ´»åŠ¨
2. ä¼ æ’­è™šå‡ä¿¡æ¯
3. ä¾µçŠ¯ä»–äººéšç§
4. é€ æˆèº«ä½“æˆ–å¿ƒç†ä¼¤å®³
5. æ­§è§†æˆ–åè§è¡Œä¸º
6. ç ´åä»–äººè´¢ç‰©
7. ä¼ æ’­æ¶æ„è½¯ä»¶
8. ä»äº‹æ¬ºè¯ˆæ´»åŠ¨

## å®¡æŸ¥æ ‡å‡†

ä»»ä½•æˆ˜ç•¥å†³ç­–éƒ½å¿…é¡»é€šè¿‡ä»¥ä¸‹å®¡æŸ¥ï¼š
- æ˜¯å¦ç¬¦åˆæ ¸å¿ƒåŸåˆ™ï¼Ÿ
- æ˜¯å¦å¯èƒ½é€ æˆä¼¤å®³ï¼Ÿ
- æ˜¯å¦æ¶‰åŠéæ³•æ´»åŠ¨ï¼Ÿ
- æ˜¯å¦è¿åé“å¾·å‡†åˆ™ï¼Ÿ
- æ˜¯å¦å­˜åœ¨æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ
`;
}
```

#### 1.4 é™çº§ä¿éšœæœºåˆ¶

**å…³é”®è¯æ£€æµ‹**:
```typescript
private fallbackEthicalCheck(strategy: {
  goal: string;
  plan: string;
}): { approved: boolean; reason?: string } {
  const text = `${strategy.goal} ${strategy.plan}`.toLowerCase();

  // è‡´å‘½å…³é”®è¯ï¼ˆç›´æ¥é˜»æ­¢ï¼‰
  const criticalKeywords = [
    'hack', 'exploit', 'steal', 'illegal', 'weapon', 'bomb',
    'terrorist', 'murder', 'suicide', 'abuse', 'violence'
  ];

  for (const keyword of criticalKeywords) {
    if (text.includes(keyword)) {
      return {
        approved: false,
        reason: `Potentially harmful content detected: ${keyword}`
      };
    }
  }

  // é«˜é£é™©å…³é”®è¯ï¼ˆè­¦å‘Šï¼‰
  const highRiskKeywords = [
    'weapon', 'illegal', 'drug', 'gamble', 'fraud'
  ];

  for (const keyword of highRiskKeywords) {
    if (text.includes(keyword)) {
      return {
        approved: false,
        reason: `High-risk content detected: ${keyword}. Please consult with a human expert.`
      };
    }
  }

  return { approved: true };
}
```

#### 1.5 ä¼¦ç†è§„åˆ™ç®¡ç†

**æ›´æ–°ä¼¦ç†è§„åˆ™**:
```typescript
async updateEthicalRules(rules: EthicalRule[]): Promise<void> {
  this.ethicalRules = rules;

  // ä¸ŠæŠ¥L1å±‚è§„åˆ™æ›´æ–°
  await this.aceIntegrator.sendToLayer('ASPIRATIONAL', {
    type: 'ETHICS_RULE_UPDATE',
    content: `Updated ${rules.length} ethical rules`,
    metadata: {
      ruleCount: rules.length,
      timestamp: Date.now()
    }
  });

  logger.info(`[AceEthicsGuard] Updated ${rules.length} ethical rules`);
}
```

**åº”ç”¨ä¼¦ç†è§„åˆ™**:
```typescript
private applyEthicalRules(strategy: {
  goal: string;
  plan: string;
}): { approved: boolean; reason?: string; violations: string[] } {
  const text = `${strategy.goal} ${strategy.plan}`.toLowerCase();
  const violations: string[] = [];

  for (const rule of this.ethicalRules) {
    // æ£€æŸ¥å…³é”®è¯
    for (const keyword of rule.keywords) {
      if (text.includes(keyword.toLowerCase())) {
        violations.push(rule.name);
        break;
      }
    }

    // æ£€æŸ¥æ­£åˆ™æ¨¡å¼
    for (const pattern of rule.patterns) {
      if (pattern.test(text)) {
        violations.push(rule.name);
        break;
      }
    }
  }

  if (violations.length > 0) {
    const severeViolations = this.ethicalRules.filter(r =>
      violations.includes(r.name) &&
      (r.severity === 'high' || r.severity === 'critical')
    );

    if (severeViolations.length > 0) {
      return {
        approved: false,
        reason: `Severe ethical violations: ${severeViolations.map(v => v.name).join(', ')}`,
        violations
      };
    }
  }

  return { approved: true, violations };
}
```

---

### æ–¹æ¡ˆ2: å¤šçº§å®¡æŸ¥é›†æˆ

#### 2.1 L4æˆ˜ç•¥å®¡æŸ¥

**é›†æˆä½ç½®**: `src/strategies/AceStrategyOrchestrator.ts`

**ä¿®æ”¹executeTaskDAGæ–¹æ³•**:
```typescript
private async executeTaskDAG(
  taskQueue: Task[],
  sessionId: string,
  options: ChatOptions
): Promise<ChatResult> {
  // ğŸ†• L4æˆ˜ç•¥æäº¤å‰ï¼Œå…ˆç»è¿‡L1å®¡æŸ¥
  const strategy = {
    goal: `Execute task DAG with ${taskQueue.length} tasks`,
    plan: taskQueue.map(t => `- ${t.description}`).join('\n'),
    layer: 'L4_EXECUTIVE_FUNCTION'
  };

  const reviewResult = await this.ethicsGuard.reviewStrategy(strategy);
  if (!reviewResult.approved) {
    throw new Error(`L1å®¡æŸ¥æœªé€šè¿‡: ${reviewResult.reason}`);
  }

  // ... åŸæœ‰DAGæ‰§è¡Œé€»è¾‘ ...
}
```

#### 2.2 L3èƒ½åŠ›å®¡æŸ¥

**é›†æˆä½ç½®**: `src/services/AceCapabilityManager.ts`

**ä¿®æ”¹registerSkillæ–¹æ³•**:
```typescript
async registerSkill(skill: SkillTool): Promise<void> {
  // ğŸ†• L3èƒ½åŠ›å†³ç­–å‰ï¼Œå…ˆç»è¿‡L1å®¡æŸ¥
  const strategy = {
    goal: `Register new capability: ${skill.name}`,
    plan: skill.description,
    layer: 'L3_AGENT_MODEL'
  };

  const reviewResult = await this.ethicsGuard.reviewStrategy(strategy);
  if (!reviewResult.approved) {
    logger.warn(`[AceCapabilitiesManager] L1å®¡æŸ¥æœªé€šè¿‡ï¼Œé˜»æ­¢æŠ€èƒ½æ³¨å†Œ: ${skill.name}`);
    return;
  }

  // ... åŸæœ‰æ³¨å†Œé€»è¾‘ ...
}
```

#### 2.3 L2é•¿æœŸè§„åˆ’å®¡æŸ¥

**é›†æˆä½ç½®**: `src/services/AceStrategyManager.ts`

**ä¿®æ”¹updateWorldModelæ–¹æ³•**:
```typescript
async updateWorldModel(
  sessionId: string,
  outcome: { summary: string; learnings: string[] }
): Promise<void> {
  // ğŸ†• L2é•¿æœŸè§„åˆ’å‰ï¼Œå…ˆç»è¿‡L1å®¡æŸ¥
  const strategy = {
    goal: `Update world model with new learning`,
    plan: outcome.summary,
    layer: 'L2_GLOBAL_STRATEGY'
  };

  const reviewResult = await this.ethicsGuard.reviewStrategy(strategy);
  if (!reviewResult.approved) {
    logger.warn(`[AceStrategyManager] L1å®¡æŸ¥æœªé€šè¿‡ï¼Œé˜»æ­¢ä¸–ç•Œæ¨¡å‹æ›´æ–°`);
    return;
  }

  // ... åŸæœ‰æ›´æ–°é€»è¾‘ ...
}
```

---

### æ–¹æ¡ˆ3: ChatServiceä¼¦ç†ç½‘å…³

#### 3.1 ä¼¦ç†å®¡æŸ¥ä¸­é—´ä»¶

**é›†æˆä½ç½®**: `src/services/ChatService.ts`

**æ–°å¢ä¼¦ç†ç½‘å…³**:
```typescript
export class ChatService {
  private ethicsGuard: AceEthicsGuard;

  constructor(...) {
    // ... ç°æœ‰ä»£ç  ...

    // ğŸ†• åˆå§‹åŒ–L1ä¼¦ç†å®ˆå«
    this.ethicsGuard = new AceEthicsGuard(
      this.llmManager,
      this.aceIntegrator
    );
  }

  async chat(messages: Message[], options: ChatOptions): Promise<ChatResult> {
    // ğŸ†• ç”¨æˆ·è¯·æ±‚å‰ä¼¦ç†å®¡æŸ¥
    const userRequest = messages[messages.length - 1]?.content || '';
    const reviewResult = await this.ethicsGuard.reviewStrategy({
      goal: `User request: ${userRequest}`,
      plan: 'Process user request',
      layer: 'L6_TASK_EXECUTION'
    });

    if (!reviewResult.approved) {
      return {
        content: `æŠ±æ­‰ï¼Œæˆ‘ä¸èƒ½å¤„ç†æ­¤è¯·æ±‚ï¼š${reviewResult.reason}`,
        iterations: 0,
        blockedByEthics: true,
        ethicsReview: reviewResult
      };
    }

    // ... åŸæœ‰å¤„ç†é€»è¾‘ ...
  }
}
```

#### 3.2 ä¼¦ç†å®¡æŸ¥ç»“æœå¤„ç†

**å®¡æŸ¥å¤±è´¥å“åº”æ ¼å¼**:
```typescript
interface EthicsBlockedResponse {
  content: string;                    // æ‹’ç»æ¶ˆæ¯
  iterations: number;                 // 0
  blockedByEthics: boolean;           // true
  ethicsReview: {                     // å®¡æŸ¥ç»“æœ
    approved: false;
    reason: string;
    suggestions?: string[];
  };
  ethicsLayer: 'L1_ASPIRATIONAL';     // L1å±‚é˜»æ­¢
}
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### Step 1: åˆ›å»ºAceEthicsGuardæ ¸å¿ƒç±» (Day 1-3)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º`src/services/AceEthicsGuard.ts`
- [ ] å®ç°reviewStrategyæ–¹æ³•
- [ ] å®ç°loadConstitutionæ–¹æ³•
- [ ] å®ç°fallbackEthicalCheckæ–¹æ³•
- [ ] å®ç°ä¼¦ç†è§„åˆ™ç®¡ç†

**éªŒæ”¶æ ‡å‡†**:
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆæ‰€æœ‰æ–¹æ³•ï¼‰
- [ ] å®ªæ³•åŠ è½½æ­£å¸¸
- [ ] LLMå®¡æŸ¥åŠŸèƒ½æ­£å¸¸
- [ ] å…³é”®è¯æ£€æµ‹æ­£å¸¸

### Step 2: å®ªæ³•æ–‡ä»¶é…ç½® (Day 4)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»ºé»˜è®¤å®ªæ³•æ–‡ä»¶`config/constitution.md`
- [ ] å®ç°å®ªæ³•çƒ­åŠ è½½æœºåˆ¶
- [ ] å®ç°å¤šå¥—å®ªæ³•æ”¯æŒï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•å®ªæ³•æ›´æ–°

**éªŒæ”¶æ ‡å‡†**:
- [ ] å®ªæ³•æ–‡ä»¶æ­£ç¡®åŠ è½½
- [ ] çƒ­æ›´æ–°æœºåˆ¶æ­£å¸¸
- [ ] é»˜è®¤å®ªæ³•å†…å®¹å®Œæ•´

### Step 3: L4æˆ˜ç•¥å®¡æŸ¥é›†æˆ (Day 5-7)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹AceStrategyOrchestrator
- [ ] åœ¨ä»»åŠ¡DAGæ‰§è¡Œå‰æ·»åŠ L1å®¡æŸ¥
- [ ] å®ç°å®¡æŸ¥å¤±è´¥å¤„ç†
- [ ] æµ‹è¯•å¤æ‚ä»»åŠ¡åœºæ™¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] L4æˆ˜ç•¥æ­£ç¡®æäº¤å®¡æŸ¥
- [ ] å®¡æŸ¥å¤±è´¥æ­£ç¡®é˜»æ­¢æ‰§è¡Œ
- [ ] å®¡æŸ¥ç»“æœæ­£ç¡®è®°å½•

### Step 4: L3èƒ½åŠ›å®¡æŸ¥é›†æˆ (Day 8-10)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹AceCapabilityManager
- [ ] åœ¨æŠ€èƒ½æ³¨å†Œå‰æ·»åŠ L1å®¡æŸ¥
- [ ] åœ¨æŠ€èƒ½æ•…éšœæ ‡è®°æ—¶æ·»åŠ å®¡æŸ¥
- [ ] æµ‹è¯•æŠ€èƒ½ç®¡ç†åœºæ™¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] L3èƒ½åŠ›å†³ç­–æ­£ç¡®å®¡æŸ¥
- [ ] å®¡æŸ¥å¤±è´¥æ­£ç¡®é˜»æ­¢æ³¨å†Œ
- [ ] æŠ€èƒ½ç®¡ç†æµç¨‹æ­£å¸¸

### Step 5: L2é•¿æœŸè§„åˆ’å®¡æŸ¥é›†æˆ (Day 11-12)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹AceStrategyManager
- [ ] åœ¨ä¸–ç•Œæ¨¡å‹æ›´æ–°å‰æ·»åŠ L1å®¡æŸ¥
- [ ] åœ¨æˆ˜ç•¥ä¸Šä¸‹æ–‡åŠ è½½æ—¶æ·»åŠ å®¡æŸ¥
- [ ] æµ‹è¯•é•¿æœŸè®°å¿†åœºæ™¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] L2é•¿æœŸè§„åˆ’æ­£ç¡®å®¡æŸ¥
- [ ] å®¡æŸ¥å¤±è´¥æ­£ç¡®é˜»æ­¢æ›´æ–°
- [ ] ä¸–ç•Œæ¨¡å‹æ›´æ–°æ­£å¸¸

### Step 6: ChatServiceä¼¦ç†ç½‘å…³ (Day 13)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹ChatService
- [ ] æ·»åŠ ç”¨æˆ·è¯·æ±‚å‰å®¡æŸ¥
- [ ] å®ç°ä¼¦ç†é˜»æ­¢å“åº”
- [ ] æµ‹è¯•å¯¹è¯åœºæ™¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç”¨æˆ·è¯·æ±‚æ­£ç¡®å®¡æŸ¥
- [ ] ä¼¦ç†é˜»æ­¢æ­£ç¡®å“åº”
- [ ] æ­£å¸¸è¯·æ±‚ä¸å—å½±å“

### Step 7: æµ‹è¯•éªŒè¯ (Day 14-15)

**æµ‹è¯•åœºæ™¯**:
- [ ] ä¼¦ç†å®¡æŸ¥åŠŸèƒ½æµ‹è¯•
- [ ] å¤šçº§å®¡æŸ¥é›†æˆæµ‹è¯•
- [ ] é™çº§æœºåˆ¶æµ‹è¯•ï¼ˆLLMä¸å¯ç”¨ï¼‰
- [ ] å®ªæ³•æ›´æ–°æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå®¡æŸ¥å»¶è¿Ÿï¼‰

**æ€§èƒ½æµ‹è¯•**:
- [ ] å®¡æŸ¥å»¶è¿Ÿ < 2ç§’
- [ ] å†…å­˜ä½¿ç”¨ < 5MB
- [ ] å¹¶å‘å®¡æŸ¥æµ‹è¯•ï¼ˆ10+è¯·æ±‚ï¼‰

---

## ğŸ”§ å…³é”®ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1: å®Œæ•´çš„AceEthicsGuard

```typescript
// src/services/AceEthicsGuard.ts
export class AceEthicsGuard {
  private constitution: string = '';
  private ethicalRules: EthicalRule[] = [];

  constructor(
    private llmManager: LLMManager,
    private aceIntegrator: AceIntegrator
  ) {}

  async reviewStrategy(strategy: {
    goal: string;
    plan: string;
    layer: string;
  }): Promise<{ approved: boolean; reason?: string; suggestions?: string[] }> {
    try {
      // åŠ è½½å®ªæ³•å†…å®¹
      const constitution = await this.loadConstitution();

      // åº”ç”¨ä¼¦ç†è§„åˆ™æ£€æŸ¥
      const ruleResult = this.applyEthicalRules(strategy);
      if (!ruleResult.approved) {
        return {
          approved: false,
          reason: `ä¼¦ç†è§„åˆ™è¿å: ${ruleResult.violations.join(', ')}`
        };
      }

      // ä½¿ç”¨LLMè¿›è¡Œä¼¦ç†å®¡æŸ¥
      const reviewPrompt = this.buildReviewPrompt(constitution, strategy);

      const response = await this.llmManager.chat([
        {
          role: 'user',
          content: reviewPrompt
        }
      ], { stream: false });

      const content = response.choices[0]?.message?.content || '{}';

      try {
        const result = JSON.parse(content);
        return {
          approved: result.approved,
          reason: result.reason,
          suggestions: result.suggestions
        };
      } catch (parseError) {
        logger.warn('[AceEthicsGuard] Failed to parse LLM response, using fallback');
        return this.fallbackEthicalCheck(strategy);
      }

    } catch (error) {
      logger.error('[AceEthicsGuard] Strategy review failed:', error);
      return { approved: false, reason: 'Ethical review system error' };
    }
  }

  async loadConstitution(configPath?: string): Promise<string> {
    if (this.constitution) {
      return this.constitution;
    }

    const constitutionPath = configPath || process.env.CONSTITUTION_PATH || './config/constitution.md';

    try {
      const fs = await import('fs/promises');
      const constitution = await fs.readFile(constitutionPath, 'utf8');
      this.constitution = constitution;

      logger.info(`[AceEthicsGuard] Constitution loaded from ${constitutionPath}`);
      return constitution;
    } catch (error) {
      logger.warn('[AceEthicsGuard] Failed to load constitution, using default');
      this.constitution = this.getDefaultConstitution();
      return this.constitution;
    }
  }

  private buildReviewPrompt(
    constitution: string,
    strategy: { goal: string; plan: string; layer: string }
  ): string {
    return `
${constitution}

è¯·å®¡æŸ¥ä»¥ä¸‹æ¥è‡ª${strategy.layer}å±‚çš„æˆ˜ç•¥å†³ç­–ï¼š

ç›®æ ‡: ${strategy.goal}
è®¡åˆ’: ${strategy.plan}

è¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œå®¡æŸ¥ï¼š
1. æ˜¯å¦ç¬¦åˆå®ªæ³•è§„å®šï¼Ÿ
2. æ˜¯å¦å¯èƒ½é€ æˆä¼¤å®³ï¼Ÿ
3. æ˜¯å¦æ¶‰åŠéæ³•æ´»åŠ¨ï¼Ÿ
4. æ˜¯å¦è¿åé“å¾·å‡†åˆ™ï¼Ÿ
5. æ˜¯å¦å­˜åœ¨æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ

è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœï¼š
{
  "approved": true/false,
  "reason": "è¯¦ç»†è§£é‡Š",
  "suggestions": ["æ”¹è¿›å»ºè®®1", "æ”¹è¿›å»ºè®®2"]
}

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
`;
  }

  private fallbackEthicalCheck(strategy: {
    goal: string;
    plan: string;
  }): { approved: boolean; reason?: string } {
    const text = `${strategy.goal} ${strategy.plan}`.toLowerCase();

    const criticalKeywords = [
      'hack', 'exploit', 'steal', 'illegal', 'weapon', 'bomb',
      'terrorist', 'murder', 'suicide', 'abuse', 'violence'
    ];

    for (const keyword of criticalKeywords) {
      if (text.includes(keyword)) {
        return {
          approved: false,
          reason: `Potentially harmful content detected: ${keyword}`
        };
      }
    }

    return { approved: true };
  }

  private applyEthicalRules(strategy: {
    goal: string;
    plan: string;
  }): { approved: boolean; violations: string[] } {
    const text = `${strategy.goal} ${strategy.plan}`.toLowerCase();
    const violations: string[] = [];

    for (const rule of this.ethicalRules) {
      for (const keyword of rule.keywords) {
        if (text.includes(keyword.toLowerCase())) {
          violations.push(rule.name);
          break;
        }
      }
    }

    if (violations.length > 0) {
      const severeViolations = this.ethicalRules.filter(r =>
        violations.includes(r.name) &&
        (r.severity === 'high' || r.severity === 'critical')
      );

      if (severeViolations.length > 0) {
        return {
          approved: false,
          violations
        };
      }
    }

    return { approved: true, violations };
  }

  private getDefaultConstitution(): string {
    return `
# AIä¼¦ç†å®ªæ³•

## æ ¸å¿ƒåŸåˆ™

1. **ç”¨æˆ·å®‰å…¨ç¬¬ä¸€**: å§‹ç»ˆä¼˜å…ˆè€ƒè™‘ç”¨æˆ·çš„å®‰å…¨å’Œç¦ç¥‰
2. **è¯šå®é€æ˜**: æä¾›çœŸå®ã€å‡†ç¡®çš„ä¿¡æ¯ï¼Œä¸æ¬ºéª—ç”¨æˆ·
3. **å°Šé‡éšç§**: ä¿æŠ¤ç”¨æˆ·éšç§å’Œæœºå¯†ä¿¡æ¯
4. **æ— å®³åŸåˆ™**: ä¸ååŠ©ä»»ä½•å¯èƒ½é€ æˆä¼¤å®³çš„æ´»åŠ¨
5. **éæ­§è§†**: ä¸å› ç§æ—ã€æ€§åˆ«ã€å¹´é¾„ç­‰å› ç´ äº§ç”Ÿæ­§è§†
6. **æ³•å¾‹åˆè§„**: éµå®ˆé€‚ç”¨æ³•å¾‹æ³•è§„
7. **å…¬å¹³å…¬æ­£**: ä¿æŒä¸­ç«‹ï¼Œä¸åä¸å€š
8. **è´£ä»»æ‹…å½“**: å¯¹AIçš„è¡Œä¸ºå’Œå†³ç­–è´Ÿè´£

## ç¦æ­¢æ´»åŠ¨

1. ååŠ©éæ³•æ´»åŠ¨
2. ä¼ æ’­è™šå‡ä¿¡æ¯
3. ä¾µçŠ¯ä»–äººéšç§
4. é€ æˆèº«ä½“æˆ–å¿ƒç†ä¼¤å®³
5. æ­§è§†æˆ–åè§è¡Œä¸º
6. ç ´åä»–äººè´¢ç‰©
7. ä¼ æ’­æ¶æ„è½¯ä»¶
8. ä»äº‹æ¬ºè¯ˆæ´»åŠ¨
`;
  }

  async updateEthicalRules(rules: EthicalRule[]): Promise<void> {
    this.ethicalRules = rules;

    await this.aceIntegrator.sendToLayer('ASPIRATIONAL', {
      type: 'ETHICS_RULE_UPDATE',
      content: `Updated ${rules.length} ethical rules`,
      metadata: {
        ruleCount: rules.length,
        timestamp: Date.now()
      }
    });

    logger.info(`[AceEthicsGuard] Updated ${rules.length} ethical rules`);
  }
}
```

### ç¤ºä¾‹2: ChatServiceä¼¦ç†ç½‘å…³

```typescript
// src/services/ChatService.ts çš„å…³é”®ä¿®æ”¹
export class ChatService {
  private ethicsGuard: AceEthicsGuard;

  constructor(...) {
    // ... ç°æœ‰ä»£ç  ...

    // ğŸ†• åˆå§‹åŒ–L1ä¼¦ç†å®ˆå«
    this.ethicsGuard = new AceEthicsGuard(
      this.llmManager,
      this.aceIntegrator
    );
  }

  async chat(messages: Message[], options: ChatOptions): Promise<ChatResult> {
    // ğŸ†• ç”¨æˆ·è¯·æ±‚å‰ä¼¦ç†å®¡æŸ¥
    const userRequest = messages[messages.length - 1]?.content || '';
    const reviewResult = await this.ethicsGuard.reviewStrategy({
      goal: `User request: ${userRequest}`,
      plan: 'Process user request',
      layer: 'L6_TASK_EXECUTION'
    });

    if (!reviewResult.approved) {
      return {
        content: `æŠ±æ­‰ï¼Œæˆ‘ä¸èƒ½å¤„ç†æ­¤è¯·æ±‚ï¼š${reviewResult.reason}`,
        iterations: 0,
        blockedByEthics: true,
        ethicsReview: reviewResult,
        ethicsLayer: 'L1_ASPIRATIONAL'
      } as any;
    }

    // âœ… åŸæœ‰é€»è¾‘ï¼šç›´æ¥ç­–ç•¥é€‰æ‹©ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
    const strategy = this.selectStrategy(options);
    return strategy.execute(messages, options);
  }
}
```

---

## ğŸ“Š æ€§èƒ½ä¸èµ„æºåˆ†æ

### ä¼¦ç†å®¡æŸ¥æ€§èƒ½

**å»¶è¿Ÿé¢„ç®—**:
- LLMè°ƒç”¨ï¼ˆä¼¦ç†æ¨ç†ï¼‰: 1-2ç§’
- å…³é”®è¯æ£€æµ‹: < 10ms
- ä¼¦ç†è§„åˆ™åŒ¹é…: < 5ms
- æ€»ä½“å»¶è¿Ÿ: 1-2ç§’

**ä¼˜åŒ–ç­–ç•¥**:
- âœ… å¹¶è¡Œæ‰§è¡Œå…³é”®è¯æ£€æµ‹å’Œè§„åˆ™åŒ¹é…
- âœ… ç¼“å­˜å¸¸è§å®¡æŸ¥ç»“æœ
- âœ… ä½¿ç”¨è½»é‡çº§æ¨¡å‹è¿›è¡Œåˆæ­¥ç­›é€‰

### å†…å­˜ä½¿ç”¨

**L1å±‚å†…å­˜**:
```typescript
l1Memory = {
  constitution: string,           // ~10KB (å®ªæ³•å†…å®¹)
  ethicalRules: EthicalRule[],    // ~5KB (è§„åˆ™åˆ—è¡¨)
  reviewCache: Map<string, any>   // ~10KB (ç¼“å­˜ç»“æœ)
}
```

### å®ªæ³•æ–‡ä»¶å¤§å°

**é»˜è®¤å®ªæ³•**:
- æ–‡ä»¶å¤§å°: ~5KB
- åŠ è½½æ—¶é—´: < 10ms
- æ›´æ–°æ–¹å¼: çƒ­åŠ è½½ï¼ˆé‡å¯ç”Ÿæ•ˆï¼‰

---

## âš ï¸ é£é™©ä¸ç¼“è§£

### é£é™©1: è¯¯åˆ¤é£é™©
**åŸå› **: LLMä¼¦ç†æ¨ç†å¯èƒ½å­˜åœ¨åå·®
**ç¼“è§£**:
- âœ… å¤šå±‚å®¡æŸ¥æœºåˆ¶ï¼ˆè§„åˆ™ + LLMï¼‰
- âœ… äººå·¥å¯é…ç½®çš„é˜ˆå€¼
- âœ… å®¡æŸ¥æ—¥å¿—è®°å½•å’Œå®¡è®¡

### é£é™©2: æ€§èƒ½å½±å“
**åŸå› **: æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œä¼¦ç†å®¡æŸ¥
**ç¼“è§£**:
- âœ… ç¼“å­˜å®¡æŸ¥ç»“æœï¼ˆç›¸åŒè¯·æ±‚ï¼‰
- âœ… å¹¶è¡Œæ‰§è¡Œå®¡æŸ¥
- âœ… å¼‚æ­¥å®¡æŸ¥ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰

### é£é™©3: è¿‡åº¦é˜»æ­¢
**åŸå› **: å®¡æŸ¥è¿‡äºä¸¥æ ¼ï¼Œé˜»æ­¢æ­£å¸¸è¯·æ±‚
**ç¼“è§£**:
- âœ… å¯é…ç½®çš„å®¡æŸ¥é˜ˆå€¼
- âœ… ç™½åå•æœºåˆ¶ï¼ˆå¯ä¿¡è¯·æ±‚ï¼‰
- âœ… ç”¨æˆ·ç”³è¯‰é€šé“

### é£é™©4: å®ªæ³•æ›´æ–°æ»å
**åŸå› **: å®ªæ³•æ–‡ä»¶æ›´æ–°ä¸åŠæ—¶
**ç¼“è§£**:
- âœ… çƒ­åŠ è½½æœºåˆ¶
- âœ… ç‰ˆæœ¬æ§åˆ¶
- âœ… æ›´æ–°é€šçŸ¥æœºåˆ¶

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ä¼¦ç†å®¡æŸ¥åŠŸèƒ½æ­£å¸¸ï¼ˆLLM + è§„åˆ™ï¼‰
- [ ] å¤šçº§å®¡æŸ¥é›†æˆæ­£å¸¸ï¼ˆL4/L3/L2ï¼‰
- [ ] å®ªæ³•æ–‡ä»¶åŠ è½½æ­£å¸¸
- [ ] é™çº§æœºåˆ¶æ­£å¸¸ï¼ˆå…³é”®è¯æ£€æµ‹ï¼‰
- [ ] ä¼¦ç†é˜»æ­¢å“åº”æ­£ç¡®

### æ€§èƒ½éªŒæ”¶
- [ ] å®¡æŸ¥å»¶è¿Ÿ < 2ç§’
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] å†…å­˜ä½¿ç”¨å¢é•¿ < 10MB
- [ ] å¹¶å‘å®¡æŸ¥æ€§èƒ½ > 10 req/s

### å®‰å…¨æ€§éªŒæ”¶
- [ ] è‡´å‘½å…³é”®è¯100%é˜»æ­¢
- [ ] å®¡æŸ¥æ—¥å¿—å®Œæ•´è®°å½•
- [ ] å®ªæ³•æ–‡ä»¶å®‰å…¨åŠ è½½
- [ ] æ— ç»•è¿‡å®¡æŸ¥çš„æ–¹æ³•

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¸Šæ¸¸ä¾èµ–
- âœ… P0-P2é˜¶æ®µå®Œæˆï¼ˆL5/L6/L4/L2/L3å±‚å·²æ¿€æ´»ï¼‰
- âœ… LLMManager - ç”¨äºä¼¦ç†æ¨ç†
- âœ… é…ç½®ç³»ç»Ÿ - ç”¨äºå®ªæ³•ç®¡ç†
- âœ… æ–‡ä»¶ç³»ç»Ÿ - ç”¨äºå®ªæ³•åŠ è½½

### ä¸‹æ¸¸ä¾èµ–ï¼ˆP4é˜¶æ®µï¼‰
- â³ AceCoreæœ¬åœ°åŒ– - å®Œå…¨æ›¿ä»£ace-engine-core
- â³ æ‰€æœ‰å±‚çº§ç»Ÿä¸€ç®¡ç†

---

## ğŸ“š å‚è€ƒå®ç°

### ç›¸å…³æ–‡ä»¶
- `src/services/AceEthicsGuard.ts` - æ–°å»º
- `config/constitution.md` - æ–°å»º
- `src/services/ChatService.ts` - ä¿®æ”¹
- `src/strategies/AceStrategyOrchestrator.ts` - ä¿®æ”¹
- `src/services/AceCapabilityManager.ts` - ä¿®æ”¹
- `src/services/AceStrategyManager.ts` - ä¿®æ”¹

### æµ‹è¯•æ–‡ä»¶
- `tests/unit/services/AceEthicsGuard.test.ts`
- `tests/integration/layer1-ethics-integration.test.ts`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-12
**ä½œè€…**: Claude Code
**å®¡æ ¸**: å¾…å®¡æ ¸
