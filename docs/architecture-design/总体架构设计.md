# ApexBridge 架构设计文档

> 文档版本：v1.0.0
> 创建日期：2025-12-29
> 文档性质：现有系统架构分析（无新增设计）

---

## 1. 总体架构概览

ApexBridge 是一个轻量级的 ABP（AI Bridge Protocol）聊天服务，采用 TypeScript/Node.js 构建。架构遵循分层设计，关注点分离清晰：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API 层                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │  Controllers │  │  Middleware │  │  WebSocket  │  │   路由配置          │ │
│  │Chat/Provider│  │   15+ 层    │  │   Manager   │  │   & Validation      │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                            服务层                                            │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       ChatService (协调器)                               │ │
│  │  - 策略选择    - 会话管理    - 请求跟踪                                  │ │
│  │  - 变量解析    - ACE 集成    - 上下文管理                                │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐  │
│  │SkillMgr  │ │Playbook  │ │Context   │ │LLMConfig │ │ AceService       │  │
│  │          │ │Matcher   │ │Manager   │ │Service   │ │                  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                           核心引擎层                                          │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────────────┐ │
│  │  ProtocolEngine  │  │   LLMManager     │  │  StreamOrchestrator        │ │
│  │  - ABP 解析器    │  │  - 适配器模式    │  │  - ReActEngine            │ │
│  │  - RAG 服务      │  │  - 提供商管理    │  │  - ToolExecutor           │ │
│  │  - 变量引擎      │  │  - 模型注册表    │  │  - LLMAdapter             │ │
│  └──────────────────┘  └──────────────────┘  └────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                            策略层                                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────────────┐ │
│  │ ChatStrategy     │  │ ReActStrategy    │  │ SingleRoundStrategy       │ │
│  │ (接口)           │  │ - 多轮对话       │  │ - 快速单次响应            │ │
│  │                  │  │ - 工具调用       │  │                           │ │
│  └──────────────────┘  └──────────────────┘  └────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                            数据层                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐ │
│  │ SQLite       │  │ LanceDB      │  │ Redis        │  │  文件存储        │ │
│  │ (配置/历史)  │  │ (向量)       │  │ (缓存/限流)  │  │  (Skills/Playbook│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 模块划分

### 2.1 API 层 (`src/api/`)

**Controllers:**
| 文件 | 职责 |
|------|------|
| `ChatController.ts` | OpenAI 兼容的聊天 API（`/v1/chat/completions`、`/v1/models`、`/v1/interrupt`、会话管理） |
| `ProviderController.ts` | LLM 提供商管理（`/api/llm/providers/*`） |
| `ModelController.ts` | 模型管理（`/api/llm/models/*`） |

**Middleware（15+ 层）：**
- 认证、限流、验证、清理、安全头、安全日志、审计日志、错误处理

**WebSocket：**
- `WebSocketManager.ts` - 连接管理、路由、心跳
- `ChatChannel.ts` - 聊天消息处理、流式传输

### 2.2 服务层 (`src/services/`)

| 服务 | 职责 |
|------|------|
| `ChatService` | 主协调器、策略协调 |
| `LLMConfigService` | 基于 SQLite 的 LLM 提供商/模型配置 |
| `SessionManager` | 会话生命周期、元数据管理 |
| `RequestTracker` | 活动请求跟踪、中断处理 |
| `SkillManager` | Skills 生命周期（安装/卸载/索引） |
| `ContextManager` | 上下文修剪、压缩、检查点 |
| `AceService` | ACE（自主认知引擎）核心 |
| `PlaybookMatcher` | 通过向量匹配 Playbook |
| `MCPIntegrationService` | MCP 服务器管理 |

### 2.3 核心引擎层 (`src/core/`)

| 组件 | 职责 |
|------|------|
| `ProtocolEngine` | ABP 协议解析、RAG 集成 |
| `LLMManager` | 多提供商适配器编排 |
| `ReActEngine` | 多轮思考和工具执行 |
| `VariableEngine` | 动态变量解析 |
| `EventBus` | 内部事件系统 |

### 2.4 策略层 (`src/strategies/`)

- `ChatStrategy.ts` - 所有策略的接口契约
- `ReActStrategy.ts` - 带工具的多轮思考
- `SingleRoundStrategy.ts` - 快速单次响应模式

---

## 3. 关键设计模式

### 3.1 适配器模式（LLM 提供商）

```
LLMManager --> LLMAdapterFactory --> BaseAdapter --> Specific Adapters
                                            |-- OpenAIAdapter
                                            |-- DeepSeekAdapter
                                            |-- ClaudeAdapter
                                            |-- ZhipuAdapter
                                            |-- OllamaAdapter
```

### 3.2 策略模式（聊天处理）

```
ChatService --> selectStrategy() --> ReActStrategy (多轮)
                                   --> SingleRoundStrategy (快速)
```

### 3.3 单例模式

- `SkillManager.getInstance()`
- `LLMConfigService.getInstance()`
- `EventBus.getInstance()`
- `AceService.getInstance()`

### 3.4 提供者模式（变量解析）

```
VariableEngine --> TimeProvider
                --> PlaceholderProvider
                --> Custom Providers
```

### 3.5 仓库模式

- `LLMConfigService` - SQLite 提供商/模型仓库
- `ConversationHistoryService` - 消息仓库
- `ContextStorageService` - 上下文检查点仓库

### 3.6 工厂模式

- `LLMAdapterFactory.create(provider, config)` - 创建适当的适配器
- `ToolRetrievalService` - 动态工具检索

---

## 4. 数据流

### 4.1 聊天请求流程

```
HTTP Request (POST /v1/chat/completions)
         |
         v
ChatController --> 请求验证 --> ChatService.processMessage()
         |
         v
ChatService --> selectStrategy() --> ReActStrategy OR SingleRoundStrategy
         |
         v
Strategy.prepare() --> VariableEngine.resolveMessages()
         |
         v
LLMManager.chat() / streamChat()
         |
         v
LLMAdapter (OpenAI/DeepSeek/etc.)
         |
         v
Response --> ConversationHistoryService.saveMessages()
         |
         v
HTTP Response / WebSocket Stream
```

### 4.2 工具执行流程

```
ReActEngine (迭代)
         |
         v
ToolDispatcher --> BuiltInExecutor (本地工具)
                    |-- FileReadTool
                    |-- FileWriteTool
                    |-- VectorSearchTool
         |
         v
         --> SkillsSandboxExecutor (隔离的 skill 执行)
         |
         v
Observation 返回给 LLM
```

### 4.3 上下文管理流程

```
用户消息 --> ContextManager.manageContext()
                         |
                         v
              检查 token 数量 vs 阈值
                         |
           ┌────────────┼────────────┐
           v            v            v
       截断        压缩          混合
           |            |            |
           v            v            v
    保留最新消息   LLM 摘要      动态
                   + 上下文      选择
                         |
                         v
         ContextStorageService.saveEffectiveContext()
         ContextStorageService.createCheckpoint()
```

---

## 5. 技术栈

### 5.1 运行时与语言

- **运行时**：Node.js >= 16.0.0
- **语言**：TypeScript 5.0
- **包管理器**：npm

### 5.2 关键依赖

| 类别 | 库 |
|------|-----|
| Web 框架 | Express 4.18, Helmet 7.1, CORS |
| WebSocket | ws 8.17 |
| 数据库 | better-sqlite3 12.4, @lancedb/lancedb 0.22 |
| 向量数据库 | chromadb 3.1, hnswlib-node 3.0 |
| LLM SDK | @modelcontextprotocol/sdk 1.24 |
| RAG | abp-rag-sdk 1.0, @xenova/transformers 2.17 |
| HTTP 客户端 | axios 1.6 |
| 验证 | ajv 8.17, ajv-formats |
| 配置 | js-yaml 4.1, dotenv 16.0 |
| 日志 | winston 3.11 |
| 工具 | uuid 13, p-queue 9, p-limit 7 |

### 5.3 数据存储

- **SQLite**：`.data/llm_providers.db`、`.data/conversation_history.db`
- **LanceDB**：`.data/skills.lance`、`.data/playbooks.lance`
- **Redis**：可选（用于限流和缓存）

### 5.4 配置

- 主配置：`config/admin-config.json`
- 环境变量：`.env` 文件（环境变量覆盖配置）
- LLM 提供商：存储在 SQLite（运行时热重载）

---

## 6. 关键入口点

| 文件 | 用途 |
|------|------|
| `src/server.ts` | 主服务器入口（`ABPIntelliCore` 类） |
| `src/core/ProtocolEngine.ts` | 核心 ABP 协议引擎 |
| `src/core/LLMManager.ts` | LLM 提供商编排 |
| `src/services/ChatService.ts` | 主聊天编排服务 |
| `src/api/controllers/ChatController.ts` | REST API 处理器 |

---

## 7. 架构演进历史

| 版本 | 变更 |
|------|------|
| v1.0.0 | 初始架构，支持多 LLM 提供商、策略模式、Skills 系统 |

---

> 本文档描述系统当前状态，不包含任何设计变更建议。
