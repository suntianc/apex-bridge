# 10 - 环境配置与脚本

环境配置和脚本体系决定了 Apex Bridge 的部署效率与跨平台一致性。本章总结 `.env` 关键项、npm 脚本、辅助脚本与常见自动化流程。

## 10.1 环境变量核心项
- `PORT`：Hub HTTP/WS 监听端口，默认 8088。
- `HOST`：可选绑定地址，用于多网卡或容器环境。
- `LLM_PROVIDER`：DeepSeek、openai、zhipu、ollama 等，决定 LLMClient 的路由。
- `OPENAI_API_KEY` / `DEEPSEEK_API_KEY` 等：所选模型的访问密钥。
- `MEMORY_SYSTEM`：`rag`（默认）或 `memory`。当设为 `memory` 时需提供 `MEMORY_SERVICE_URL`、`MEMORY_API_KEY`（如需要）。
- `WS_TOKEN`：节点连接 Hub 的鉴权令牌。
- `ADMIN_PASSWORD`：管理后台登录口令，建议在生产环境中设置复杂值。
- `PROXY_URL`：可选的网络代理地址，用于访问外部模型。
- `LOG_LEVEL`：控制日志级别（info/debug/warn/error）。

`.env` 文件可按环境拆分（如 `.env.local`、`.env.prod`），并结合脚本自动选择。

## 10.2 npm 脚本说明
- `npm run dev`：开发模式，使用 nodemon 监听 `src/` 与配置文件变动，自动重启。
- `npm run build`：`tsc` 编译 TypeScript 到 `dist/`，用于生产部署。
- `npm start`：执行 `node dist/server.js`，启动生产服务。
- `npm run lint`（如配置）：执行 ESLint 校验代码。
- `npm run format`（如配置）：使用 Prettier 格式化代码。
- `npm run test`：使用 Jest 运行测试；结合 `--watch`、`--coverage` 可拓展能力。
- `npm run admin:dev` / `admin:build`（如在 package.json 中定义）：启动或构建管理后台。

## 10.3 辅助脚本与工具
- `scripts/` 目录可包含：
  - `setup-dev.(ps1|sh)`：自动安装依赖、复制 `.env`、创建默认目录。
  - `backup-data.ts`：备份 `data/`、`logs/`，输出压缩包。
  - `restore-data.ts`：根据备份恢复数据，支持选择时间点。
  - `deploy.ts`：集成构建、测试、打包和上传流程。
- `nodemon.json`：配置开发模式下的监听路径与忽略目录，避免日志或数据更新导致频繁重启。
- `tsconfig.json`：包含路径别名（如 `@core/*`、`@services/*`），在脚本中也应使用同样的别名以保持一致性。

## 10.4 常见自动化流程
1. **开发环境初始化**：
   ```bash
   git clone repo
   cd apex-bridge
   cp env.template .env
   npm install
   npm run dev
   ```
2. **生产打包与部署**：
   ```bash
   npm ci
   npm run build
   npm prune --production
   pm2 start dist/server.js --name apex-bridge
   ```
3. **CI/CD 流程**：
   - 步骤：Lint → Unit Test → Build → 打包产物 → 上传或触发部署。
   - 可在 GitHub Actions、GitLab CI 或 Jenkins 中实现。
4. **备份计划**：使用 cron/Task Scheduler 定期运行 `node scripts/backup-data.ts`，并将备份同步到 NAS 或云存储。

## 10.5 环境差异与注意事项
- **Windows**：路径分隔符为 `\`，注意脚本兼容性；`nodemon` 需要以 PowerShell/WSL 运行。
- **Linux/macOS**：可使用 systemd 作为服务管理器；建议设置 `LimitNOFILE`、`Restart=on-failure` 等选项。
- **容器化**：Dockerfile 应包含 multi-stage 构建，挂载 `/app/data`、`/app/logs` 保持持久化。
- **树莓派**：需选择 ARM 兼容 Node.js 版本；可使用轻量模型并关闭高耗插件。

## 10.6 配置管理最佳实践
- 使用 `.env.example` 或 `env.template` 作为文档，列出必填项与示例值。
- 对关键配置启用双人复核或变更审批，避免误操作。
- 使用密钥管理服务（Vault、Pass、1Password）存储敏感变量，再注入到 `.env`。
- 把脚本与配置说明纳入文档或 README，保持团队一致理解。

通过合理的环境变量设计与脚本体系，Apex Bridge 可以在家庭、企业、云端等多种场景中快速部署并保持可维护性。

