# 02 - 服务与节点协作

服务层负责把核心引擎与外围能力串联起来，包括记忆读写、节点治理、主动调度、异步结果管理等。理解这一层有助于掌握 Hub 如何协调 Worker/Companion 节点、如何在家庭场景里持续提供上下文与主动关怀。

## 2.1 记忆服务：RAGMemoryService 与 IMemoryService
**位置**：`src/services/RAGMemoryService.ts`、`src/types/memory.ts`

- **统一接口**：`IMemoryService` 定义了 `saveMemory`、`searchMemories`、`recordEmotion`、`learnPreference`、`buildTimeline` 等操作，Hub 内部始终调用该接口。
- **默认实现**：`RAGMemoryService` 基于 `vcp-intellicore-rag`，支持语义检索、时间加权、重排、日记归档。数据存储在 `data/vector_store` 和 `dailynote/` 下。
- **可替换实现**：当 `.env` 中配置 `MEMORY_SYSTEM=memory` 时，会使用 RemoteMemoryClient 连接 Rust 版 apex-memory，通过 HTTP/gRPC 获取 Graph-RAG 结果。
- **写入路径**：对话、情绪、偏好、重要事件在 ChatService/EmotionEngine/PreferenceExtractor 中生成记忆条目，再交由 RAGMemoryService 落库。
- **检索流程**：根据请求类型选取不同策略，例如 `time` 模式按时间排序，`group` 模式扩展语义簇，`rerank` 模式调用外部 reranker。

> **数据驻留**：默认 RAG 模式下的向量文件为本地 JSON + 向量索引；apex-memory 则依赖 PostgreSQL + Qdrant + Neo4j，需单独部署。

## 2.2 节点治理：NodeService 与 NodeManager
**位置**：`src/services/NodeService.ts`、`src/core/NodeManager.ts`

- **注册与持久化**：节点通过 WebSocket 注册，NodeService 将节点信息保存到 `data/config/nodes/*.json`，包括 `nodeId`、`type`、`capabilities`、人格引用等。
- **心跳机制**：节点定期发送 `heartbeat`，包含状态（online/offline/busy）、资源占用（CPU、内存）、任务统计。NodeService 更新缓存并通知订阅者。
- **配置中心**：支持为节点写入专属配置（最大并发、插件列表、网络终端等），Hub 在任务分配时会参考这些配置。
- **状态合并**：当分布式通道返回实时状态时，NodeService 会把持久化信息与实时数据合并供前端或 API 查询。
- **NodeManager 职责**：封装对 NodeService 的调用，并协调 DistributedServerChannel，把任务投递给指定节点。

## 2.3 分布式通信：DistributedService 与 WebSocket Channel
**位置**：`src/services/DistributedService.ts`、`src/api/websocket/`

- **DistributedService**：负责初始化 `DistributedServerChannel`、`NodeAwareDistributedServerChannel` 等通道，注册消息处理器。
- **WebSocketManager**：维持客户端与节点的 WS 连接，转发聊天消息、插件进度、系统广播。
- **消息类型**：包括 `node_register`、`heartbeat`、`task_assign`、`task_result`、`llm_request`、`notify` 等，统一定义在节点运行时与 Hub 之间。
- **任务闭环**：Hub 分发 `task_assign` → 节点执行任务 → 通过 `task_result` 回传结果；若是异步工具，结果会写回 `/plugin-callback`。
- **安全控制**：在注册阶段对节点提供密钥或证书校验，心跳中可附带签名，避免陌生节点接入。

## 2.4 主动调度：ProactivityScheduler 与场景配置
**位置**：`src/core/ProactivityScheduler.ts`、`data/config/proactivity/`

- **调度引擎**：使用 `node-schedule` 管理 cron/日期表达式，支持定时、周期与一次性任务。
- **场景描述**：配置文件记录触发条件（时间、事件、情绪、节点状态）、目标人设、消息模板、需要调用的插件。
- **运行流程**：当满足条件时，Scheduler 构造虚拟对话上下文，将请求送入 VCPEngine 或直接调用插件，实现主动问候、提醒、推荐等。
- **频率控制**：结合 PolicyGuard、QuotaManager，限制主动消息频率，防止打扰用户。
- **场景示例**：每日早安、生日提醒、情绪安抚、待办检查、节点异常告警等。

## 2.5 异步结果与任务清理
**位置**：`src/services/AsyncResultCleanupService.ts`

- **任务跟踪**：当插件返回异步任务 ID 时，结果会缓存在 `async_results/`，供前端或后续请求查询。
- **回调落盘**：`plugin-callback` API 接收节点或外部服务的任务完成通知，写入缓存并通知等待中的请求。
- **清理策略**：定时扫描超时未完成或已消费的任务，避免文件夹无限增长。
- **错误恢复**：若节点断线导致任务未完成，系统会标记状态并可在前端提示用户手动重试。

## 2.6 会话服务：ChatService
**位置**：`src/services/ChatService.ts`

- **请求入口**：从 ChatController 接收 HTTP 请求，或从 WebSocket 接收实时消息。
- **会话管理**：维护会话上下文、记忆策略、异步回调桥接；对多用户场景支持并发隔离。
- **响应分发**：将 VCPEngine 的响应输送给 WebSocket 或 HTTP 流；处理流式与非流式模式。
- **日志与审计**：记录请求 ID、工具调用、情绪标签、响应耗时，方便后续分析。

## 2.7 协同示例：Hub 与 Worker 完成联合任务
1. Worker 节点启动，发送 `node_register`，NodeService 创建或更新节点记录。
2. 用户通过 Hub 发起需要文件整理的请求；ChatService 将请求交给 VCPEngine。
3. VCPEngine 识别需要调用 `file_organize` 插件，DistributedService 将任务派发给具备该能力的 Worker。
4. Worker 执行完成后，通过 `task_result` 或 `plugin-callback` 回传结果；NodeService 更新任务统计。
5. VCPEngine 整合结果生成回复，同时 ProactivityScheduler 或 MemoryService 记录必要的后续动作。

## 2.8 设计考量与运维建议
- **数据一致性**：节点信息既存于内存也落在文件中，需定期校验冗余数据一致；建议在节点升级时执行同步脚本。
- **安全**：对节点注册、任务派发定义白名单或令牌；对主动任务设置审批或速率限制。
- **扩展**：可为 Worker/Companion 添加自定义配置段（如本地插件路径、模型缓存目录），Hub 会通过 NodeService 暴露给管理后台。
- **监控**：结合日志与 Prometheus 指标记录节点在线率、任务成功率、主动提醒命中率。

服务层确保核心引擎的结果能够与记忆、节点、主动行为协同，形成贯穿家庭日常的整体体验。


