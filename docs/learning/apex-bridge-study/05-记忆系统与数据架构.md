# 05 - 记忆系统与数据架构

记忆系统承载着家庭 AI 的“长期记忆”。Apex Bridge 采用 `IMemoryService` 抽象，默认提供基于 `vcp-intellicore-rag` 的轻量方案，同时兼容 Rust 实现的 apex-memory，以满足高级检索与图谱推理需求。

## 5.1 IMemoryService 抽象
**定义位置**：`src/types/memory.ts`

关键接口包括：
- `saveMemory(payload)`：写入对话摘要、偏好、情绪等条目。
- `searchMemories(query, options)`：按语义、时间、类别检索记忆。
- `recordEmotion(event)`：记录情绪事件，附带强度、触发语句、相关角色。
- `learnPreference(entry)`：提炼偏好信息并更新权重。
- `buildTimeline(params)`：生成时间线，用于回顾或主动提示。

所有服务（ChatService、EmotionEngine、ProactivityScheduler 等）只与接口交互，保证实现可互换。

## 5.2 RAGMemoryService：默认记忆实现
**位置**：`src/services/RAGMemoryService.ts`

- **数据结构**：使用向量存储 + 元数据 JSON 组合，向量文件位于 `data/vector_store/`。支持多个集合（对话摘要、日记、偏好、情绪片段）。
- **检索策略**：支持基础语义检索、按时间排序、语义聚类、外部 rerank。调用时可组合多个模式（如 `time+group`）。
- **写入逻辑**：对话结束时保存摘要；情绪事件由 EmotionEngine 调用 `recordEmotion`; 偏好提取由 PreferenceExtractor 完成；日记由 DiaryArchiveService 定期归档。
- **性能特点**：开箱即用、资源要求低，适合个人/家庭用户。检索延迟通常在毫秒级到百毫秒级。

## 5.3 apex-memory：Rust 三库融合
**部署位置**：独立项目 `apex-memory/`

- **组件**：
  - **Ingestor**（8081）：负责记忆写入，处理对话、情绪、偏好、快照。
  - **Retriever**（8080）：Graph-RAG 检索入口，合并向量、图谱、事实。
  - **Consolidator**：定时巩固任务，执行重要性评估、层级迁移、遗忘策略。
- **三库结构**：
  - PostgreSQL：存储事实、画像、活跃话题，保障事务与精准查询。
  - Qdrant：管理语义向量（对话、快照文本、情绪嵌入）。
  - Neo4j：维护关系图谱（人与人、事件、主题之间的连接）。
- **API 协议**：同时提供 REST（Axum）与 gRPC（Tonic）；支持带约束的检索（token 预算、延迟目标）。
- **高级特性**：情绪标注、快照归档（HTML→PNG+OCR）、关系扩展推理、重要性评分、可视化时间线。
- **部署要求**：Rust 1.70+、PostgreSQL/Qdrant/Neo4j 安装与运维经验；适合深度用户或企业场景。

## 5.4 记忆切换流程
1. 在 `.env` 中设置 `MEMORY_SYSTEM=memory` 并配置 `MEMORY_SERVICE_URL`。
2. Hub 启动时通过 RemoteMemoryClient 连接 apex-memory，并在健康检查中验证状态。
3. 如果连接失败，系统可降级回 RAG 模式（可在配置中开启自动回退）。
4. 当切换成功后，情绪、偏好、时间线等接口会自动调用远程服务。

## 5.5 数据分层与目录布局
```
apex-bridge/
├── data/
│   ├── vector_store/       # RAG 向量与元数据
│   ├── dailynote/          # AI 日记与快照
│   ├── config/
│   │   ├── personality/    # 人格档案
│   │   ├── proactivity/    # 主动场景
│   │   └── nodes/          # 节点信息
│   └── logs/               # 运行日志
└── async_results/          # 异步任务结果缓存
```

apex-memory 部署时，还需维护其独立的数据目录：
```
apex-memory/
├── data/
│   ├── postgres/
│   ├── qdrant/
│   ├── neo4j/
│   └── snapshots/
└── logs/
```

## 5.6 写入与检索示例
**写入**：当用户说“我喜欢听爵士乐”，PreferenceExtractor 生成偏好条目：
```json
{
  "type": "preference",
  "subject": "music",
  "value": "jazz",
  "confidence": 0.85,
  "source": "dialogue",
  "timestamp": 1730352000
}
```
RAG 模式下写入向量库；apex-memory 模式下调用 `/v1/profile/upsert`。

**检索**：在对话中出现“我最近喜欢什么音乐？”，VCPEngine 请求 `IMemoryService.searchMemories`，向量检索返回“爵士乐”记忆；如果使用 apex-memory，还会结合关系图谱给出推荐理由。

## 5.7 性能与维护建议
- 定期备份 `data/vector_store/`、`dailynote/`、`config/`，避免意外丢失。
- 在 RAG 模式下，向量库大小需控制，可通过合并旧记录或启用日记模式减少体积。
- apex-memory 需监控数据库健康（磁盘、内存、延迟），建议接入 Prometheus/Grafana。
- 对隐私敏感场景，可启用本地加密或文件系统加密，避免原始文本泄露。

记忆系统决定了 AI 能否真正“记住”家庭成员的偏好、情绪与关系。根据部署规模选择合适的实现，是让 Apex Bridge 适应不同用户的重要步骤。

