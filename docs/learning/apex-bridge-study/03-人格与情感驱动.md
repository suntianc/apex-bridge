# 03 - 人格与情感驱动

人格与情感系统决定了 Apex Bridge 的“温度”。这一层由人格档案、PersonalityEngine、EmotionEngine、ProactivityScheduler、记忆服务共同作用，确保同一段需求在不同家庭成员、不同情绪下呈现差异化表现。

## 3.1 人格档案结构
- **存放位置**：`data/config/personality/`，每个角色使用独立文本文件（UTF-8）。
- **常见段落**：
  - `基础信息`：姓名、称谓、年龄设定、关系定位。
  - `说话风格`：语速、语气、常用表情、是否使用 emoji。
  - `价值观与禁忌`：明确哪些话题需要谨慎、哪些行为需要先征得同意。
  - `成功/失败反馈`：完成任务后的鼓励方式，失败时的道歉和补救策略。
  - `兴趣偏好`：推荐内容时的倾向，例如音乐、电影、学习方式。
- **范式**：建议使用 key-value + 列表格式，便于后续自动解析或生成。

## 3.2 PersonalityEngine 工作机制
**源码**：`src/core/PersonalityEngine.ts`

1. **文件加载**：在 Hub 启动或角色切换时读取人格文件，解析为结构化对象缓存。
2. **Prompt 构建**：将人格信息整合为 System Prompt，包含口头禅、语气、关系定位、边界条件等。
3. **上下文拼接**：在 VCPEngine 组装对话时把人设 Prompt 放在最前，确保模型从第一轮就采用设定风格。
4. **多角色支持**：Hub 主人格、各 Worker、各 Companion 可指定不同档案；节点注册时可提供 `personalityFile` 字段指向专属档案。
5. **动态调节**：当 EmotionEngine 提供情绪标签或记忆中存在特定偏好时，PersonalityEngine 会临时插入附加提示（如更柔和的语气、避免触及敏感话题）。

## 3.3 EmotionEngine：情绪识别与调节
**源码**：`src/core/EmotionEngine.ts`

- **情绪分类**：默认使用轻量模型或规则对文本进行分类，输出枚举值（happy、neutral、sad、angry、anxious 等）。部署时可替换为更准确的模型。
- **调节输出**：把情绪标签注入 VCPEngine 上下文，为人格提示增添“应对策略”，例如“用户情绪低落，请先安慰再给建议”。
- **记忆写入**：当情绪强度超过阈值或被标记为重要事件时，会把情绪作为元数据存入记忆。这让系统在未来可引用“上次你提到压力大”之类的信息。
- **主动触发**：负面情绪连续出现会触发 ProactivityScheduler 执行安抚或提醒场景（喝水、休息、寻求帮助）。
- **安全策略**：可在配置中列出敏感词或情绪阈值，触发人工介入或特殊处理流程。

## 3.4 ProactivityScheduler 与人格的结合
人格与情绪不仅影响即时回复，还决定主动行为的风格与频率。

- **场景配置**：`data/config/proactivity/` 描述触发条件与消息模板，模板中可引用人格标签（如昵称、口头禅）。
- **触发逻辑**：Scheduler 判断场景是否触发后，会向 VCPEngine 发起内部请求；PersonalityEngine 负责在该请求中附上合适的语气。
- **个性化提醒**：同一提醒（例如喝水）在不同角色下表达方式不同：AI 母亲可能温柔叮嘱，AI 同事则可能更直接、简洁。

## 3.5 人格、情绪与记忆的联动
- **偏好学习**：PreferenceExtractor 在对话中捕捉用户偏好（喜欢的音乐、重要日期），写入记忆；PersonalityEngine 会根据这些偏好调整推荐。
- **关系图谱**：当启用 apex-memory 时，情绪与人格设定可以映射到图谱节点，用于推断“谁与谁关系亲密”“谁更需要关怀”。
- **时间线回顾**：TimelineController 可把情绪高低点汇总成时间线，让用户回顾过去的心情与事件，这些信息也会反过来指导未来对话。

## 3.6 设计建议
1. **人格一致性**：保持档案风格统一，避免同一角色在不同场景中表现过于矛盾。
2. **边界意识**：在人设中明确不可触碰的话题，尤其是家庭、隐私、医疗等敏感领域。
3. **情绪响应节制**：不要让情绪回应过于夸张或机械；结合记忆做有限度的引用更真实。
4. **可持续维护**：建立人格档案版本号与变更记录，避免多人修改造成冲突。

## 3.7 实战样例
**目标**：构建“AI 管家老张”和“AI 女儿小悦”两种人格，并让系统根据情绪主动关怀。

1. 创建 `data/config/personality/laozhang.txt` 与 `xiaoyue.txt`，分别设定语气、场景偏好。
2. Hub 主人格指向 `laozhang`，Companion 节点指向 `xiaoyue`。
3. 在对话中表达疲惫、压力，EmotionEngine 标记 `anxious`。
4. ProactivityScheduler 根据场景触发“晚间放松提醒”，PersonalityEngine 让小悦以关怀语气发送语音/文字。
5. 记忆系统记录此次情绪与关怀结果，未来遇到类似情绪能引用“上次我们一起做了呼吸训练”。

人格与情绪模块使 Apex Bridge 不再只是工具集成，而是能与家庭成员建立长期情感链接的 AI 伙伴。

