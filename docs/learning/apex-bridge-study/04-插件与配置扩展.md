# 04 - 插件与配置扩展

插件体系赋予 Apex Bridge 高度可扩展的功能。借助统一的运行时、权限模型、配置服务，项目能够安全地加载第三方能力，同时保持跨平台一致的部署体验。

## 4.1 插件目录与分类
- **目录结构**：`plugins/` 下按照类型划分子目录，如 `direct/`、`hybrid/`、`static/`。每个插件包含 manifest（JSON/TS 定义）与实现文件。
- **Direct 插件**：同步执行，立刻返回结果。适合本地计算、检索类任务。
- **Hybrid 插件**：可触发长耗时任务，返回 `taskId`；任务完成后通过 `/plugin-callback/:plugin/:taskId` 回写结果。
- **Static 插件**：提供固定信息或模版回复，无需执行逻辑。
- **Service 插件**（可选扩展）：通过 HTTP/gRPC 调用外部服务，需要在 manifest 中声明网络访问权限。

## 4.2 PluginLoader 与 PluginRuntime
**源码**：`src/core/PluginLoader.ts`, `src/core/PluginRuntime.ts`

- **加载流程**：启动时扫描目录，读取 manifest，校验名称是否唯一、权限声明是否完整、依赖文件是否存在。加载成功后注册到 PluginRegistry。
- **执行入口**：VCPEngine 接收到模型的函数调用请求后，通过 PluginRuntime 找到对应插件并执行 `invoke()`。
- **上下文构建**：PluginRuntime 向插件传入标准上下文，包括调用方信息、当前会话数据、可用工具、日志句柄、取消信号等。
- **异步任务管理**：Hybrid 插件返回 `taskId` 后，PluginRuntime 负责把任务写入 `async_results/` 并监听回调，超时由 AsyncResultCleanupService 处理。
- **重试策略**：可在 manifest 中指定失败重试次数和间隔；PluginRuntime 将自动执行重试并记录日志。

## 4.3 Manifest 关键字段
- `name` / `displayName`：插件标识及展示名称。
- `description`：向模型说明插件能力，影响函数调用选择。
- `type`：`direct` / `hybrid` / `static`。
- `entry`：执行入口文件路径。
- `permissions`：权限声明，如 `"filesystem.read"`, `"network.http"`, `"hub-only"`。
- `limits`：资源限制，包含 `maxExecutionTime`、`maxMemoryMB`、`allowNetwork` 等。
- `capabilities`：用于 NodeService 判定哪些节点支持该插件。
- `parameters`：函数参数定义，遵循 JSON Schema 格式，便于模型理解调用方式。

## 4.4 权限与资源控制
**相关组件**：`PolicyGuard`, `QuotaManager`

- **执行级别**：`hub-only`、`worker-safe`、`companion-only`、`all` 等，决定插件可在哪些节点执行。
- **资源限制**：`maxExecutionTime`、`maxConcurrency`、`maxMemoryMB` 控制单次调用资源消耗。
- **网络访问**：manifest 中的 `allowNetwork` 必须显式开启；对于外部 URL 可在配置中设置白名单。
- **审计日志**：每次插件调用都会写入结构化日志（包含请求 ID、调用方、耗时、结果状态），便于追溯。
- **配额管理**：QuotaManager 能针对用户、节点、插件设置调用额度，防止滥用。

## 4.5 配置服务与路径管理
**源码**：`src/services/ConfigService.ts`, `src/services/RuntimeConfigService.ts`, `src/services/PathService.ts`

- **ConfigService**：整合 `.env`、`config/`、`data/config/` 中的配置项，为其它模块提供统一读取接口。
- **RuntimeConfigService**：开放 API 供管理后台热更新配置（如启用/禁用插件、调整主动任务频率）。更新后会写入文件并刷新内存缓存。
- **PathService**：统一管理目录路径，确保在 Windows、Linux、macOS 中都能正确定位 `data/`、`logs/`、`plugins/` 等目录。
- **备份与回滚**：在关键配置更新前，会自动创建快照，方便快速回退。

## 4.6 插件开发流程概述
1. 在 `plugins/<type>/` 下创建目录，编写 manifest 与实现。
2. 若需要第三方依赖，可放入 `plugins/node_modules` 或通过集中安装管理（避免与主项目冲突）。
3. 在 manifest 中声明权限与资源限制，确保符合安全要求。
4. 重启 Hub 或调用热加载接口，让 PluginLoader 重新扫描。
5. 在管理后台启用插件，或通过 API 手动注册。
6. 使用测试用例验证调用链，包括成功路径、异常路径、异步回调。

## 4.7 常见问题与排查
- **插件未被识别**：检查 manifest 格式；确保 `name` 唯一并在 `plugins/index.ts` 或自动扫描范围内。
- **调用失败**：查看 `logs/` 中的插件日志，确认资源限制、权限声明是否满足；必要时开启 debug 日志。
- **异步任务卡住**：确认回调 URL 与鉴权是否正确；检查 `async_results/` 是否积压旧任务。
- **配置未生效**：通过 RuntimeConfigService 的 GET 接口确认最新配置；核对 PathService 指向位置。

## 4.8 设计建议
- 将敏感功能拆分为多个小插件，降低权限范围。
- 对社区或第三方插件建立审核流程：检查代码、测试报告、权限声明。
- 在 manifest 中提供详尽的参数 Schema，提升模型调用准确率。
- 使用 Feature Flag 控制插件上线范围，先在测试环境验证，再逐步放量。

插件与配置体系让 Apex Bridge 在保持安全、可控的基础上实现高度可扩展。借助这些机制，可以快速集成文件管理、家电控制、理财助手等家庭化场景能力。

