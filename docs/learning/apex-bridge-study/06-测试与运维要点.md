# 06 - 测试与运维要点

Apex Bridge 的稳定运行依赖完善的测试体系、可观测性方案与运维流程。本章覆盖测试策略、日志监控、部署实务及应急回滚。

## 6.1 测试体系概览
- **单元测试**：使用 Jest + ts-jest，覆盖核心引擎、服务层、工具函数。测试位于 `tests/unit` 或对应目录下。
- **集成测试**：`packages/node-agent/tests` 中包含节点运行与 WebSocket 通道测试，模拟 Worker/Companion 与 Hub 的交互。
- **端到端测试**：可通过脚本模拟真实用户流程（对话、插件调用、主动提醒）。
- **测试数据**：推荐使用 fixtures 或 mock 服务避免调用真实 API，尤其是 LLMProvider。

## 6.2 测试重点场景
1. **对话链路**：验证 VCPEngine 与 LLMClient 的交互、工具调用流程、错误处理分支。
2. **插件执行**：Direct/Hybrid 插件的成功路径、异常路径、权限拦截、异步回调。
3. **记忆读写**：RAG 模式下的向量检索与写入；apex-memory 模式通过 Mock Server 或真实服务测试。
4. **节点协作**：节点注册、心跳、任务派发、断线重连、限流等。
5. **主动调度**：ProactivityScheduler 定时与事件触发，确保不会重复或错过。

## 6.3 测试命令与辅助脚本
- `npm run test`：执行所有 Jest 测试。
- `npm run test -- --watch`：监视模式，适合开发调试。
- `npm run test -- --coverage`：生成覆盖率报告。
- `scripts/run-integration-tests.ts`（可选）：集成测试脚本，控制节点模拟启动与断线。

建议在 CI 流水线中配置多阶段测试：单元测试 → 集成测试 → Lint/格式检查 → 构建。

## 6.4 日志与监控
- **日志框架**：`src/utils/logger.ts` 基于 `pino`（或同类库），输出 JSON 结构，支持多级别日志（info/debug/error）。
- **日志目录**：`logs/` 下分模块记录（hub.log、plugins.log、nodes.log等）。建议定期归档或接入集中式日志系统（ELK、Loki）。
- **重要字段**：`timestamp`、`level`、`requestId`、`module`、`message`、`extra`。requestId 贯穿请求链路，便于排查工具调用。
- **监控指标**：若接入 Prometheus，可采集对话响应时间、插件耗时、节点在线数量、记忆检索延迟、主动任务触发率。
- **apex-memory 监控**：重点关注 PostgreSQL/Qdrant/Neo4j 的 CPU、内存、磁盘、连接数；检索接口延迟与错误率。

## 6.5 部署策略
### 基础部署（个人/家庭）
- 系统环境：Windows 10+/macOS/Linux，Node.js 18+。
- 步骤：复制 `.env` → `npm install` → `npm run build` → `npm start`。
- 守护：可使用 `pm2`、`systemd`、`PowerShell ScheduledTask` 等实现自动重启。
- 数据备份：定期备份 `data/` 目录，尤其是 `vector_store`、`config`、`dailynote`。

### 分布式部署（家庭多节点）
- Hub 运行在性能较好的设备；Worker/Companion 可部署在树莓派或轻量服务器。
- 在节点 `.env` 中配置 Hub 地址、认证令牌、人格档案、插件路径。
- 建议使用反向代理（如 Nginx）处理 TLS 和外网访问。

### 高级部署（启用 apex-memory）
- 需准备数据库集群或容器化环境（Docker Compose/Kubernetes）。
- 配置 `MEMORY_SERVICE_URL` 并验证健康检查。
- 建议部署监控与告警系统，确保检索延迟和资源消耗在可控范围内。

## 6.6 回滚与应急
- 保留上一版本构建产物和 `.env` 快照。
- 在更新前执行 `scripts/backup-data.ts`（可自定义）备份关键目录。
- 若新版本出错，可立即回退到稳定版本并还原数据快照。
- 记录故障处理流程与教训，更新运维手册。

## 6.7 安全与合规
- 定期审查 API Key、节点令牌、插件权限。
- 日志中对敏感字段（Token、个人信息）进行脱敏或哈希处理。
- 提供数据导出与删除脚本，满足用户隐私诉求。
- 对社区插件建立审核机制，确保符合安全规范。

完善的测试与运维体系使 Apex Bridge 能够在家庭环境中长期稳定运行，及时应对故障并保持数据安全。

