# 11 - 插件开发入门

插件是 Apex Bridge 的能力扩展载体。本篇文档聚焦插件目录结构、生命周期、调试与安全注意事项，帮助在现有框架内开发可靠的 Direct/Hybrid/Static 插件。

## 11.1 目录结构与分类
- `plugins/`：根目录，按类型细分子目录（`direct/`、`hybrid/`、`static/` 等）。
- 每个插件包含 manifest（通常为 `index.json` 或 TypeScript 导出对象）与实现文件；可额外包含 README、测试脚本。
- **Direct 插件**：同步执行、立即返回，适合本地计算与快速查询。
- **Hybrid 插件**：需要长耗时任务或外部回调，返回 `taskId` 与初始状态；任务完成后经 `/plugin-callback` 写入结果。
- **Static 插件**：提供固定信息或模版，对模型起到知识补充作用。
- **Service 插件（可选拓展）**：封装 HTTP/gRPC 调用第三方服务，需显式声明网络权限。

## 11.2 生命周期流程
1. **注册阶段**：PluginLoader 扫描目录、解析 manifest、检查权限与资源限制，注册到 PluginRegistry。
2. **调用阶段**：VCPEngine 收到模型的函数调用指令，构造上下文交给 PluginRuntime。
3. **执行阶段**：插件执行逻辑，读取上下文（用户信息、当前会话、可用工具、日志接口等），返回结果或异步任务 ID。
4. **结果回传**：同步返回直接传递给 VCPEngine；异步任务通过 `/plugin-callback/:plugin/:taskId` 回写，AsyncResultCleanupService 维护任务状态。
5. **异常处理**：若发生错误，PluginRuntime 记录日志并根据 manifest 中的重试策略执行业务化处理。

## 11.3 manifest 关键字段
```json
{
  "name": "file.organize",
  "displayName": "文件整理助手",
  "type": "hybrid",
  "description": "整理指定目录下的文件并输出报告",
  "entry": "./index.ts",
  "permissions": ["filesystem.read", "filesystem.write", "network.http"],
  "limits": {
    "maxExecutionTime": 300000,
    "allowNetwork": true
  },
  "parameters": {
    "type": "object",
    "properties": {
      "path": {"type": "string"},
      "strategy": {"type": "string", "enum": ["by-type", "by-date"]}
    },
    "required": ["path"]
  }
}
```
- `permissions` 定义执行范围与能力；
- `limits` 约束资源使用；
- `parameters` 使用 JSON Schema 说明调用参数，影响模型的函数调用决策；
- `capabilities` 字段可用于声明插件适配的节点类型。

## 11.4 调试与测试要点
- 使用 `npm run dev` 启动 Hub，结合 `logs/plugins.log` 查看插件执行细节。
- 在 Jest 中模拟插件调用，验证参数解析、异常路径、重试机制及输出结构。
- 对 Hybrid 插件编写集成测试，模拟回调流程与超时场景。
- 为需要外部依赖的插件提供 mock 或测试替身，避免对真实服务造成影响。

## 11.5 安全与资源治理
- **最小权限**：manifest 中仅声明必要权限，避免插件越权访问文件或网络。
- **资源限制**：合理设置 `maxExecutionTime`、`maxMemoryMB`、`maxConcurrency`；在 PluginRuntime 中监控持续执行时间。
- **日志记录**：确保关键信息写入日志，方便排查；但要避免输出敏感数据。
- **审核流程**：对第三方插件进行代码审计、依赖检查、测试验证后再上线。

## 11.6 开发示例：天气查询插件
1. 在 `plugins/hybrid/weather` 下创建 manifest 与实现，声明 `network.http` 权限。
2. 实现逻辑：根据城市调用天气 API，返回解析后的结果；若 API 耗时较长，可采用 Hybrid 模式。
3. 在管理后台启用插件，并为节点配置所需能力。
4. 在对话中触发“帮我查明天的天气”，检查 VCPEngine 是否正确调用插件、返回结果。

通过规范的目录结构、清晰的 manifest 定义与严密的安全策略，Apex Bridge 插件生态可以持续扩展家庭 AI 的能力，同时保持系统稳定可靠。

