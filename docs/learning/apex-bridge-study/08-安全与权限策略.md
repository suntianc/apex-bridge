# 08 - 安全与权限策略

安全体系决定了家庭 AI 是否可信赖。Apex Bridge 在 API、节点、插件、数据四个层面构建防护措施，并提供灵活的配置入口以满足不同部署场景。

## 8.1 API 与用户访问控制
- **身份认证**：`authMiddleware` 支持基于 API Key 或 JWT 的鉴权，默认可选；面向公网部署时需强制启用。
- **权限控制**：结合用户角色（admin、family-member、guest）限制可访问的控制器。例如配置管理、节点运维接口仅开放给 admin。
- **会话管理**：Admin 后台使用独立的 `adminAuthMiddleware`，可配置登录口令复杂度、会话有效期、二次验证码。
- **速率限制**：可在 `Middleware` 层或反向代理中设置请求限流、突发限制；防止暴力请求导致的资源耗尽。
- **审计日志**：所有管理操作写入审计日志（包含操作者、请求参数、执行结果），便于追踪。

## 8.2 节点安全
- **身份认证**：节点注册时可携带访问令牌或签名，Hub 验证后才允许建立长连接；令牌配置在节点 `.env` 与 Hub 白名单中。
- **权限声明**：节点在 `node_register` 中报告 `capabilities`，Hub 依据白名单决定是否允许执行某些任务。
- **心跳监控**：缺失心跳会触发 `node.statusChange` 事件，用于告警或自动下线，避免“幽灵节点”。
- **网络隔离**：建议在家庭局域网下运行节点；若需公网访问，务必启用 TLS、VPN 或零信任通道。

## 8.3 插件权限模型
- **执行级别**：manifest 中的 `permissions` 指定插件能够被哪些节点调用（如 `hub-only`、`worker-safe`）。
- **资源限制**：`limits` 指定最大执行时长、内存、是否允许网络访问。PluginRuntime 会据此在执行阶段进行约束。
- **白名单策略**：对需访问外部 API 的插件，需在配置中列出允许的域名或 IP。
- **审核流程**：对于第三方或社区插件，应建立审核机制：检查代码、测试报告、权限声明、依赖清单。
- **沙箱执行**：可使用 Node.js Worker Threads 或子进程隔离高风险插件，防止阻塞主线程或访问敏感资源。

## 8.4 数据与隐私保护
- **本地优先**：默认所有数据保存在本地 `data/` 目录，部署者可控制存储位置与访问权限。
- **敏感信息**：对 API Key、个人信息进行加密或脱敏存储；建议配合文件系统加密。
- **备份策略**：备份 `vector_store`、`config`、`dailynote` 等关键目录时要注意加密与访问控制。
- **数据导出/删除**：提供脚本导出用户会话、记忆；应支持按请求删除指定用户或时间段数据，以满足隐私法规。

## 8.5 日志与监控安全
- **日志脱敏**：在 `logger.ts` 中对敏感字段进行掩码处理，禁止直接输出密钥、token。
- **集中收集**：若接入 ELK/Loki，注意建立安全传输通道；对外部系统仅保留必要字段。
- **告警机制**：针对连续失败的登录、插件异常、节点掉线、情绪危机等事件建立告警，及时提醒运维者或家庭成员。

## 8.6 配置与变更管理
- **配置快照**：RuntimeConfigService 在写入前创建备份；如需回滚可直接恢复。
- **变更审计**：通过审计日志记录是谁在何时修改了何种配置。
- **灰度发布**：对高风险配置（插件权限、主动调度频率）先在测试环境验证，再逐步推广。

## 8.7 常见安全防线
1. **最小权限原则**：节点、插件、用户均只授予必要权限。
2. **双因子保护**：管理后台或远程访问加入 2FA，提高安全性。
3. **网络隔离**：推荐使用防火墙或 VLAN 把 Hub 与家庭设备隔离，防止外部恶意访问。
4. **备份与恢复演练**：确保在数据损坏或设备故障时可以快速恢复。
5. **定期更新依赖**：跟进安全公告，升级依赖库并验证兼容性。

通过以上策略，Apex Bridge 能够在保持开放性的同时，确保家庭数据、插件执行与分布式节点的安全可靠。

