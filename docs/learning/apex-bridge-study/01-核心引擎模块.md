# 01 - 核心引擎模块

核心引擎层是 Apex Bridge 运作的心脏。它负责在用户请求、人格风格、记忆结果、插件执行和主动事件之间建立有机联系，确保输出既符合语境，又具备情感温度与行动能力。该层由 VCPEngine、LLMClient、PluginRuntime、PersonalityEngine、EmotionEngine、TriggerHub 等组件构成。

## 1.1 VCPEngine：会话与协议编排中枢
**源码位置**：`src/core/VCPEngine.ts`

- **上下文总线**：负责在每个会话中汇总系统提示、人设片段、历史对话、记忆检索结果与实时变量；控制 token 预算，将关键上下文放在前排，避免无关信息占据模型上下文。
- **变量解析**：调用 VariableEngine，把 `{{namespace:key}}` 形式的占位符转换成实时值，例如时间 (`time:now`)、节点状态 (`node:status`)、RAG 结果 (`rag:diary:...`) 等。新增变量只需实现对应 Provider。
- **工具调度**：识别模型返回的函数调用指令，协调 PluginRuntime 执行插件。支持同步和异步任务，异步任务在 `AsyncResultCleanupService` 的帮助下维护生命周期。
- **策略守护**：结合 PolicyGuard、QuotaManager 拦截高危行为（删除文件、频繁外呼）、控制频率，并在异常时生成友好提示。
- **事件广播**：通过 TriggerHub 将 `conversation.start`、`plugin.beforeExecute`、`conversation.end` 等事件分发给主动系统或外部监听者。

执行流程示意：
```
ChatController → ChatService → VCPEngine.handleChat()
  1) assembleContext()   # 拼装消息、人设、记忆
  2) callLLM()           # 调用 LLMClient 获取回复
  3) handleFunctionCall()# 若模型想执行工具，则交给 PluginRuntime
  4) 循环直至模型返回最终文本
  5) 触发 TriggerHub 事件、写日志、返回响应
```
VCPEngine 内部维护最大工具调用迭代次数和超时机制，防止死循环。变量注入遵循命名空间体系，便于扩展。

## 1.2 LLMClient：多供应商抽象层
**源码位置**：`src/core/LLMClient.ts`

- **接口统一**：向上暴露 `createCompletion()`、`streamCompletion()`，上层无需关注具体厂商差异。
- **Provider 适配**：读取 `.env` 中的 `LLM_PROVIDER`，路由到 DeepSeek、OpenAI、智谱、Ollama 等实现。支持同时配置主备模型以便降级。
- **超时与重试**：可配置最大重试次数、退避策略、超时阈值；流式模式可识别断流并重连。
- **负载与限流**：根据调用来源（Hub、Worker、Companion）应用不同模型或限流策略，避免节点滥用模型资源。
- **网络配置**：支持代理、证书、连接池等参数，适配家庭内网或企业环境。

工作链条：VCPEngine -> LLMClient -> 供应商 API -> LLMClient 统一封装 -> VCPEngine。所有 Provider 的输出都会转换为统一格式（包含 `content`、`tool_calls` 等字段），保证上层逻辑稳定。

## 1.3 PluginRuntime：插件执行生命周期
虽然 PluginRuntime 属于插件体系，但核心引擎需要理解其协作方式。

- **插件注册**：扫描 `plugins/`，解析 manifest（权限、资源限制、入口路径）。
- **执行模式**：Direct（同步返回）、Hybrid（异步任务）、Static（静态内容）；Hybrid 插件以 `taskId` 关联回调。
- **资源治理**：结合 PolicyGuard、QuotaManager 限制执行时间、内存、网络访问权限。
- **异常隔离**：统一捕获异常，记录结构化日志，并在需要时驱动 retry 或 fallback。

VCPEngine 根据模型返回的函数调用请求交给 PluginRuntime；执行结果会重新注入消息上下文，驱动下一轮模型生成。

## 1.4 PersonalityEngine：人设提示组装器
**源码位置**：`src/core/PersonalityEngine.ts`

- **配置解析**：读取 `data/config/personality/*.txt`，支持姓名、身份、口头禅、价值观、失败应对策略等字段。
- **Prompt 生成**：合成 System Prompt，嵌入角色语气、称呼、互动准则；支持不同节点加载不同人设。
- **动态调节**：结合 EmotionEngine 输出、记忆偏好、主动场景需求调整表达。例如在用户疲惫时使用更柔和的措辞。
- **多角色并存**: Hub、Worker、Companion 可分别加载不同人设，互不冲突。

示例人格片段：
```
你是“小悦”，定位为 AI 女儿，性格温柔善解人意，常用口头禅“好的呀”“记得休息”。
在提供建议前，要先表示理解，再给出步骤；遇到无把握的事情，应主动向用户确认。
```

## 1.5 EmotionEngine：情绪识别与反馈调优
**源码位置**：`src/core/EmotionEngine.ts`

- **情绪分类**：对用户输入进行情绪判断（happy / sad / angry / anxious / neutral 等），可根据部署选用本地模型或规则模板。
- **反馈调节**：输出情绪标签供 PersonalityEngine、ProactivityScheduler 使用，例如在悲伤情绪下自动启用安抚式文案。
- **记忆标注**：与 MemoryService 协作，把情绪写入记忆元数据，为未来对话或主动提醒提供依据。
- **告警触发**：当连续出现高危情绪或敏感词时，触发特定 Scene（如提醒休息、建议寻求帮助）。

## 1.6 TriggerHub 与 Scene 框架
**源码位置**：`src/core/TriggerHub.ts`, `src/core/scenes/`

TriggerHub 包装事件总线，Scene 则是在事件驱动下执行的业务脚本。

常见事件：`conversation.start`、`conversation.end`、`plugin.beforeExecute`、`plugin.afterExecute`、`emotion.detected`、`node.statusChange` 等。

Scene 案例：
- 早安播报：订阅 `conversation.start`，在早晨自动推送天气与待办。
- 生日祝福：监听日期与 `emotion.detected`，在特定日期发送祝福并建议庆祝活动。

## 1.7 典型调用序列
**场景**：“帮我整理今天的待办，并交给小文处理文件”。

1. ChatController 收到请求，交给 ChatService。
2. VCPEngine 汇总人设、记忆、变量；EmotionEngine 判断情绪。
3. LLMClient 返回需要调用 `list_tasks` 插件；VCPEngine 调用 PluginRuntime。
4. 插件返回待办清单后，VCPEngine 再次调用 LLMClient 生成总结。
5. TriggerHub 广播 `plugin.afterExecute`、`conversation.end`；ProactivityScheduler 决定是否安排后续提醒。
6. ChatService 发送最终回复，并记录请求日志、记忆片段。

## 1.8 性能与扩展考虑
- **缓存策略**：对高频变量和插件结果启用缓存（`utils/cache.ts`），减少重复调用。
- **限流与配额**：QuotaManager 防止节点或用户频繁请求冲垮系统。
- **可插拔性**：新增模型 Provider、人设模板、Trigger、Scene 均有明确扩展点，无需修改核心流程。
- **日志追踪**：request-id 贯穿整个调用链，便于分析对话与工具调用的执行细节。

核心引擎层确保 Apex Bridge 能够在“人格、记忆、工具”三位一体的前提下交付稳定且具备情感色彩的对话体验，是继续理解服务层、记忆系统与节点生态的基础。


