# 12 - 节点部署实践

Worker 与 Companion 节点让 Apex Bridge 的能力从单机扩展到分布式环境。本章节总结节点运行时结构、部署流程、配置要点以及常见故障排查方法。

## 12.1 节点运行时结构
- **代码位置**：`packages/node-agent/`，采用 TypeScript 编写，内置 WebSocket 客户端、任务执行器、插件桥接器。
- **启动入口**：`src/index.ts`，读取 `.env` 配置，初始化人格、能力、插件清单后连接 Hub。
- **依赖管理**：节点可复用主项目依赖或单独安装；若插件依赖额外包，需在节点环境安装。
- **日志**：节点生成本地日志文件，并能通过 WebSocket 向 Hub 推送关键日志片段。

## 12.2 部署步骤
1. **准备环境**：安装 Node.js 18+，创建运行目录，复制或拉取 `packages/node-agent`。
2. **配置 `.env`**：关键项包括：
   - `HUB_URL`：Hub 的 WebSocket 地址，例如 `ws://192.168.1.10:8088/ws`；
   - `WS_TOKEN`：与 Hub 配对的鉴权 token；
   - `NODE_ID`：节点唯一标识，如 `worker-file-001`；
   - `NODE_TYPE`：`worker` 或 `companion`；
   - `PERSONALITY_FILE`：指向人格档案；
   - `NODE_CAPABILITIES`：JSON 数组，声明可提供的功能（如 `"FileSearch"`、`"BudgetReport"`）；
   - 插件或本地模型路径等自定义项。
3. **启动 Hub**：在主机上执行 `npm run dev` 或 `npm start`，确认 `/health` 正常。
4. **启动节点**：在节点目录运行 `npm install`（首次）、`npm run start`；观察日志确保成功与 Hub 建立连接。
5. **验证注册**：在管理后台或 `GET /v1/nodes` 查看新节点是否在线、能力是否正确。
6. **配置守护**：使用 `pm2`、`systemd`、`Supervisor` 等工具把节点进程常驻运行，并设置自动重启。

## 12.3 配置组织与人格定制
- **人格文件**：通常与 Hub 共用 `data/config/personality/`；节点可加载本地副本，以防网络中断。
- **能力清单**：与插件 manifest 配合，确保 Hub 能正确派发任务；NodeService 会把能力信息写入 `data/config/nodes/`。
- **环境隔离**：若节点需要访问本地硬件（NAS、打印机），应在配置中声明路径和权限，Hub 不直接访问节点资源。
- **安全参数**：为每个节点分配独立 token；远程部署时使用 TLS 或 VPN 保护连接。

## 12.4 常见问题与排查
| 问题场景 | 排查步骤 |
|---------|----------|
| 无法连接 Hub | 检查 `HUB_URL` 是否正确、Hub 端口是否开放、token 是否匹配；使用 `wscat` 或浏览器测试连接；查看 Hub 日志中的拒绝原因。 |
| 心跳异常或状态不更新 | 确认节点时钟同步；检查心跳发送间隔配置；查看网络是否间歇性断开；验证 Hub 日志是否收到 `heartbeat`。 |
| 任务执行卡住 | 查看节点插件依赖是否安装、异步任务是否正确回调；检查 `async_results/` 是否落盘；必要时手动清理任务缓存并重启节点。 |
| 能力未生效 | 核对 `NODE_CAPABILITIES` 是否为合法 JSON；确认插件manifest 已启用；重启 Hub 强制刷新缓存。 |
| 资源占用过高 | 监控节点 CPU/内存，限制插件并发；在 manifest 中调整 `maxExecutionTime` 和 `maxConcurrency`；必要时拆分任务或迁移到性能更好的设备。 |

## 12.5 多节点拓扑建议
- **家庭场景**：1 个 Hub + 若干 Worker（文件、记账、影音）+ 1 个 Companion（情感陪伴）。
- **组织场景**：可按部门或楼层划分节点，使用命名约定（`worker-finance-001`）。
- **高可用**：为关键任务配置冗余节点，Hub 在节点掉线时自动切换；可定期执行健康检查脚本，及时提醒维护。

## 12.6 运维最佳实践
- 建立节点部署手册，记录依赖、路径、守护进程配置。
- 使用脚本定期采集节点状态、资源占用、任务完成率，生成报表。
- 对于移动或公共网络部署，建议使用 WireGuard/ZeroTier 建立安全隧道。
- 当插件或节点更新时，先在测试节点验证，再逐步推广到生产节点。

节点生态使 Apex Bridge 得以扩展到多设备协同，各节点通过统一协议与 Hub 通信，实现专业分工与家庭成员角色化体验。

