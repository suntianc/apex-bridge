# 需求讨论纪要：项目重构需求（试点 ConfigService）

**会议日期**: 2025-12-30
**讨论需求**: R-001 项目重构需求（试点 ConfigService）
**参与人员**: -
**记录状态**: 已评审

---

## 1. 讨论背景

ApexBridge 项目当前存在以下核心问题：
- 项目代码量过大，职责边界不清晰
- 存在大量冗余代码和重复实现
- 架构设计存在问题，模块间耦合度高
- 类型系统不够严谨，存在类型污染

## 2. 讨论要点

### 2.1 重构范围确定

**讨论内容**: 确定是整体架构重构还是模块级重构

**决策结果**: **试点重构**
- 先重构一个模块作为试点
- 验证重构方法后再推广
- 降低风险

### 2.2 核心问题确认

**讨论内容**: 当前项目最严重的问题是什么

**确认的问题**:
- [x] 冗余代码
- [x] 职责混乱
- [x] 架构问题
- [x] 类型系统

### 2.3 试点模块选择

**候选模块评估**:

| 模块 | 当前行数 | 问题数量 | 重构风险 | 推荐度 |
|------|----------|----------|----------|--------|
| ConfigService | 1050 | 15 | 低 | **高** |
| LLMManager | 330 | 5 | 低 | **高** |
| PlaybookMatcher | 1326 | 20 | 中 | 中 |
| ChatService | 1190 | 25 | 高 | 低 |

**决策结果**: **ConfigService** 作为试点模块

**选择理由**:
1. 问题明确且风险可控
2. 相对独立，依赖较少
3. 1050 行文件可拆分为 7 个小文件
4. 便于建立重构标准

### 2.4 兼容性要求

**讨论内容**: 重构过程中对现有 API 兼容性的要求

**决策结果**: **必须兼容**
- 保持现有 API 和数据格式完全不变
- 提供类型别名兼容层
- 单例模式访问方式保持不变

### 2.5 架构变更确认

**讨论内容**: 是否需要进行整体架构变更

**决策结果**: **不进行整体架构变更**
- 保持当前架构层次（core/services/strategies/api）
- 仅在 services/ 下新增 config/ 子目录
- 避免大规模迁移风险

## 3. 关键决策

| 决策项 | 决策 | 理由 |
|--------|------|------|
| 重构范围 | 试点重构 | 降低风险，验证方法 |
| 试点模块 | ConfigService | 问题明确，风险可控 |
| 兼容性 | 必须兼容 API | 保障业务稳定 |
| 架构变更 | 不变更 | 保持简单，避免风险 |
| 重构目标 | 1050行 → 7文件 | 单一职责原则 |

## 4. 验收标准确认

### 4.1 代码质量标准

- [ ] 单个文件不超过 500 行
- [ ] 消除所有 `any` 类型（除非外部接口要求）
- [ ] 启用 `strictNullChecks`
- [ ] 启用 `noImplicitAny`

### 4.2 功能验收标准

- [ ] 配置加载功能正常
- [ ] 配置验证功能正常
- [ ] 配置写入功能正常
- [ ] 配置热更新正常
- [ ] 速率限制功能正常

### 4.3 API 兼容性

- [ ] `GET /api/config` 返回正确格式
- [ ] `POST /api/config` 接受正确格式
- [ ] `PUT /api/config/:id` 更新正常
- [ ] 配置变更后服务正常运行

### 4.4 测试标准

- [ ] 单元测试覆盖率不低于 80%
- [ ] 集成测试覆盖所有 API 接口
- [ ] 重构前后功能行为一致

## 5. 分阶段计划

| 阶段 | 内容 | 预估工时 |
|------|------|----------|
| 阶段一 | 准备阶段（测试基准、依赖分析） | 1 周 |
| 阶段二 | 类型拆分（配置类型独立） | 1 周 |
| 阶段三 | 服务拆分（ConfigLoader/Validator/Writer） | 1 周 |
| 阶段四 | 兼容性与优化 | 1 周 |

## 6. 后续计划

ConfigService 重构完成后，推广经验至：
1. PlaybookMatcher (2周)
2. ChatService (3周)
3. UnifiedToolManager (2周)
4. 类型系统统一 (2周)

## 7. 风险与缓解措施

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 类型变更导致编译错误 | 中 | 低 | 提供类型别名兼容层 |
| 循环引用导致编译问题 | 中 | 低 | 仔细设计依赖关系 |
| API 行为不一致 | 高 | 低 | 完整的功能测试覆盖 |
| 性能下降 | 中 | 低 | 性能基准测试与优化 |
| 迁移过程复杂 | 中 | 中 | 分阶段迁移，每阶段验证 |

## 8. 关联文档

| 文档 | 路径 | 状态 |
|------|------|------|
| 需求清单 | `docs/requirements/01-project-refactoring.md` | ✅ 已评审 |
| 功能设计 | `docs/functionality-design/01-ConfigService-refactoring.md` | ✅ 已评审 |

## 9. 会议结论

本次讨论确定了项目重构的基本策略：
1. 以 ConfigService 为试点模块进行重构
2. 保持 API 和数据格式完全兼容
3. 不进行整体架构变更
4. 建立重构标准后推广至其他模块

---

**记录日期**: 2025-12-30
**状态**: 已评审
