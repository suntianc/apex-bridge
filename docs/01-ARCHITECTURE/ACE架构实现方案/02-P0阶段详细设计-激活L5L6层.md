# P0é˜¶æ®µè¯¦ç»†è®¾è®¡ï¼šæ¿€æ´»L5/L6å±‚ï¼ˆè®¤çŸ¥æ§åˆ¶ + ä»»åŠ¡æ‰§è¡Œï¼‰

## ğŸ“‹ é˜¶æ®µæ¦‚è¿°

**ç›®æ ‡**: å°†ReActStrategyçš„æ€è€ƒå¾ªç¯æ˜ å°„åˆ°ACEçš„L5ï¼ˆè®¤çŸ¥æ§åˆ¶ï¼‰å’ŒL6ï¼ˆä»»åŠ¡æ‰§è¡Œï¼‰ï¼Œå®ç°çŸ­æœŸè®°å¿†ä¸æ‰§è¡Œæœºåˆ¶ã€‚

**æ ¸å¿ƒä»·å€¼**:
- é™ä½ReActçš„ä¸Šä¸‹æ–‡æº¢å‡ºé£é™©
- æå‡å¤šè½®å¯¹è¯ç¨³å®šæ€§
- å»ºç«‹ACEå±‚çº§æ¶æ„åŸºç¡€

**é¢„è®¡å·¥æœŸ**: 1å‘¨ï¼ˆ5ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. âœ… **å®ç°Scratchpadæœºåˆ¶**ï¼ˆL5è®¤çŸ¥æ§åˆ¶å±‚ï¼‰
   - ç»´æŠ¤"å½“å‰ä»»åŠ¡"çš„èšç„¦ä¸Šä¸‹æ–‡
   - æ”¯æŒæ€è€ƒè¿‡ç¨‹è®°å½•å’Œå‹ç¼©

2. âœ… **é€‚é…å·¥å…·æ‰§è¡Œè®°å½•**ï¼ˆL6ä»»åŠ¡æ‰§è¡Œå±‚ï¼‰
   - ç»Ÿä¸€è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨å’Œç»“æœ
   - é€‚é…é¡¹ç›®æ ‡å‡†çš„ToolResultæ ¼å¼

3. âœ… **ä»»åŠ¡å®Œç»“æ¸…æ´—æœºåˆ¶**
   - ä»»åŠ¡å®Œæˆåè‡ªåŠ¨å‹ç¼©å¹¶ä¸ŠæŠ¥åˆ°L4
   - æ¸…ç†L5çš„Scratchpadï¼Œé‡Šæ”¾å†…å­˜

4. âœ… **æœ¬åœ°åŒ–AceIntegratoræ‰©å±•**
   - ç§»é™¤å¯¹AceServiceçš„ä¾èµ–
   - å®ç°å±‚çº§é€šä¿¡æœºåˆ¶

---

## ğŸ” å½“å‰é¡¹ç›®é€»è¾‘åˆ†æ

### 1. ReActStrategyç°çŠ¶åˆ†æ

**ä½ç½®**: `src/strategies/ReActStrategy.ts`

**å½“å‰å·¥å…·è°ƒç”¨æµç¨‹**:
```typescript
// ç°æœ‰æµç¨‹
initializeToolSystem() â†’
  â”œâ”€ builtInRegistry.listAllTools() // å†…ç½®å·¥å…·
  â””â”€ toolRetrievalService.findRelevantSkills() // æ£€ç´¢Skills

execute() â†’
  â”œâ”€ ReActEngine.execute()
  â”œâ”€ toolExecutor.executeAll() // æ‰§è¡Œå·¥å…·
  â””â”€ aceIntegrator.saveTrajectory() // è®°å½•è½¨è¿¹
```

**é—®é¢˜è¯†åˆ«**:
- âŒ ç¼ºå°‘Scratchpadæœºåˆ¶
- âŒ æ²¡æœ‰L5æ€è€ƒè¿‡ç¨‹åˆ†å±‚è®°å½•
- âŒ å·¥å…·æ‰§è¡Œç»“æœæœªè¯¦ç»†è®°å½•åˆ°L6
- âŒ AceIntegratorä¾èµ–AceService

### 2. AceIntegratorç°çŠ¶åˆ†æ

**ä½ç½®**: `src/services/AceIntegrator.ts`

**å½“å‰æ¥å£**:
```typescript
interface AceIntegrator {
  // è½¨è¿¹ä¿å­˜
  saveTrajectory(params: TrajectoryParams): Promise<void>

  // ä¼šè¯ç®¡ç†
  updateSessionActivity(sessionId?: string): Promise<void>

  // æ¶ˆæ¯å‘å¸ƒ
  publishWithSession(sessionId, content, layer): Promise<void>
}
```

**é—®é¢˜è¯†åˆ«**:
- âŒ ç›´æ¥ä¾èµ–AceService.getEngine()
- âŒ æ²¡æœ‰æœ¬åœ°Scratchpadå­˜å‚¨
- âŒ ç¼ºå°‘å±‚çº§é€šä¿¡æ–¹æ³•
- âŒ ç¼ºå°‘ä»»åŠ¡å®Œç»“æ¸…æ´—æ¥å£

### 3. å·¥å…·æ‰§è¡Œç»“æœæ ¼å¼åˆ†æ

**å½“å‰ToolResultæ ¼å¼** (`src/types/tool-system.ts`):
```typescript
interface ToolResult {
  success: boolean;
  output?: any;
  error?: string;
  duration?: number;
  exitCode?: number;
}
```

**ACEæœŸæœ›æ ¼å¼**:
```typescript
interface Observation {
  layer: string;           // L6
  observation: {
    success: boolean;
    output: any;
    error?: any;
    duration?: number;
    exitCode?: number;
  };
  timestamp: number;
}
```

**é€‚é…ç‚¹**: âœ… æ ¼å¼é«˜åº¦ä¸€è‡´ï¼Œå¯ç›´æ¥æ˜ å°„

---

## ğŸ—ï¸ è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: AceIntegratoræœ¬åœ°åŒ–æ‰©å±•

#### 1.1 æ–°å¢æœ¬åœ°å­˜å‚¨

```typescript
// src/services/AceIntegrator.ts æ‰©å±•

export class AceIntegrator {
  // âœ… ä¿æŒç°æœ‰AceServiceä¾èµ–ï¼ˆå‘åå…¼å®¹ï¼‰
  constructor(private aceService: AceService) {}

  // ğŸ†• æœ¬åœ°Scratchpadå­˜å‚¨ï¼ˆæ›¿ä»£ace-engine-core MemoryStorageï¼‰
  private scratchpads: Map<string, Map<string, string>> = new Map();
  // ç»“æ„: sessionId -> layerId -> content

  // ğŸ†• æœ¬åœ°äº‹ä»¶æ€»çº¿ï¼ˆæ›¿ä»£ace-engine-core BusManagerï¼‰
  private bus = {
    northbound: new EventEmitter(), // ä¸ŠæŠ¥äº‹ä»¶
    southbound: new EventEmitter()  // ä¸‹è¾¾æŒ‡ä»¤
  };
}
```

**è®¾è®¡è¦ç‚¹**:
- ä½¿ç”¨Mapæ¨¡æ‹ŸMemoryStorageï¼Œé¿å…å¤–éƒ¨ä¾èµ–
- ä¿æŒAceServiceä¾èµ–ï¼ˆP4é˜¶æ®µç§»é™¤ï¼‰
- EventEmitterå®ç°äº‹ä»¶é€šä¿¡

#### 1.2 æ–°å¢å±‚çº§é€šä¿¡æ¥å£

```typescript
// ğŸ†• å‘æŒ‡å®šå±‚çº§å‘é€æ¶ˆæ¯ï¼ˆå—å‘ï¼‰
async sendToLayer(
  layerId: string,
  packet: { content?: string; type?: string; metadata?: any }
): Promise<void> {
  const message = {
    targetLayer: layerId,
    content: packet.content || '',
    type: packet.type || 'DIRECTIVE',
    metadata: packet.metadata || {},
    timestamp: Date.now()
  };

  // å—å‘æ¶ˆæ¯ï¼šEXTERNAL -> ACEå±‚çº§
  this.bus.southbound.emit('message', message);

  // åŒæ—¶è®°å½•åˆ°Scratchpadï¼ˆç”¨äºè°ƒè¯•ï¼‰
  if (this.scratchpads.has(layerId)) {
    const layerScratchpad = this.scratchpads.get(layerId)!;
    const existing = layerScratchpad.get('COMMUNICATION_LOG') || '';
    layerScratchpad.set('COMMUNICATION_LOG',
      existing + `\n[${new Date().toISOString()}] OUT: ${packet.content}`
    );
  }
}

// ğŸ†• ç›‘å¬æ¥è‡ªå±‚çº§çš„äº‹ä»¶ï¼ˆåŒ—å‘ï¼‰
onMessageFromLayer(layerId: string, callback: (message: any) => void): void {
  this.bus.northbound.on(layerId, callback);
}
```

#### 1.3 æ–°å¢Scratchpadç®¡ç†

```typescript
// ğŸ†• è®°å½•L5çš„æ€è€ƒè¿‡ç¨‹
async recordThought(sessionId: string, thought: {
  content: string;
  reasoning: string
}): Promise<void> {
  const sessionScratchpads = this.scratchpads.get(sessionId) || new Map();
  const existing = sessionScratchpads.get('COGNITIVE_CONTROL') || '';
  sessionScratchpads.set('COGNITIVE_CONTROL',
    existing + `\n[Thought] ${thought.reasoning}\n[Action] ${thought.content}`
  );
  this.scratchpads.set(sessionId, sessionScratchpads);
}

// ğŸ†• è·å–Scratchpadå†…å®¹
async getScratchpad(sessionId: string, layerId: string): Promise<string> {
  return this.scratchpads.get(sessionId)?.get(layerId) || '';
}

// ğŸ†• æ¸…ç©ºScratchpad
async clearScratchpad(sessionId: string, layerId: string): Promise<void> {
  this.scratchpads.get(sessionId)?.delete(layerId);
}
```

#### 1.4 æ–°å¢å·¥å…·æ‰§è¡Œè®°å½•

```typescript
// ğŸ†• L6å·¥å…·æ‰§è¡Œè®°å½•ï¼ˆé€‚é…å½“å‰é¡¹ç›®å·¥å…·è°ƒç”¨æ ¼å¼ï¼‰
async recordAction(sessionId: string, action: {
  layer: string;
  action: string;
  payload: any
}): Promise<void> {
  await this.recordTrajectory({
    sessionId,
    layerId: action.layer,
    eventType: 'ACTION',
    content: JSON.stringify(action.payload),
    metadata: { actionType: action.action }
  });
}

// ğŸ†• L6è§‚å¯Ÿç»“æœè®°å½•ï¼ˆé€‚é… ToolResult æ ¼å¼ï¼‰
async recordObservation(sessionId: string, obs: {
  layer: string;
  observation: {
    success: boolean;
    output: any;
    error?: any;
    duration?: number;
    exitCode?: number
  };
  timestamp: number
}): Promise<void> {
  const content = obs.observation.success
    ? JSON.stringify({ success: true, output: obs.observation.output })
    : JSON.stringify({ success: false, error: obs.observation.error });

  await this.recordTrajectory({
    sessionId,
    layerId: obs.layer,
    eventType: 'OBSERVATION',
    content,
    metadata: {
      timestamp: obs.timestamp,
      duration: obs.observation.duration,
      exitCode: obs.observation.exitCode
    }
  });
}
```

#### 1.5 æ–°å¢ä»»åŠ¡å®Œç»“æ¸…æ´—

```typescript
// ğŸ†• ä»»åŠ¡å®Œæˆä¸ŠæŠ¥ï¼ˆè§¦å‘L5 â†’ L4çš„ä¸Šä¸‹æ–‡å‹ç¼©ï¼‰
async completeTask(
  sessionId: string,
  summary: { summary: string; outcome: string }
): Promise<void> {
  // 1. ä»L5çš„Scratchpadæå–å®Œæ•´æ€è€ƒè¿‡ç¨‹
  const scratchpad = this.scratchpads.get(sessionId)?.get('COGNITIVE_CONTROL') || '';

  // 2. å‹ç¼©ä¸ºæ‘˜è¦ï¼ˆé€’å½’æ‘˜è¦ï¼‰
  const compressed = await this.compressThoughts(scratchpad);

  // 3. ä¸ŠæŠ¥åˆ°L4ï¼ˆå¾…P1é˜¶æ®µå®ç°ï¼‰
  await this.sendToLayer('EXECUTIVE_FUNCTION', {
    type: 'STATUS_UPDATE',
    content: `Task completed: ${summary.summary}\nOutcome: ${summary.outcome}\nDetails: ${compressed}`
  });

  // 4. æ¸…ç©ºL5çš„Scratchpadï¼ˆå…³é”®ï¼šé‡Šæ”¾å†…å­˜ï¼‰
  this.scratchpads.get(sessionId)?.delete('COGNITIVE_CONTROL');

  logger.info(`[AceIntegrator] Task completed and L5 scratchpad cleared for session: ${sessionId}`);
}

// ğŸ†• é€’å½’æ‘˜è¦ç®—æ³•ï¼ˆä½¿ç”¨é¡¹ç›®ç°æœ‰çš„LLMManagerï¼‰
private async compressThoughts(scratchpad: string): Promise<string> {
  if (scratchpad.length < 500) return scratchpad;

  try {
    // ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„LLMManagerè¿›è¡Œæ‘˜è¦
    const response = await this.llmManager.chat([{
      role: 'user',
      content: `Summarize the following reasoning process into 2-3 sentences:\n\n${scratchpad}`
    }], { stream: false });

    return response.choices[0]?.message?.content || scratchpad;
  } catch (error) {
    logger.warn('[AceIntegrator] Failed to compress thoughts, using original text');
    return scratchpad;
  }
}
```

**æ³¨æ„**: éœ€è¦æ³¨å…¥LLMManagerä¾èµ–

---

### æ–¹æ¡ˆ2: ReActStrategyå¢å¼º

#### 2.1 é›†æˆAceIntegratoræ‰©å±•æ¥å£

**ä½ç½®**: `src/strategies/ReActStrategy.ts`

**ä¿®æ”¹ä½ç½®1**: æ„é€ å‡½æ•°
```typescript
export class ReActStrategy {
  constructor(
    private llmManager: LLMManager,
    private aceIntegrator: AceIntegrator, // ğŸ†• æ‰©å±•æ¥å£
    private historyService: ConversationHistoryService
  ) {
    // ... ç°æœ‰ä»£ç 
  }
}
```

**ä¿®æ”¹ä½ç½®2**: executeæ–¹æ³•ä¸­çš„è½¨è¿¹è®°å½•
```typescript
// ç°æœ‰ä»£ç 
if (options.sessionId && this.aceIntegrator.isEnabled()) {
  await this.aceIntegrator.saveTrajectory({
    requestId: options.requestId || `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    sessionId: options.sessionId,
    messages: messages,
    finalContent: finalContent,
    thinkingProcess: thinkingProcess,
    iterations: iterations,
    isReAct: true
  });
}

// ğŸ†• æ–°å¢ï¼šL5æ€è€ƒè¿‡ç¨‹è®°å½•
if (options.sessionId && this.aceIntegrator.isEnabled() && thinkingProcess.length > 0) {
  const lastThought = thinkingProcess[thinkingProcess.length - 1];
  await this.aceIntegrator.recordThought(options.sessionId, {
    content: finalContent,
    reasoning: lastThought
  });
}
```

**ä¿®æ”¹ä½ç½®3**: å·¥å…·æ‰§è¡Œç»“æœè®°å½•
```typescript
// åœ¨å·¥å…·æ‰§è¡Œåæ·»åŠ ï¼ˆL6è§‚å¯Ÿè®°å½•ï¼‰
for (const [call, result] of results.entries()) {
  // ç°æœ‰ä»£ç ...

  // ğŸ†• L6è§‚å¯Ÿç»“æœè®°å½•
  if (options.sessionId && this.aceIntegrator.isEnabled()) {
    await this.aceIntegrator.recordObservation(options.sessionId, {
      layer: 'TASK_EXECUTION',
      observation: {
        success: result.result.success,
        output: result.result.output,
        error: result.result.error,
        duration: result.result.duration,
        exitCode: result.result.exitCode
      },
      timestamp: Date.now()
    });
  }
}
```

**ä¿®æ”¹ä½ç½®4**: ä»»åŠ¡å®Œæˆåæ¸…ç†
```typescript
// ğŸ†• åœ¨executeæ–¹æ³•æœ«å°¾æ·»åŠ 
if (options.sessionId && this.aceIntegrator.isEnabled()) {
  await this.aceIntegrator.completeTask(options.sessionId, {
    summary: `Task completed in ${iterations} iterations`,
    outcome: finalContent ? 'success' : 'partial'
  });
}
```

#### 2.2 Scratchpadä¸Šä¸‹æ–‡ç®¡ç†

**æ–°å¢æ–¹æ³•**: ç»´æŠ¤L5ä¸Šä¸‹æ–‡çª—å£
```typescript
// ğŸ†• L5ä¸Šä¸‹æ–‡ç®¡ç†ï¼šç»´æŠ¤"å½“å‰ä»»åŠ¡"çš„èšç„¦ä¸Šä¸‹æ–‡
private async manageL5Context(
  sessionId: string,
  currentMessages: Message[],
  options: ChatOptions
): Promise<void> {
  // é™åˆ¶L5ä¸Šä¸‹æ–‡çª—å£ï¼šæœ€è¿‘3è½®å¯¹è¯
  const recentMessages = currentMessages.slice(-6); // user+assistantå¯¹

  if (this.aceIntegrator.isEnabled()) {
    const contextSummary = recentMessages
      .map(m => `${m.role}: ${m.content.substring(0, 100)}`)
      .join('\n');

    // è®°å½•åˆ°L5 Scratchpad
    await this.aceIntegrator.sendToLayer('COGNITIVE_CONTROL', {
      type: 'CONTEXT_UPDATE',
      content: `Current task context:\n${contextSummary}`,
      metadata: {
        messageCount: recentMessages.length,
        timestamp: Date.now()
      }
    });
  }
}
```

---

### æ–¹æ¡ˆ3: ChatServiceé›†æˆè°ƒæ•´

#### 3.1 ä¼ é€’sessionIdåˆ°ReActStrategy

**ä½ç½®**: `src/services/ChatService.ts`

**ä¿®æ”¹**: ç¡®ä¿sessionIdä¼ é€’
```typescript
// åœ¨chatæ–¹æ³•ä¸­
async chat(messages: Message[], options: ChatOptions): Promise<ChatResult> {
  // ğŸ†• ç¡®ä¿æœ‰sessionIdï¼ˆACEåŠŸèƒ½éœ€è¦ï¼‰
  if (options.selfThinking?.enabled && !options.sessionId) {
    options.sessionId = `ace_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    logger.debug('[ChatService] Generated sessionId for ACE:', options.sessionId);
  }

  const strategy = this.selectStrategy(options);
  const result = await strategy.execute(messages, options);

  // ğŸ†• ç¡®ä¿è½¨è¿¹ä¿å­˜ï¼ˆå¦‚æœç­–ç•¥æ²¡æœ‰è°ƒç”¨ï¼‰
  if (options.sessionId && this.aceIntegrator.isEnabled() && !options.selfThinking?.enabled) {
    await this.aceIntegrator.updateSessionActivity(options.sessionId);
  }

  return result;
}
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### Step 1: æ‰©å±•AceIntegratoræ¥å£ (Day 1)

**ä»»åŠ¡æ¸…å•**:
- [ ] æ·»åŠ scratchpadså’Œbusæˆå‘˜å˜é‡
- [ ] å®ç°sendToLayeræ–¹æ³•
- [ ] å®ç°onMessageFromLayeræ–¹æ³•
- [ ] å®ç°recordThoughtæ–¹æ³•
- [ ] å®ç°recordActionå’ŒrecordObservationæ–¹æ³•
- [ ] å®ç°completeTaskæ–¹æ³•
- [ ] å®ç°compressThoughtsæ–¹æ³•

**ä»£ç æ–‡ä»¶**:
- `src/services/AceIntegrator.ts` (æ‰©å±•)

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æ–°æ–¹æ³•é€šè¿‡å•å…ƒæµ‹è¯•
- [ ] ä¿æŒå‘åå…¼å®¹ï¼ˆAceServiceä¾èµ–æœªç§»é™¤ï¼‰
- [ ] ç°æœ‰è½¨è¿¹ä¿å­˜åŠŸèƒ½æ­£å¸¸

### Step 2: é›†æˆåˆ°ReActStrategy (Day 2-3)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹æ„é€ å‡½æ•°ï¼Œæ³¨å…¥AceIntegrator
- [ ] åœ¨executeæ–¹æ³•ä¸­æ·»åŠ L5æ€è€ƒè®°å½•
- [ ] åœ¨å·¥å…·æ‰§è¡Œåæ·»åŠ L6è§‚å¯Ÿè®°å½•
- [ ] åœ¨ä»»åŠ¡å®Œæˆåæ·»åŠ æ¸…ç†é€»è¾‘
- [ ] å®ç°L5ä¸Šä¸‹æ–‡ç®¡ç†

**ä»£ç æ–‡ä»¶**:
- `src/strategies/ReActStrategy.ts` (ä¿®æ”¹)

**éªŒæ”¶æ ‡å‡†**:
- [ ] ReActåŠŸèƒ½æ­£å¸¸ï¼ˆç°æœ‰æµ‹è¯•é€šè¿‡ï¼‰
- [ ] Scratchpadæ­£ç¡®è®°å½•å’Œæ¸…ç†
- [ ] å·¥å…·æ‰§è¡Œç»“æœæ­£ç¡®è®°å½•

### Step 3: è°ƒæ•´ChatService (Day 4)

**ä»»åŠ¡æ¸…å•**:
- [ ] ç¡®ä¿sessionIdä¼ é€’åˆ°ReActStrategy
- [ ] æ·»åŠ sessionIdè‡ªåŠ¨ç”Ÿæˆé€»è¾‘
- [ ] æ›´æ–°ä¼šè¯æ´»åŠ¨æ—¶é—´è®°å½•

**ä»£ç æ–‡ä»¶**:
- `src/services/ChatService.ts` (ä¿®æ”¹)

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰chatæ¥å£æ­£å¸¸å·¥ä½œ
- [ ] sessionIdæ­£ç¡®ç”Ÿæˆå’Œä¼ é€’

### Step 4: æµ‹è¯•éªŒè¯ (Day 5)

**æµ‹è¯•åœºæ™¯**:
- [ ] ç®€å•å¯¹è¯æµ‹è¯•ï¼ˆæ— å·¥å…·è°ƒç”¨ï¼‰
- [ ] ReActå·¥å…·è°ƒç”¨æµ‹è¯•ï¼ˆå•ä¸ªå·¥å…·ï¼‰
- [ ] å¤šè½®å¯¹è¯æµ‹è¯•ï¼ˆä¸Šä¸‹æ–‡ä¿æŒï¼‰
- [ ] é•¿æ—¶é—´ä¼šè¯æµ‹è¯•ï¼ˆå†…å­˜æ¸…ç†ï¼‰
- [ ] é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆå·¥å…·æ‰§è¡Œå¤±è´¥ï¼‰

**æ€§èƒ½æµ‹è¯•**:
- [ ] å†…å­˜ä½¿ç”¨ç›‘æ§ï¼ˆScratchpadå¤§å°ï¼‰
- [ ] å“åº”æ—¶é—´æµ‹è¯•ï¼ˆå»¶è¿Ÿå¢åŠ  < 100msï¼‰
- [ ] å¹¶å‘ä¼šè¯æµ‹è¯•ï¼ˆ10+ä¼šè¯åŒæ—¶è¿›è¡Œï¼‰

---

## ğŸ”§ å…³é”®ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1: å®Œæ•´çš„æ–°AceIntegratoræ¥å£

```typescript
// src/services/AceIntegrator.ts çš„æ‰©å±•éƒ¨åˆ†
export class AceIntegrator {
  // ... ç°æœ‰ä»£ç  ...

  // ========== ğŸ†• P0é˜¶æ®µæ–°å¢ ==========

  // æœ¬åœ°Scratchpadå­˜å‚¨
  private scratchpads: Map<string, Map<string, string>> = new Map();
  private bus = {
    northbound: new EventEmitter(),
    southbound: new EventEmitter()
  };

  async sendToLayer(layerId: string, packet: {
    content?: string;
    type?: string;
    metadata?: any
  }): Promise<void> {
    const message = {
      targetLayer: layerId,
      content: packet.content || '',
      type: packet.type || 'DIRECTIVE',
      metadata: packet.metadata || {},
      timestamp: Date.now()
    };

    this.bus.southbound.emit('message', message);

    // è®°å½•åˆ°Scratchpad
    if (this.scratchpads.has(layerId)) {
      const layerScratchpad = this.scratchpads.get(layerId)!;
      const existing = layerScratchpad.get('COMMUNICATION_LOG') || '';
      layerScratchpad.set('COMMUNICATION_LOG',
        existing + `\n[${new Date().toISOString()}] OUT: ${packet.content}`
      );
    }

    logger.debug(`[AceIntegrator] Sent message to ${layerId}: ${packet.content}`);
  }

  onMessageFromLayer(layerId: string, callback: (message: any) => void): void {
    this.bus.northbound.on(layerId, callback);
  }

  async recordThought(sessionId: string, thought: {
    content: string;
    reasoning: string
  }): Promise<void> {
    const sessionScratchpads = this.scratchpads.get(sessionId) || new Map();
    const existing = sessionScratchpads.get('COGNITIVE_CONTROL') || '';
    sessionScratchpads.set('COGNITIVE_CONTROL',
      existing + `\n[Thought] ${thought.reasoning}\n[Action] ${thought.content}`
    );
    this.scratchpads.set(sessionId, sessionScratchpads);
  }

  async recordObservation(sessionId: string, obs: {
    layer: string;
    observation: {
      success: boolean;
      output: any;
      error?: any;
      duration?: number;
      exitCode?: number
    };
    timestamp: number
  }): Promise<void> {
    const content = obs.observation.success
      ? JSON.stringify({ success: true, output: obs.observation.output })
      : JSON.stringify({ success: false, error: obs.observation.error });

    await this.recordTrajectory({
      sessionId,
      layerId: obs.layer,
      eventType: 'OBSERVATION',
      content,
      metadata: {
        timestamp: obs.timestamp,
        duration: obs.observation.duration,
        exitCode: obs.observation.exitCode
      }
    });
  }

  async completeTask(sessionId: string, summary: {
    summary: string;
    outcome: string
  }): Promise<void> {
    const scratchpad = this.scratchpads.get(sessionId)?.get('COGNITIVE_CONTROL') || '';
    const compressed = await this.compressThoughts(scratchpad);

    await this.sendToLayer('EXECUTIVE_FUNCTION', {
      type: 'STATUS_UPDATE',
      content: `Task completed: ${summary.summary}\nOutcome: ${summary.outcome}\nDetails: ${compressed}`
    });

    // å…³é”®ï¼šæ¸…ç©ºL5 Scratchpad
    this.scratchpads.get(sessionId)?.delete('COGNITIVE_CONTROL');
    logger.info(`[AceIntegrator] Task completed and L5 scratchpad cleared for session: ${sessionId}`);
  }

  private async compressThoughts(scratchpad: string): Promise<string> {
    if (scratchpad.length < 500) return scratchpad;

    try {
      const response = await this.llmManager.chat([{
        role: 'user',
        content: `Summarize the following reasoning process into 2-3 sentences:\n\n${scratchpad}`
      }], { stream: false });

      return response.choices[0]?.message?.content || scratchpad;
    } catch (error) {
      logger.warn('[AceIntegrator] Failed to compress thoughts, using original text');
      return scratchpad;
    }
  }
}
```

### ç¤ºä¾‹2: ReActStrategyä¿®æ”¹

```typescript
// src/strategies/ReActStrategy.ts çš„å…³é”®ä¿®æ”¹
export class ReActStrategy {
  constructor(
    private llmManager: LLMManager,
    private aceIntegrator: AceIntegrator, // ğŸ†• ç¡®ä¿æ³¨å…¥
    private historyService: ConversationHistoryService
  ) {
    // ... ç°æœ‰ä»£ç  ...
  }

  async execute(messages: Message[], options: ChatOptions): Promise<ChatResult> {
    const startTime = Date.now();

    // ğŸ†• ç¡®ä¿æœ‰sessionIdï¼ˆACEåŠŸèƒ½éœ€è¦ï¼‰
    if (options.selfThinking?.enabled && !options.sessionId) {
      options.sessionId = `ace_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // ... ç°æœ‰ä»£ç  ...

    // âœ… ç°æœ‰è½¨è¿¹ä¿å­˜
    if (options.sessionId && this.aceIntegrator.isEnabled()) {
      await this.aceIntegrator.saveTrajectory({
        requestId: options.requestId || `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        sessionId: options.sessionId,
        messages: messages,
        finalContent: finalContent,
        thinkingProcess: thinkingProcess,
        iterations: iterations,
        isReAct: true
      });

      // ğŸ†• L5æ€è€ƒè¿‡ç¨‹è®°å½•
      if (thinkingProcess.length > 0) {
        const lastThought = thinkingProcess[thinkingProcess.length - 1];
        await this.aceIntegrator.recordThought(options.sessionId, {
          content: finalContent,
          reasoning: lastThought
        });
      }

      // ğŸ†• L6è§‚å¯Ÿç»“æœè®°å½•ï¼ˆå·¥å…·æ‰§è¡Œåï¼‰
      // è¿™éƒ¨åˆ†éœ€è¦åœ¨å·¥å…·æ‰§è¡Œå›è°ƒä¸­æ·»åŠ 
      // å‚è§ä¸‹é¢çš„toolExecutor.executeAllå›è°ƒä¿®æ”¹

      // ğŸ†• ä»»åŠ¡å®Œæˆåæ¸…ç†
      await this.aceIntegrator.completeTask(options.sessionId, {
        summary: `Task completed in ${iterations} iterations`,
        outcome: finalContent ? 'success' : 'partial'
      });
    }

    return {
      content: finalContent,
      iterations,
      thinkingProcess: includeThoughtsInResponse ? thinkingProcess.join('\n') : undefined,
      rawThinkingProcess: thinkingProcess,
      usage: undefined
    };
  }
}
```

---

## ğŸ“Š æ€§èƒ½ä¸å†…å­˜åˆ†æ

### Scratchpadå†…å­˜ä½¿ç”¨

**è®¡ç®—æ¨¡å‹**:
```typescript
// æ¯ä¸ªsessionçš„å†…å­˜å ç”¨
sessionMemory = {
  scratchpad: Map<string, string>, // å±‚çº§ -> å†…å®¹
  metadata: {
    createdAt: number,
    lastAccess: number,
    messageCount: number
  }
}

// å¹³å‡å¤§å°ä¼°ç®—
averageScratchpadSize = 10KB // åŒ…å«æ€è€ƒè¿‡ç¨‹å’Œä¸Šä¸‹æ–‡
maxSessions = 1000 // åŒæ—¶æ´»è·ƒä¼šè¯æ•°
totalMemory = 10KB * 1000 = 10MB
```

**å†…å­˜æ§åˆ¶ç­–ç•¥**:
1. **ä¼šè¯è¶…æ—¶**: 24å°æ—¶æœªæ´»è·ƒè‡ªåŠ¨æ¸…ç†
2. **ä»»åŠ¡æ¸…ç†**: ä»»åŠ¡å®Œæˆåç«‹å³æ¸…ç†L5 Scratchpad
3. **å¤§å°é™åˆ¶**: å•ä¸ªScratchpadè¶…è¿‡100KBæ—¶è‡ªåŠ¨å‹ç¼©

### å“åº”æ—¶é—´å½±å“

**æ–°å¢å»¶è¿Ÿ**:
- Scratchpadå†™å…¥: < 1ms
- L5è®°å½•: < 5ms
- L6è§‚å¯Ÿè®°å½•: < 2ms
- ä»»åŠ¡æ¸…ç†: < 10ms (åŒ…å«å‹ç¼©)

**æ€»ä½“å½±å“**: < 20ms per request âœ…

---

## âš ï¸ é£é™©ä¸ç¼“è§£

### é£é™©1: å†…å­˜æ³„æ¼
**åŸå› **: Scratchpadæœªæ­£ç¡®æ¸…ç†
**ç¼“è§£**:
- âœ… ä»»åŠ¡å®Œæˆåå¼ºåˆ¶æ¸…ç†L5
- âœ… ä¼šè¯è¶…æ—¶è‡ªåŠ¨æ¸…ç†
- âœ… å®šæœŸæ£€æŸ¥å¼‚å¸¸å¤§çš„Scratchpad

### é£é™©2: å“åº”å»¶è¿Ÿå¢åŠ 
**åŸå› **: æ–°å¢çš„è®°å½•å’Œå‹ç¼©æ“ä½œ
**ç¼“è§£**:
- âœ… å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
- âœ… å‹ç¼©æ“ä½œå»¶è¿Ÿåˆ°ä»»åŠ¡å®Œæˆå
- âœ… ç›‘æ§å“åº”æ—¶é—´æŒ‡æ ‡

### é£é™©3: å‘åå…¼å®¹æ€§
**åŸå› **: AceIntegratoræ¥å£å˜æ›´
**ç¼“è§£**:
- âœ… ä¿æŒæ‰€æœ‰ç°æœ‰æ–¹æ³•ä¸å˜
- âœ… æ–°å¢æ–¹æ³•ä¸å½±å“ç°æœ‰è°ƒç”¨
- âœ… å……åˆ†æµ‹è¯•ç°æœ‰åŠŸèƒ½

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ReActåŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼ˆç°æœ‰æµ‹è¯•100%é€šè¿‡ï¼‰
- [ ] Scratchpadæ­£ç¡®è®°å½•L5æ€è€ƒè¿‡ç¨‹
- [ ] å·¥å…·æ‰§è¡Œç»“æœæ­£ç¡®è®°å½•åˆ°L6
- [ ] ä»»åŠ¡å®ŒæˆåScratchpadæ­£ç¡®æ¸…ç†
- [ ] ä¼šè¯è¶…æ—¶è‡ªåŠ¨æ¸…ç†æœºåˆ¶æ­£å¸¸

### æ€§èƒ½éªŒæ”¶
- [ ] å“åº”æ—¶é—´å¢åŠ  < 20ms
- [ ] å†…å­˜ä½¿ç”¨å¢é•¿ < 10MB (1000ä¼šè¯)
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆ24å°æ—¶å‹åŠ›æµ‹è¯•ï¼‰

### å…¼å®¹æ€§éªŒæ”¶
- [ ] ç°æœ‰chatæ¥å£æ­£å¸¸å·¥ä½œ
- [ ] ç°æœ‰WebSocketæµå¼æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] ç°æœ‰å·¥å…·è°ƒç”¨åŠŸèƒ½æ­£å¸¸
- [ ] æ— AceServiceåŠŸèƒ½é€€åŒ–

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¸Šæ¸¸ä¾èµ–
- âœ… LLMManager - ç”¨äºå‹ç¼©æ€è€ƒè¿‡ç¨‹
- âœ… ReActEngine - å·¥å…·æ‰§è¡Œæµç¨‹
- âœ… ToolResultæ ¼å¼ - å·¥å…·æ‰§è¡Œç»“æœ

### ä¸‹æ¸¸ä¾èµ–ï¼ˆP1é˜¶æ®µï¼‰
- â³ AceStrategyOrchestrator - æ¥æ”¶L5ä¸ŠæŠ¥
- â³ L4æ‰§è¡ŒåŠŸèƒ½å±‚ - æ¥æ”¶ä»»åŠ¡å®Œæˆé€šçŸ¥

---

## ğŸ“š å‚è€ƒå®ç°

### ç›¸å…³æ–‡ä»¶
- `src/services/AceIntegrator.ts` - æ‰©å±•ä½ç½®
- `src/strategies/ReActStrategy.ts` - ä¿®æ”¹ä½ç½®
- `src/services/ChatService.ts` - è°ƒæ•´ä½ç½®
- `src/types/tool-system.ts` - ToolResultæ ¼å¼

### æµ‹è¯•æ–‡ä»¶
- `tests/unit/services/AceIntegrator.test.ts`
- `tests/unit/strategies/ReActStrategy.test.ts`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-12
**ä½œè€…**: Claude Code
**å®¡æ ¸**: å¾…å®¡æ ¸
