# M2.2 Phase 2 æµ‹è¯•æŒ‡å—

## æµ‹è¯•æ–¹å¼æ¦‚è§ˆ

M2.2 Phase 2 æä¾›äº†ä¸‰ç§æµ‹è¯•æ–¹å¼ï¼š
1. **å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•** - è‡ªåŠ¨åŒ–æµ‹è¯•
2. **æ‰‹åŠ¨APIæµ‹è¯•** - é€šè¿‡HTTP APIæµ‹è¯•
3. **WebSocketå®æ—¶æµ‹è¯•** - æµ‹è¯•æ¶ˆæ¯æ¨é€

---

## æ–¹å¼1ï¼šè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

### 1.1 è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd apex-bridge
npm test
```

### 1.2 è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
# æµ‹è¯•ProactivityScheduler Phase 2
npm test -- ProactivityScheduler.phase2.test

# æµ‹è¯•EvaluationEngineå¤šç»´åº¦è¯„åˆ†
npm test -- EvaluationEngine.test

# æµ‹è¯•TriggerHub
npm test -- TriggerHub.test

# æµ‹è¯•PolicyGuard
npm test -- PolicyGuard.test
```

### 1.3 ç›‘å¬æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰

```bash
npm run test:watch
```

### 1.4 ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

```bash
npm run test:coverage
```

---

## æ–¹å¼2ï¼šæ‰‹åŠ¨APIæµ‹è¯•

### 2.1 å¯åŠ¨æœåŠ¡å™¨

```bash
cd apex-bridge
npm run dev
```

æœåŠ¡å™¨é»˜è®¤è¿è¡Œåœ¨ `http://localhost:3000`

### 2.2 è·å–Admin Token

é¦–å…ˆéœ€è¦ç™»å½•è·å–tokenï¼š

```bash
# ç™»å½•ï¼ˆå¦‚æœè®¾ç½®äº†å¯†ç ï¼‰
curl -X POST http://localhost:3000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your_password"}'

# è¿”å›çš„tokenç”¨äºåç»­è¯·æ±‚
```

**æˆ–è€…ä½¿ç”¨æµ‹è¯•è„šæœ¬**ï¼ˆæ¨èï¼‰ï¼š

**Linux/Mac:**
```bash
# è®¾ç½®token
export ADMIN_TOKEN=your-admin-token-here

# è¿è¡Œæµ‹è¯•è„šæœ¬
bash tests/api-test.sh
```

**Windows PowerShell:**
```powershell
# è®¾ç½®token
$env:ADMIN_TOKEN = "your-admin-token-here"

# è¿è¡Œæµ‹è¯•è„šæœ¬
powershell -ExecutionPolicy Bypass -File tests/api-test.ps1
```

### 2.3 æ‰‹åŠ¨è§¦å‘åœºæ™¯

#### æµ‹è¯•ç”Ÿæ—¥æé†’åœºæ™¯

```bash
curl -X POST http://localhost:3000/api/admin/proactivity/trigger \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "sceneId": "birthday_reminder",
    "userId": "default"
  }'
```

#### æµ‹è¯•çºªå¿µæ—¥æé†’åœºæ™¯

```bash
curl -X POST http://localhost:3000/api/admin/proactivity/trigger \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "sceneId": "anniversary_reminder",
    "userId": "default"
  }'
```

#### æµ‹è¯•å…¶ä»–åœºæ™¯

```bash
# æ—©æ™¨é—®å€™
curl -X POST http://localhost:3000/api/admin/proactivity/trigger \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "sceneId": "morning_greeting",
    "userId": "default"
  }'

# æ™šä¸Šé—®å€™
curl -X POST http://localhost:3000/api/admin/proactivity/trigger \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "sceneId": "evening_greeting",
    "userId": "default"
  }'
```

### 2.4 æµ‹è¯•å…³ç³»ç®¡ç†API

#### åˆ›å»ºå¸¦ç”Ÿæ—¥çš„å…³ç³»ï¼ˆä¼šç«‹å³è§¦å‘æé†’ï¼‰

```bash
curl -X POST http://localhost:3000/api/admin/relationships \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "type": "family",
    "name": "æµ‹è¯•ç”¨æˆ·",
    "birthday": "2024-12-25"
  }'
```

#### æŸ¥çœ‹æ‰€æœ‰å…³ç³»

```bash
curl -X GET http://localhost:3000/api/admin/relationships \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

#### è·å–æé†’åˆ—è¡¨

```bash
curl -X GET http://localhost:3000/api/admin/relationships/reminders \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

---

## æ–¹å¼3ï¼šWebSocketå®æ—¶æµ‹è¯•

### 3.1 ä½¿ç”¨Postmanæµ‹è¯•WebSocket

1. **æ‰“å¼€Postman**ï¼Œåˆ›å»ºæ–°çš„WebSocketè¯·æ±‚

2. **è¿æ¥URL**ï¼ˆæ³¨æ„è·¯å¾„æ ¼å¼ï¼‰ï¼š
   ```
   ws://localhost:8088/ABPlog/VCP_Key=your-vcp-api-key
   # æˆ–å…¼å®¹è·¯å¾„: ws://localhost:8088/VCPlog/VCP_Key=your-vcp-api-key (å·²å¼ƒç”¨)
   ```
   
   **é‡è¦æç¤º**ï¼š
   - æ¨èè·¯å¾„æ˜¯ `/ABPlog/VCP_Key=` æˆ– `/log/VCP_Key=`
   - å…¼å®¹è·¯å¾„ `/VCPlog/VCP_Key=`ï¼ˆå·²å¼ƒç”¨ï¼Œå»ºè®®è¿ç§»ï¼‰
   - ç«¯å£æ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®ï¼ˆé»˜è®¤3000ï¼Œä½ ä½¿ç”¨çš„æ˜¯8088ï¼‰
   - API Keyç›´æ¥æ”¾åœ¨è·¯å¾„ä¸­ï¼Œä¸æ˜¯queryå‚æ•°

3. **è¿æ¥å**ï¼ŒæœåŠ¡å™¨ä¼šæ¨é€æ—¥å¿—æ¶ˆæ¯

4. **è§¦å‘åœºæ™¯**åï¼Œåº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„æ¶ˆæ¯ï¼š
   ```json
   {
     "type": "proactive_message",
     "timestamp": 1234567890,
     "data": {
       "sceneId": "birthday_reminder",
       "message": "ğŸ‚ æé†’æ‚¨ï¼šæµ‹è¯•ç”¨æˆ·çš„ç”Ÿæ—¥å¿«åˆ°äº†ï¼",
       "score": 0.98,
       "userId": "default",
       "personality": {...}
     }
   }
   ```

### 3.2 ä½¿ç”¨Node.jsè„šæœ¬æµ‹è¯•

é¡¹ç›®å·²æä¾›æµ‹è¯•è„šæœ¬ `tests/websocket-test.js`ï¼š

```bash
# è®¾ç½®API Keyï¼ˆä»é…ç½®æ–‡ä»¶ä¸­è·å–ï¼‰
export VCP_API_KEY=your-api-key-here

# è®¾ç½®ç«¯å£ï¼ˆå¦‚æœæœåŠ¡å™¨ä¸æ˜¯3000ç«¯å£ï¼‰
export PORT=8088

# è¿è¡Œæµ‹è¯•è„šæœ¬
node tests/websocket-test.js

# æˆ–è€…æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
VERBOSE=true node tests/websocket-test.js
```

**Windows PowerShell:**
```powershell
$env:VCP_API_KEY = "your-api-key-here"
$env:PORT = "8088"
node tests/websocket-test.js
```

è„šæœ¬åŠŸèƒ½ï¼š
- è‡ªåŠ¨è¿æ¥WebSocketï¼ˆæ¨èè·¯å¾„æ ¼å¼ï¼š`/ABPlog/VCP_Key=xxx` æˆ– `/log/VCP_Key=xxx`ï¼‰
- è¿‡æ»¤å¹¶æ˜¾ç¤ºä¸»åŠ¨æ¶ˆæ¯ï¼ˆ`proactive_message`ç±»å‹ï¼‰
- ç»Ÿè®¡æ¶ˆæ¯æ•°é‡
- æ˜¾ç¤ºè¿æ¥çŠ¶æ€

ç„¶ååœ¨å¦ä¸€ä¸ªç»ˆç«¯è§¦å‘åœºæ™¯ï¼Œè§‚å¯ŸWebSocketæ¶ˆæ¯ã€‚

---

## æ–¹å¼4ï¼šæµ‹è¯•äº‹ä»¶è§¦å‘

### 4.1 æµ‹è¯•memory:new_documentäº‹ä»¶

é€šè¿‡èŠå¤©APIåˆ›å»ºå¯¹è¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘æ–‡æ¡£åˆ†æåœºæ™¯ï¼š

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_VCP_API_KEY" \
  -d '{
    "message": "ä»Šå¤©å¤©æ°”çœŸå¥½",
    "userId": "test-user"
  }'
```

### 4.2 æµ‹è¯•emotion:negative_detectedäº‹ä»¶

å‘é€åŒ…å«è´Ÿé¢æƒ…ç»ªçš„æ¶ˆæ¯ï¼š

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_VCP_API_KEY" \
  -d '{
    "message": "æˆ‘ä»Šå¤©å¿ƒæƒ…å¾ˆä¸å¥½ï¼Œæ„Ÿè§‰å¾ˆæ²®ä¸§",
    "userId": "test-user"
  }'
```

---

## æ–¹å¼5ï¼šæµ‹è¯•çŠ¶æ€è§¦å‘

### 5.1 æµ‹è¯•é•¿æ—¶é—´æ— äº’åŠ¨åœºæ™¯

çŠ¶æ€è§¦å‘éœ€è¦ç­‰å¾…72å°æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ä»£ç ä¸´æ—¶é™ä½é˜ˆå€¼è¿›è¡Œæµ‹è¯•ï¼Œæˆ–è€…ï¼š

1. è®°å½•ç”¨æˆ·äº’åŠ¨æ—¶é—´ï¼ˆé€šè¿‡èŠå¤©APIï¼‰
2. ç­‰å¾…æˆ–ä¿®æ”¹ä»£ç ä¸­çš„é˜ˆå€¼
3. æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ£€æŸ¥

### 5.2 æµ‹è¯•è´Ÿå‘æƒ…ç»ªæŒç»­åœºæ™¯

ç±»ä¼¼åœ°ï¼Œéœ€è¦ç­‰å¾…48å°æ—¶ï¼Œæˆ–ä¿®æ”¹ä»£ç ä¸­çš„é˜ˆå€¼è¿›è¡Œæµ‹è¯•ã€‚

---

## æ–¹å¼6ï¼šæµ‹è¯•éšæœºè§¦å‘

éšæœºè§¦å‘ä½¿ç”¨æ³Šæ¾è¿‡ç¨‹ï¼Œå¹³å‡é—´éš”ä¸º4å°æ—¶ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•ï¼š

1. **ä¿®æ”¹é…ç½®**ï¼šä¸´æ—¶é™ä½å¹³å‡é—´éš”ï¼ˆä¿®æ”¹ `ProactivityScheduler.ts` ä¸­çš„ `RANDOM_TRIGGER_LAMBDA`ï¼‰
2. **è§‚å¯Ÿæ—¥å¿—**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰éšæœºè§¦å‘çš„äº‹ä»¶
3. **æ‰‹åŠ¨è§¦å‘**ï¼šä½¿ç”¨APIæ‰‹åŠ¨è§¦å‘randomç±»å‹çš„åœºæ™¯

---

## éªŒè¯æµ‹è¯•ç»“æœ

### æ£€æŸ¥æ—¥å¿—è¾“å‡º

æœåŠ¡å™¨æ—¥å¿—åº”è¯¥åŒ…å«ï¼š

```
âœ… Proactive message sent: birthday_reminder (score: 0.98)
ğŸ“¢ Proactive message pushed to WebSocket: birthday_reminder
```

### æ£€æŸ¥WebSocketæ¶ˆæ¯

WebSocketåº”è¯¥æ”¶åˆ° `proactive_message` ç±»å‹çš„æ¶ˆæ¯ã€‚

### æ£€æŸ¥APIå“åº”

APIåº”è¯¥è¿”å›ï¼š
```json
{
  "success": true,
  "message": "Scene triggered successfully",
  "sceneId": "birthday_reminder"
}
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. åœºæ™¯æœªè§¦å‘

- **æ£€æŸ¥åœºæ™¯æ˜¯å¦å¯ç”¨**ï¼šæŸ¥çœ‹æ—¥å¿—ä¸­çš„ `â¸ï¸ Scene is disabled`
- **æ£€æŸ¥é™éŸ³çª—**ï¼šå½“å‰æ—¶é—´æ˜¯å¦åœ¨é™éŸ³çª—å†…ï¼ˆé»˜è®¤22:00-08:00ï¼‰
- **æ£€æŸ¥å·¥ä½œæ—¥**ï¼šscheduleå’Œrandomç±»å‹åªåœ¨å·¥ä½œæ—¥è§¦å‘
- **æ£€æŸ¥è¯„åˆ†**ï¼šåœºæ™¯è¯„åˆ†æ˜¯å¦ä½äºé˜ˆå€¼0.62

### 2. WebSocketæœªæ”¶åˆ°æ¶ˆæ¯

- **æ£€æŸ¥è¿æ¥**ï¼šç¡®è®¤WebSocketå·²è¿æ¥
- **æ£€æŸ¥API Key**ï¼šç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„VCP API Key
- **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰ `ğŸ“¢ Proactive message pushed to WebSocket` æ—¥å¿—

### 3. äº‹ä»¶æœªè§¦å‘åœºæ™¯

- **æ£€æŸ¥EventBus**ï¼šç¡®è®¤äº‹ä»¶å·²å‘å¸ƒ
- **æ£€æŸ¥åœºæ™¯é…ç½®**ï¼šç¡®è®¤åœºæ™¯çš„ `metadata.eventType` ä¸äº‹ä»¶ç±»å‹åŒ¹é…
- **æ£€æŸ¥åœºæ™¯å¯ç”¨çŠ¶æ€**ï¼šç¡®è®¤åœºæ™¯å·²å¯ç”¨

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] è¿è¡Œé›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨è§¦å‘ç”Ÿæ—¥æé†’åœºæ™¯æˆåŠŸ
- [ ] æ‰‹åŠ¨è§¦å‘çºªå¿µæ—¥æé†’åœºæ™¯æˆåŠŸ
- [ ] WebSocketæ”¶åˆ°ä¸»åŠ¨æ¶ˆæ¯
- [ ] åˆ›å»ºå…³ç³»åç«‹å³è§¦å‘æé†’
- [ ] äº‹ä»¶è§¦å‘åœºæ™¯æ­£å¸¸å·¥ä½œ
- [ ] å¤šç»´åº¦è¯„åˆ†è®¡ç®—æ­£ç¡®
- [ ] å¤šæ ·æ€§æƒ©ç½šæœºåˆ¶ç”Ÿæ•ˆ
- [ ] è¡ŒåŠ¨é˜ˆå€¼åˆ¤æ–­æ­£ç¡®ï¼ˆ0.62ï¼‰

---

## ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ï¼š
1. ç»§ç»­å¼€å‘M2.2 Phase 3ï¼ˆé«˜çº§ç‰¹æ€§ï¼‰
2. ä¼˜åŒ–è¯„åˆ†ç®—æ³•å‚æ•°
3. æ·»åŠ æ›´å¤šåœºæ™¯
4. å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

