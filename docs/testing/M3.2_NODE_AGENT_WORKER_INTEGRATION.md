# M3.2 Worker 节点 Hub 实机联调报告

- **测试日期**：2025-11-11
- **参与模块**：NodeManager（Hub）、Worker Node Agent、TaskOrchestrator、NodeAwareDistributedServerChannel
- **测试目标**：验证 Worker 节点通过 WebSocket 注册、接受任务、回传结果及超时处理的完整闭环。

## 1. 环境准备

1. 设置临时根目录：
   ```bash
   set APEX_BRIDGE_ROOT_DIR=%TEMP%\apex-worker-int
   set APEX_BRIDGE_CONFIG_DIR=%APEX_BRIDGE_ROOT_DIR%\config
   set APEX_BRIDGE_DATA_DIR=%APEX_BRIDGE_ROOT_DIR%\data
   ```
2. 安装依赖后进入节点代理目录：
   ```bash
   cd packages/node-agent
   npm install
   ```

## 2. 执行命令

```bash
npm run test -- hub-worker.integration.test.ts
```

该命令会：
- 拉起真实 `NodeManager` 与 `NodeAwareDistributedServerChannel` WebSocket 服务；
- 启动 Worker Node Agent（工具：`echo`、`wait`），心跳 200ms；
- 监听 `task_assigned` 事件，将 Hub 下发的任务封装为 `task_assign` 消息发送给 Worker；
- 收集 `task_result` 原始载荷用于断言。

## 3. 关键场景

| 场景 | 输入 | 期望 | 结果 |
|------|------|------|------|
| Echo 任务 | `toolArgs = { value: 'hello-worker' }` | Worker 原样返回 `echoed` 字段 | ✅ |
| Wait 任务 | `durationMs = 200` | Worker 正常完成，返回 `sleptMs: 200` | ✅ |
| Wait 超时 | `durationMs = 1500`, `timeout = 200` | Hub 超时，`assignTask` 抛出 Timeout，`task_result.success=false` | ✅ |
| Worker 对话 | `toolName = worker_conversation`，`messages`、`llm.model = 'deepseek-chat'` | Worker 通过 Hub LLM 生成文本回复，返回 `reply`、`usage`、`partialOutputs` | ✅ |

## 4. 结论

- Worker 节点在真实 Hub 中可顺利注册、心跳并执行工具任务；
- 新增的 `worker_conversation` 能力已完成直连对话验证，可作为 Companion 之外的对话回复节点；
- 超时流程触发后，Hub 能收到失败结果并释放任务；
- 对应测试文件 `tests/integration/hub-worker.integration.test.ts` 已纳入常规 `npm run test`。

> 若需手动验证，可按上述命令执行并观察日志（Worker 将打印 Echo/Wait 执行情况；触发 `worker_conversation` 时可在日志中看到 `Worker conversation completed`、`partialOutputs` 统计与最终回复内容）。
