<!-- OPENSPEC:START -->
# OpenSpec Instructions

These instructions are for AI assistants working in this project.

Always open `@/openspec/AGENTS.md` when the request:
- Mentions planning or proposals (words like proposal, spec, change, plan)
- Introduces new capabilities, breaking changes, architecture shifts, or big performance/security work
- Sounds ambiguous and you need the authoritative spec before coding

Use `@/openspec/AGENTS.md` to learn:
- How to create and apply change proposals
- Spec format and conventions
- Project structure and guidelines

Keep this managed block so 'openspec update' can refresh the instructions.

<!-- OPENSPEC:END -->

# ApexBridge - è½»é‡çº§ABPèŠå¤©æœåŠ¡

> **é¡¹ç›®æ„¿æ™¯**: ä¸€ä¸ªä¸“æ³¨äºABPåè®®å’ŒLLMé›†æˆçš„è½»é‡çº§èŠå¤©æœåŠ¡ï¼Œæ”¯æŒå¤šLLMæä¾›å•†ã€Skillsä½“ç³»å’Œå®æ—¶æµå¼å¯¹è¯ã€‚

## ğŸ—ï¸ æ¶æ„æ€»è§ˆ

```mermaid
graph TD
    A["ApexBridge è½»é‡çº§æœåŠ¡"] --> B["æ ¸å¿ƒå¼•æ“"];
    B --> C["Protocolå¼•æ“<br/>ABPåè®®å¤„ç†"];
    B --> D["LLMç®¡ç†å™¨<br/>å¤šæä¾›å•†é€‚é…"];
    B --> E["å˜é‡å¼•æ“<br/>åŠ¨æ€å˜é‡è§£æ"];

    A --> F["æœåŠ¡å±‚"];
    F --> G["èŠå¤©æœåŠ¡<br/>å¯¹è¯ç®¡ç†"];
    F --> H["é…ç½®æœåŠ¡<br/>åŠ¨æ€é…ç½®"];
    F --> J["LLMé…ç½®æœåŠ¡<br/>æä¾›å•†ç®¡ç†"];

    A --> K["APIæ¥å£"];
    K --> L["èŠå¤©æ§åˆ¶å™¨<br/>OpenAIå…¼å®¹"];
    K --> M["LLMæ§åˆ¶å™¨<br/>é…ç½®ç®¡ç†"];
    K --> N["WebSocketç®¡ç†<br/>å®æ—¶é€šä¿¡"];

    A --> O["Skills èƒ½åŠ›ä½“ç³»"];
    O --> P["æŠ€èƒ½å…ƒæ•°æ®<br/>SKILL.md"];
    O --> Q["æŠ€èƒ½æ‰§è¡Œå™¨<br/>Direct/Internal"];
    O --> R["æŠ€èƒ½ç¼“å­˜<br/>æ€§èƒ½ä¼˜åŒ–"];

    click C "./src/core/ProtocolEngine.ts" "æŸ¥çœ‹Protocolå¼•æ“å®ç°"
    click D "./src/core/LLMManager.ts" "æŸ¥çœ‹LLMç®¡ç†å™¨å®ç°"
    click E "./src/core/variable/VariableEngine.ts" "æŸ¥çœ‹å˜é‡å¼•æ“å®ç°"
```

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | è·¯å¾„ | èŒè´£ | çŠ¶æ€ |
|------|------|------|------|
| **æ ¸å¿ƒå¼•æ“** | `src/core/` | ABPåè®®ã€LLMç®¡ç†ã€å˜é‡å¼•æ“ã€Skillsä½“ç³» | âœ… æ´»è·ƒ |
| **APIå±‚** | `src/api/` | èŠå¤©æ¥å£ã€LLMé…ç½®ã€WebSocketé€šä¿¡ | âœ… æ´»è·ƒ |
| **æœåŠ¡å±‚** | `src/services/` | èŠå¤©æœåŠ¡ã€é…ç½®æœåŠ¡ã€LLMé…ç½®æœåŠ¡ | âœ… æ´»è·ƒ |
| **ä¸­é—´ä»¶** | `src/api/middleware/` | è®¤è¯ã€é™æµã€å®‰å…¨ã€éªŒè¯ | âœ… æ´»è·ƒ |

## ğŸš€ è¿è¡Œä¸å¼€å‘

### ğŸ“‹ ç¯å¢ƒè¦æ±‚
- **Node.js** â‰¥ 16.0.0
- **npm** â‰¥ 8.0.0 æˆ– **yarn** â‰¥ 1.22.0
- **Git** ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰

### âš¡ å¿«é€Ÿå¼€å§‹
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/apex-bridge.git
cd apex-bridge

# 2. æ›´æ–°å¾½ç« é…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„GitHubç”¨æˆ·åï¼‰
./scripts/update-badges.sh your-username

# 3. å®‰è£…æ‰€æœ‰æ¨¡å—ä¾èµ–
npm run install:all

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp apex-bridge/env.template .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½®LLMæä¾›å•†APIå¯†é’¥

# 5. å¼€å‘æ¨¡å¼
npm run dev
```

### ğŸ“¦ ä¾èµ–ç®¡ç†
```bash
# å®‰è£…æ‰€æœ‰æ¨¡å—ä¾èµ–
npm run install:all

# æ›´æ–°æ‰€æœ‰æ¨¡å—ä¾èµ–
npm run update:all

# æ£€æŸ¥ä¾èµ–å®‰å…¨
npm run audit:all
```

## ğŸ”§ æ ¸å¿ƒæ¶æ„ç‰¹è‰²

### ğŸ§  ABPåè®®å¼•æ“ï¼ˆABP-onlyï¼‰
- **ç‹¬ç«‹å®ç°**: ä¸å†ä¾èµ–ä»»ä½•å¤–éƒ¨SDKï¼Œå®Œå…¨è‡ªä¸»çš„ABPåè®®å¤„ç†
- **Skillsä½“ç³»**: å–ä»£ä¼ ç»Ÿæ’ä»¶ï¼Œæ”¯æŒä¸¤æ®µæ‰§è¡Œå™¨ï¼ˆDirect/Internalï¼‰
- **å˜é‡è§£æ**: æ”¯æŒæ—¶é—´ã€ç¯å¢ƒã€å ä½ç¬¦ç­‰å¤šç§å˜é‡ç±»å‹
- **å·¥å…·æè¿°**: åŠ¨æ€ç”Ÿæˆå·¥å…·æè¿°ï¼Œç®€åŒ–å·¥å…·è°ƒç”¨æµç¨‹

### ğŸ¯ å¤šLLMæ”¯æŒ
- **é€‚é…å™¨æ¨¡å¼**: ç»Ÿä¸€æ¥å£æ”¯æŒOpenAIã€DeepSeekã€æ™ºè°±ã€Ollamaç­‰
- **SQLiteé…ç½®**: ä»æ•°æ®åº“åŠ è½½é…ç½®ï¼Œæ”¯æŒè¿è¡Œæ—¶çƒ­æ›´æ–°
- **æ™ºèƒ½é‡è¯•**: è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿
- **æµå¼å“åº”**: æ”¯æŒæµå¼èŠå¤©å’Œå®æ—¶ä¸­æ–­

### ğŸ” å®‰å…¨ä¸ç›‘æ§
- **å¤šå±‚è®¤è¯**: API Keyè®¤è¯æœºåˆ¶
- **é€Ÿç‡é™åˆ¶**: æ™ºèƒ½é™æµï¼Œæ”¯æŒIPå’ŒAPI KeyåŒé‡ç­–ç•¥
- **å®‰å…¨ä¸­é—´ä»¶**: è¾“å…¥æ¸…ç†ã€è·¯å¾„éå†é˜²æŠ¤ã€å®‰å…¨æ—¥å¿—è®°å½•
- **å®æ—¶é€šä¿¡**: WebSocketæ”¯æŒåŒå‘é€šä¿¡å’Œè¯·æ±‚ä¸­æ–­

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•å±‚çº§
1. **å•å…ƒæµ‹è¯•** - æ ¸å¿ƒå¼•æ“å’ŒæœåŠ¡å±‚ï¼ˆJestï¼‰
2. **é›†æˆæµ‹è¯•** - APIæ¥å£å’ŒWebSocket
3. **ç«¯åˆ°ç«¯æµ‹è¯•** - å®Œæ•´ç”¨æˆ·åœºæ™¯

### è¿è¡Œæµ‹è¯•
```bash
# åœ¨ä¸»ç›®å½•è¿è¡Œæ‰€æœ‰æµ‹è¯•
cd apex-bridge
npm test

# è¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# ç‰¹å®šæµ‹è¯•
npm test -- PersonalityEngine.test.ts
```

### æµ‹è¯•è¦†ç›–é‡ç‚¹
- ABPåè®®å˜é‡è§£æä¸Skillsæ‰§è¡Œ
- å¤šLLMæä¾›å•†é€‚é…å’Œåˆ‡æ¢
- WebSocketè¿æ¥å’Œæ¶ˆæ¯å¤„ç†
- Skillsä½“ç³»çš„å®‰å…¨æ€§ä¸éš”ç¦»
- è¯·æ±‚ä¸­æ–­å’Œæµå¼å“åº”æœºåˆ¶

## ğŸ“‹ ç¼–ç è§„èŒƒ

### TypeScriptè§„èŒƒ
- ä¸¥æ ¼æ¨¡å¼å¯ç”¨ (`strict: true`)
- æ˜ç¡®çš„ç±»å‹å®šä¹‰å’Œæ¥å£è®¾è®¡
- å‡½æ•°å¼ç¼–ç¨‹ä¼˜å…ˆï¼Œç±»ç”¨äºæ˜ç¡®æŠ½è±¡
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ ‡å‡†åŒ–

### é¡¹ç›®ç»“æ„è§„èŒƒ
```
apex-bridge/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/           # æ ¸å¿ƒå¼•æ“ï¼ˆProtocolã€LLMã€å˜é‡ã€Skillsç­‰ï¼‰
â”‚   â”œâ”€â”€ services/       # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”œâ”€â”€ api/            # APIæ¥å£å’Œæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ types/          # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ config/         # é…ç½®ç®¡ç†
â”œâ”€â”€ skills/             # Skills èƒ½åŠ›ï¼ˆè½»é‡çº§æ’ä»¶ç³»ç»Ÿï¼‰
â”œâ”€â”€ tests/              # æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ config/             # é…ç½®æ–‡ä»¶
â””â”€â”€ docs/               # æ–‡æ¡£
```

### å‘½åçº¦å®š
- **ç±»å**: PascalCase (å¦‚: `ProtocolEngine`, `LLMManager`)
- **å‡½æ•°å’Œå˜é‡**: camelCase (å¦‚: `loadConfig`, `systemPrompt`)
- **å¸¸é‡**: UPPER_SNAKE_CASE (å¦‚: `DEFAULT_TIMEOUT`, `MAX_RETRIES`)
- **æ–‡ä»¶å’Œç›®å½•**: kebab-case (å¦‚: `protocol-engine.ts`, `chat-controller.ts`)

## ğŸ¤– AI ä½¿ç”¨æŒ‡å¼•

### æ ¸å¿ƒå¼•æ“ç†è§£è·¯å¾„
1. **Protocolå¼•æ“** (`src/core/ProtocolEngine.ts`)
   - ç‹¬ç«‹å®ç°ï¼Œä¸å†ä¾èµ–ä»»ä½•å¤–éƒ¨SDK
   - å¤„ç†ABPåè®®è§£æå’Œå·¥å…·è°ƒç”¨ï¼ˆç»Skillsæ˜ å°„æ‰§è¡Œï¼‰
   - å¤„ç†å˜é‡è§£æä¸å·¥å…·æè¿°ç”Ÿæˆ
   - è½»é‡çº§è®¾è®¡ï¼Œä¸“æ³¨äºæ ¸å¿ƒèŠå¤©åŠŸèƒ½

2. **LLMManager** (`src/core/LLMManager.ts`)
   - å¤šæä¾›å•†é€‚é…å™¨æ¨¡å¼
   - æ”¯æŒOpenAIã€DeepSeekã€æ™ºè°±ã€Ollama
   - æµå¼èŠå¤©å’Œé‡è¯•æœºåˆ¶
   - ä¸ProtocolEngineæ·±åº¦é›†æˆ

### Skills å¼€å‘æŒ‡å—
1. **ç›®å½•ç»“æ„**
   - `SKILL.md`ï¼šå‰è¨€åŒºå«ABPé…ç½®ï¼ˆtools/kind/parametersï¼‰ï¼Œæ­£æ–‡æä¾›æ‰§è¡ŒæŒ‡ä»¤ä¸æ³¨æ„äº‹é¡¹
   - `scripts/execute.ts`ï¼šæŠ€èƒ½æ‰§è¡Œå…¥å£ï¼ˆé»˜è®¤å¯¼å‡ºï¼‰
   - `references/`ã€`assets/`ï¼šå‚è€ƒèµ„æ–™ä¸èµ„æº

2. **æŠ€èƒ½æ‰§è¡Œç±»å‹**
   - **Directï¼ˆç›´æ¥æ‰§è¡Œï¼‰**: æœ¬åœ°åŒæ­¥æ‰§è¡Œï¼Œé»˜è®¤ç±»å‹
   - **Internalï¼ˆå†…éƒ¨æ‰§è¡Œï¼‰**: æ ¸å¿ƒç³»ç»Ÿå†…ç½®æŠ€èƒ½
   - ç®€åŒ–çš„æ‰§è¡Œæ¨¡å‹ï¼Œä¸“æ³¨äºè½»é‡çº§åœºæ™¯

### APIæ‰©å±•æ¨¡å¼
```typescript
// 1. åˆ›å»ºæ§åˆ¶å™¨
// src/api/controllers/NewController.ts
export class NewController {
  // å®ç°å¤„ç†é€»è¾‘
}

// 2. æ³¨å†Œè·¯ç”±
// src/server.ts
app.use('/api/new', newController.getRouter());

// 3. æ·»åŠ æµ‹è¯•
// tests/api/NewController.test.ts
```

## ğŸ“Š å˜æ›´è®°å½• (Changelog)

### 2025-11-19 - æ¶æ„ç®€åŒ–ä¸ä»£ç æ¸…ç†
- âœ… **ä¸­é—´ä»¶ç®€åŒ–**: 7ä¸ªä¸­é—´ä»¶æ–‡ä»¶ç®€åŒ–ï¼Œå¹³å‡å‡å°‘53.4%ä»£ç é‡
  - rateLimitMiddleware: 673â†’374è¡Œ (-44.4%)
  - validationMiddleware: 414â†’167è¡Œ (-59.4%)
  - auditLoggerMiddleware: 250â†’67è¡Œ (-73.2%)
  - sanitizationMiddleware: 302â†’134è¡Œ (-55.6%)
  - securityLoggerMiddleware: 233â†’105è¡Œ (-54.9%)
  - customValidators: 171â†’62è¡Œ (-63.7%)
  - validationSchemas: 224â†’172è¡Œ (-23.2%)

- âœ… **Servicesç²¾ç®€**: ç§»é™¤4ä¸ªè¿‡åº¦è®¾è®¡çš„æœåŠ¡ï¼Œç®€åŒ–ConfigService
  - åˆ é™¤: DiaryArchiveService, SecurityAlertService, SecurityStatsService
  - ç®€åŒ–: ConfigService 1005â†’470è¡Œ (-53.2%)
  - åˆ é™¤: RaceDetector, TransactionManager, Mutexç­‰å¹¶å‘å·¥å…·
  - æ€»è®¡å‡å°‘: ~1,300è¡Œä»£ç 

- âœ… **Typesä¼˜åŒ–**: ç§»é™¤æœªä½¿ç”¨çš„ç±»å‹å®šä¹‰
  - åˆ é™¤: personality.ts (51è¡Œ)
  - ç®€åŒ–: index.ts ç§»é™¤äº†LLMQuotaConfigç­‰æœªä½¿ç”¨ç±»å‹
  - ç®€åŒ–: skills.ts SkillExecutionTypeä»6ç§å‡å°‘åˆ°2ç§
  - æ€»è®¡å‡å°‘: ~288è¡Œä»£ç 

- âœ… **åŠŸèƒ½æ¸…ç†**: ç§»é™¤éæ ¸å¿ƒåŠŸèƒ½
  - åˆ é™¤: plugin-callback.ts (å¼‚æ­¥æ’ä»¶å›è°ƒ)
  - åˆ é™¤: AsyncResultProvideråŠç›¸å…³æœåŠ¡
  - åˆ é™¤: DemoAsyncTaskæŠ€èƒ½ç¤ºä¾‹
  - æ€»è®¡å‡å°‘: ~600è¡Œä»£ç 

- âœ… **æ¶æ„ç®€åŒ–æˆæœ**:
  - **æ€»ä»£ç å‡å°‘**: ~2,200+è¡Œï¼ˆä»å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿç®€åŒ–ä¸ºè½»é‡çº§ABPèŠå¤©æœåŠ¡ï¼‰
  - **ç¼–è¯‘çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡
  - **æ¶æ„æ¸…æ™°**: ä¸“æ³¨äºæ ¸å¿ƒèŠå¤©åŠŸèƒ½ï¼Œå»é™¤è¿‡åº¦å·¥ç¨‹åŒ–è®¾è®¡

### 2025-11-16 - é¡¹ç›®åˆå§‹åŒ–æ‰«æ
- âœ… å®Œæˆé¡¹ç›®ç»“æ„åˆ†æå’Œæ¨¡å—è¯†åˆ«
- âœ… åˆ†ææ ¸å¿ƒæ¶æ„ï¼šABPåè®®å¼•æ“ã€Skillsä½“ç³»ã€å¤šLLMæ”¯æŒ
- âœ… è¯†åˆ«å…³é”®ç»„ä»¶ï¼šäººæ ¼å¼•æ“ã€æƒ…æ„Ÿå¼•æ“ã€è®°å¿†ç³»ç»Ÿã€åˆ†å¸ƒå¼èŠ‚ç‚¹
- âœ… å»ºç«‹æ¨¡å—æ–‡æ¡£ä½“ç³»æ¡†æ¶
- âœ… ç”Ÿæˆæ¶æ„å›¾å’Œæ¨¡å—ç´¢å¼•

### æ‰«æè¦†ç›–ç‡ï¼ˆç®€åŒ–åï¼‰
- **æ€»æ–‡ä»¶æ•°**: ~150ä¸ªæ–‡ä»¶ï¼ˆä»350+ç²¾ç®€ï¼‰
- **æ ¸å¿ƒä»£ç **: ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—èŒè´£æ˜ç¡®
- **æ¶æ„çŠ¶æ€**: è½»é‡çº§ã€ä¸“æ³¨ã€æ˜“ç»´æŠ¤

## ğŸ¯ å½“å‰æ¶æ„ç‰¹ç‚¹

### âœ… ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
1. **ProtocolEngine** - ABPåè®®å¤„ç†æ ¸å¿ƒ
2. **LLMManager** - å¤šLLMæä¾›å•†æ”¯æŒ
3. **VariableEngine** - å˜é‡è§£æç³»ç»Ÿ
4. **ChatService** - èŠå¤©æœåŠ¡æ ¸å¿ƒ
5. **Skillsä½“ç³»** - ç®€åŒ–çš„æŠ€èƒ½æ‰§è¡Œï¼ˆDirect/Internalï¼‰
6. **WebSocket** - å®æ—¶é€šä¿¡
7. **LLMConfigService** - LLMé…ç½®ç®¡ç†

### âŒ å·²ç§»é™¤çš„å¤æ‚åŠŸèƒ½
- äººæ ¼å¼•æ“ã€æƒ…æ„Ÿå¼•æ“ã€è®°å¿†ç³»ç»Ÿ
- åˆ†å¸ƒå¼èŠ‚ç‚¹ã€ç®¡ç†åå°
- å¼‚æ­¥æ’ä»¶å›è°ƒã€å¤æ‚é™æµç­–ç•¥
- è¿‡åº¦è®¾è®¡çš„å¹¶å‘æ§åˆ¶å’Œå®‰å…¨ç›‘æ§

### ğŸ¯ è®¾è®¡ç†å¿µ
- **KISSåŸåˆ™**: ä¿æŒç®€å•ï¼Œä¸“æ³¨äºæ ¸å¿ƒèŠå¤©åŠŸèƒ½
- **YAGNIåŸåˆ™**: ç§»é™¤å½“å‰ä¸éœ€è¦çš„å¤æ‚åŠŸèƒ½
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤
- **ç±»å‹å®‰å…¨**: ä¸¥æ ¼çš„TypeScriptç±»å‹å®šä¹‰
- **ç¼–è¯‘é€šè¿‡**: æ‰€æœ‰ç®€åŒ–éƒ½ä¿è¯ç¼–è¯‘æˆåŠŸ